<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>PELVis: The PEL Visualizer</title>
<!-- 2014-04-21 Mon 16:15 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Adam Washington" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">PELVis: The PEL Visualizer</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Introduction</a></li>
<li><a href="#sec-2">2. PELVis application</a>
<ul>
<li><a href="#sec-2-1">2.1. Application skeleton</a></li>
<li><a href="#sec-2-2">2.2. Imports</a></li>
</ul>
</li>
<li><a href="#sec-3">3. GUI Controls</a>
<ul>
<li><a href="#sec-3-1">3.1. Pelvis Frame</a>
<ul>
<li><a href="#sec-3-1-1">3.1.1. Initialization</a></li>
<li><a href="#sec-3-1-2">3.1.2. Handling Pel Files</a></li>
<li><a href="#sec-3-1-3">3.1.3. Menu Commands</a></li>
<li><a href="#sec-3-1-4">3.1.4. Updaters</a></li>
</ul>
</li>
<li><a href="#sec-3-2">3.2. Position Panel</a>
<ul>
<li><a href="#sec-3-2-1">3.2.1. Position Panel Class Skeleton</a></li>
<li><a href="#sec-3-2-2">3.2.2. Initialization of the PositionPanel</a></li>
<li><a href="#sec-3-2-3">3.2.3. Update position data</a></li>
</ul>
</li>
<li><a href="#sec-3-3">3.3. Option Panel</a>
<ul>
<li><a href="#sec-3-3-1">3.3.1. Initialization</a></li>
<li><a href="#sec-3-3-2">3.3.2. Wavelength Range</a></li>
<li><a href="#sec-3-3-3">3.3.3. Intensity Range</a></li>
<li><a href="#sec-3-3-4">3.3.4. Region of Interest</a></li>
</ul>
</li>
<li><a href="#sec-3-4">3.4. Graph Panel</a>
<ul>
<li><a href="#sec-3-4-1">3.4.1. Graph Panel Skeleton</a></li>
<li><a href="#sec-3-4-2">3.4.2. rebin function</a></li>
<li><a href="#sec-3-4-3">3.4.3. Initialization</a></li>
<li><a href="#sec-3-4-4">3.4.4. Plotting</a></li>
</ul>
</li>
<li><a href="#sec-3-5">3.5. Image Panel</a>
<ul>
<li><a href="#sec-3-5-1">3.5.1. Image Panel Skeleton</a></li>
<li><a href="#sec-3-5-2">3.5.2. Initialization</a></li>
<li><a href="#sec-3-5-3">3.5.3. Event Handling</a></li>
<li><a href="#sec-3-5-4">3.5.4. Data Handling</a></li>
</ul>
</li>
<li><a href="#sec-3-6">3.6. Color Bar Panel</a>
<ul>
<li><a href="#sec-3-6-1">3.6.1. Color Bar Skeleton</a></li>
<li><a href="#sec-3-6-2">3.6.2. Initialization</a></li>
<li><a href="#sec-3-6-3">3.6.3. Display</a></li>
<li><a href="#sec-3-6-4">3.6.4. Configuration</a></li>
</ul>
</li>
<li><a href="#sec-3-7">3.7. Action Color Bar</a></li>
<li><a href="#sec-3-8">3.8. Color Map Picker</a></li>
<li><a href="#sec-3-9">3.9. Graph Frame</a>
<ul>
<li><a href="#sec-3-9-1">3.9.1. GraphFrame Skeleton</a></li>
<li><a href="#sec-3-9-2">3.9.2. Initialization</a></li>
<li><a href="#sec-3-9-3">3.9.3. Image Export</a></li>
</ul>
</li>
<li><a href="#sec-3-10">3.10. Spectrum Dialog</a>
<ul>
<li><a href="#sec-3-10-1">3.10.1. Spectrum Dialog Skeleton</a></li>
<li><a href="#sec-3-10-2">3.10.2. Initialization</a></li>
<li><a href="#sec-3-10-3">3.10.3. Configuration</a></li>
<li><a href="#sec-3-10-4">3.10.4. Buttons</a></li>
<li><a href="#sec-3-10-5">3.10.5. Spectrum Modes</a></li>
<li><a href="#sec-3-10-6">3.10.6. Binning</a></li>
</ul>
</li>
<li><a href="#sec-3-11">3.11. Livewatch</a>
<ul>
<li><a href="#sec-3-11-1">3.11.1. Livewatch skeleton</a></li>
<li><a href="#sec-3-11-2">3.11.2. Low Level Functions</a></li>
<li><a href="#sec-3-11-3">3.11.3. Generators</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-4">4. Utility Classes</a>
<ul>
<li><a href="#sec-4-1">4.1. Reader</a>
<ul>
<li><a href="#sec-4-1-1">4.1.1. Reader Skeleton</a></li>
<li><a href="#sec-4-1-2">4.1.2. Image Mapping</a></li>
<li><a href="#sec-4-1-3">4.1.3. Initialization</a></li>
<li><a href="#sec-4-1-4">4.1.4. File Reading</a></li>
</ul>
</li>
<li><a href="#sec-4-2">4.2. MonFile</a>
<ul>
<li><a href="#sec-4-2-1">4.2.1. MonFile Skeleton</a></li>
<li><a href="#sec-4-2-2">4.2.2. Initialization</a></li>
<li><a href="#sec-4-2-3">4.2.3. File Loading</a></li>
</ul>
</li>
<li><a href="#sec-4-3">4.3. Combiner</a>
<ul>
<li><a href="#sec-4-3-1">4.3.1. Combiner Skeleton</a></li>
<li><a href="#sec-4-3-2">4.3.2. Load</a></li>
<li><a href="#sec-4-3-3">4.3.3. Save</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-5">5. Reduction</a>
<ul>
<li><a href="#sec-5-1">5.1. Reduction Skeleton</a></li>
<li><a href="#sec-5-2">5.2. Main Command</a></li>
<li><a href="#sec-5-3">5.3. Export</a></li>
<li><a href="#sec-5-4">5.4. Import</a></li>
<li><a href="#sec-5-5">5.5. Plotting</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Power Supplies</a>
<ul>
<li><a href="#sec-6-1">6.1. Power Supply Server</a>
<ul>
<li><a href="#sec-6-1-1">6.1.1. Power Supply Class Module</a></li>
<li><a href="#sec-6-1-2">6.1.2. Power Supply Server</a></li>
</ul>
</li>
<li><a href="#sec-6-2">6.2. Power Supply Client</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
This docment is a <a href="http://www.literateprogramming.com/index.html">literate</a> program for analyzing data collected on
the SESAME beamline. The document itself was written in
<a href="http://orgmode.org/">Org Mode</a> while the majority of the source is intended to be run
through python.
</p>

<p>
If your primary goal is to simply use PELVis, then the
<a href="readme.html">user documentation</a> would be the best place to start.
</p>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> PELVis application</h2>
<div class="outline-text-2" id="text-2">
<p>
The main user application is the pelvis.py script that the user runs
to view neutron data.
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Application skeleton</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Below is the rough layout of the PELVis application.  More details can be found in the individual sections
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #e67128;">"""A GUI for handling polarization data generated by a PAPA detector.</span>

<span style="color: #e67128;">This program was written to help with analyzing polarization data produced</span>
<span style="color: #e67128;">by the PAPA detector.  The general workflow is:</span>
<span style="color: #e67128;">1)Load Neutron Data</span>
<span style="color: #e67128;">2)Subtract Background</span>
<span style="color: #e67128;">3)Select Region of Interest</span>
<span style="color: #e67128;">4)Plot Spectrum data</span>

<span style="color: #e67128;">The primary class is PelvisFrame, which controls the whole program.</span>
<span style="color: #e67128;">PelvisFrame contains a PositionPanel, to examine single pixels, and</span>
<span style="color: #e67128;">a PelvisOptionPanel, which accepts user parameters.</span>

<span style="color: #e67128;">"""</span>

&lt;&lt;pelvis_imports&gt;&gt;

<span style="color: #dbdb95;">RESOLUTION</span> = 400

&lt;&lt;position_panel&gt;&gt;
&lt;&lt;pelvis_option_panel&gt;&gt;
&lt;&lt;pelvis_frame&gt;&gt;
<span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">__name__</span>==<span style="color: #e67128;">"__main__"</span>:
    app=wx.PySimpleApp()
    pelvisframe = PelvisFrame(app.Yield)
    app.MainLoop()
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Imports</h3>
<div class="outline-text-3" id="text-2-2">
<p>
The PELVis application uses a large number of packages to handle
the work. 
</p>


<p>
This code was originally written for Python 2.5.  This version of
Python did not have the <code>with</code> statement and needed it imported
from the future.  If PELVis is run on version 2.6 or later, this
should not be an issue.  As such, it should be possible to remove
this import, but it has not been tested.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">import</span> __future__
</pre>
</div>

<p>
The <a href="#sec-4-1">PelFile</a> class handles all of the data loading from the neutron
event files.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">from</span> reader <span style="color: #ffad29; font-weight: bold;">import</span> PelFile
</pre>
</div>

<p>
<a href="#sec-3-5">ImagePanel</a> is a custom widget for displaying 2D graph data in a
wxPython frame.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">from</span> ImagePanel <span style="color: #ffad29; font-weight: bold;">import</span> ImagePanel
</pre>
</div>

<p>
<i>GraphPanel</i> is a custom widget for displayed 1D graphs in a wxPython
Frame.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">from</span> GraphPanel <span style="color: #ffad29; font-weight: bold;">import</span> GraphPanel
</pre>
</div>

<p>
The <i>ColorBarPanel</i> is a custom widget for displaying a legended
color bar for 2D color maps.  The <i>ColorMapPicker</i> is a custom dialog
for chosing a color bar.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">from</span> colorbarpanel <span style="color: #ffad29; font-weight: bold;">import</span> ColorBarPanel, ColorMapPicker
</pre>
</div>

<p>
The <a href="#sec-4-2">4.2</a> class handles reading the SNS monitor count files.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">from</span> monfile <span style="color: #ffad29; font-weight: bold;">import</span> MonFile
</pre>
</div>

<p>
<i>SpectrumDialog</i> is a custom dialog which handles viewing and
exporting 1D spectral data from the Pelvis application.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">from</span> SpectrumDialog <span style="color: #ffad29; font-weight: bold;">import</span> SpectrumDialog
</pre>
</div>

<p>
The Python built-in TemporaryFile class is used to cache Flat
Files, since they can use a large amount of memory.  If the Flat
File functionality is removed, this import can be dropped.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">from</span> tempfile <span style="color: #ffad29; font-weight: bold;">import</span> TemporaryFile
</pre>
</div>

<p>
<code>math</code> is not used, as it has been essentially superseded by
numpy.  This import should be dropped.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">import</span> math
</pre>
</div>

<p>
<code>time</code> is used for sleeping in a couple of functions.  This is
almost never truly necessary and probably should be dropped.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">import</span> time
</pre>
</div>

<p>
<a href="http://docs.numpy.org"><code>numpy</code></a> is a Python library for handling multidimensional arrays.
It is many orders of magnitude faster and smaller than using Python
Lists, plus easier to read, once you're used to it.  By local
convention, <code>numpy</code> is always imported as <code>np</code>, just because it's
called so often.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">import</span> numpy <span style="color: #ffad29; font-weight: bold;">as</span> np
</pre>
</div>

<p>
<a href="http://matplotlib.org"><code>matplotlib</code></a> is a plotting library for python.  It handles all of
the plots within the application.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">from</span> matplotlib <span style="color: #ffad29; font-weight: bold;">import</span> pyplot <span style="color: #ffad29; font-weight: bold;">as</span> plt
</pre>
</div>

<p>
The <code>cm</code> submodule of matplotlib handles color maps and is needed for
controlling the display of the 2D detector data.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">import</span> matplotlib.cm <span style="color: #ffad29; font-weight: bold;">as</span> cm
</pre>
</div>

<p>
<a href="http://www.wxpython.org">wx</a> is the GUI toolkit used to make the user interface for PelVis
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">import</span> wx
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> GUI Controls</h2>
<div class="outline-text-2" id="text-3">
<p>
We're using <a href="https://www.wxwidgets.org/">wxWidgets</a> as our GUI toolkit through the <a href="http://www.wxpython.org">wxPython</a>
binding library.  wxWidgets was chosen as it is cross platform and
provided a more complete toolkit than the default Tk toolkit that
comes with Python.  The largest disadvantage to this decision is
that wxPython has not yet been officially ported to Python 3.
</p>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Pelvis Frame</h3>
<div class="outline-text-3" id="text-3-1">
<p>
The Pelvis Frame is the main UI for the application.
Unfortunately, it also contains a large amount of application
logic, which should be extracted out into its own class.  That
would certainly make working on the Reduction programs easier.
If you're looking for a good improvement to make to the code.
This would be it.
</p>

<p>
The class starts off with a large number of constant definitions.
These constants are identifiers for menu commands, which are
needed for the wxWidget menu system.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">PelvisFrame</span>(wx.Frame):
    <span style="color: #e67128;">"""The main application window for PELvis"""</span>

    <span style="color: #74af68;">#</span><span style="color: #74af68;">Menu ID constants</span>
    <span style="color: #dbdb95;">ID_OPEN</span> = 100
    <span style="color: #dbdb95;">ID_OPENTWO</span> = 110
    <span style="color: #dbdb95;">ID_SAVE</span> = 130
    <span style="color: #dbdb95;">ID_SPECTRUM</span>=140
    <span style="color: #dbdb95;">ID_IMAGE_ARRAY</span>=160
    <span style="color: #dbdb95;">ID_EXIT</span> = 190

    <span style="color: #dbdb95;">ID_GREY</span> = 200
    <span style="color: #dbdb95;">ID_HUEVAL</span> = 220
    <span style="color: #dbdb95;">ID_SPECTRAL</span> = 230
    <span style="color: #dbdb95;">ID_PICKER</span> = 290
    <span style="color: #dbdb95;">ID_POLAR</span> = 300
    <span style="color: #dbdb95;">ID_FLIPPING</span> = 310
    <span style="color: #dbdb95;">ID_SPIN_UP</span> = 320
    <span style="color: #dbdb95;">ID_SPIN_DOWN</span> = 330

    <span style="color: #dbdb95;">ID_FLAT</span> = 420
    <span style="color: #dbdb95;">ID_FAKEFLAT</span> = 430
    <span style="color: #dbdb95;">ID_ROD</span> = 440
    <span style="color: #dbdb95;">ID_EXPORT_ROI</span> = 450
    <span style="color: #dbdb95;">ID_IMPORT_ROI</span> = 460

    <span style="color: #dbdb95;">ID_COPY</span> = 500

    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,Yield):
        &lt;&lt;pelvis_frame_init&gt;&gt;

    &lt;&lt;pelvis_handle_pels&gt;&gt;

    &lt;&lt;pelvis_on_image_array&gt;&gt;

    &lt;&lt;pelvis_load_norm_pel&gt;&gt;

<span style="color: #74af68;">#    </span><span style="color: #74af68;">def getLambdaRange(self):</span>
<span style="color: #74af68;">#        </span><span style="color: #74af68;">try:</span>
<span style="color: #74af68;">#            </span><span style="color: #74af68;">lmin = int(float(self.lambdaMin.GetValue())*10)</span>
<span style="color: #74af68;">#        </span><span style="color: #74af68;">except ValueError:</span>
<span style="color: #74af68;">#            </span><span style="color: #74af68;">lmin = 0</span>
<span style="color: #74af68;">#        </span><span style="color: #74af68;">try:</span>
<span style="color: #74af68;">#            </span><span style="color: #74af68;">lmax = int(float(self.lambdaMax.GetValue())*10)</span>
<span style="color: #74af68;">#        </span><span style="color: #74af68;">except ValueError:</span>
<span style="color: #74af68;">#            </span><span style="color: #74af68;">lmax = 200 </span>
<span style="color: #74af68;">#        </span><span style="color: #74af68;">return (lmin,lmax)</span>

    &lt;&lt;pelvis_updaters&gt;&gt;

    &lt;&lt;pelvis_on_update_button&gt;&gt;

    &lt;&lt;pelvis_on_open&gt;&gt;

    &lt;&lt;pelvis_on_open_set&gt;&gt;

    &lt;&lt;pelvis_flat_files&gt;&gt;

    &lt;&lt;pelvis_menu_commands&gt;&gt;  
    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">setColorMap</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,cmap):
        <span style="color: #e67128;">"""Changes to the given colormap"""</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.imPanel.cmap = cmap
        <span style="color: #ffad29; font-weight: bold;">self</span>.colorbar.setCmap(cmap)
        <span style="color: #ffad29; font-weight: bold;">self</span>.update()


    &lt;&lt;pelvis_on_exit&gt;&gt;
    &lt;&lt;pelvis_load_up_and_down&gt;&gt;

    &lt;&lt;pelvis_menu_commands_2&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-3-1-1" class="outline-4">
<h4 id="sec-3-1-1"><span class="section-number-4">3.1.1</span> Initialization</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
The frame is created with a single parameter: <code>Yield</code>.  This points
to a function which allows Pelvis to temporarily return control
back to the GUI.  This is necessary to amintain responsiveness
of the user interface while performing long calculations
(e.g. loading a file).
</p>

<p>
We start by creating a wxFrame.  We also set the initial data to
an empty file, store the <code>Yield</code> command, and create a default
data mask that accepts all pixels.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #e67128;">"""Create a PELvis frame</span>

<span style="color: #e67128;">Keyword arguments:</span>
<span style="color: #e67128;">Yield -- A function to give control back to the main event loop</span>

<span style="color: #e67128;">"""</span>
wx.Frame.__init__(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #008b8b;">None</span>,wx.ID_ANY,<span style="color: #e67128;">"PEL Visualizer"</span>)
<span style="color: #ffad29; font-weight: bold;">self</span>.data = PelFile()
<span style="color: #ffad29; font-weight: bold;">self</span>.Yield = Yield
<span style="color: #ffad29; font-weight: bold;">self</span>.mask = np.ones((128,16),dtype=np.<span style="color: #23d7d7;">bool</span>)
</pre>
</div>


<p>
Now we can create the actual components of the GUI.  The <code>xPanel</code>
and <code>yPanel</code> are <a href="#sec-3-4">graphs</a> which display the integrated intensity
along an axis.  <code>imPanel</code> displays the actual, 2D detector <i>image</i>.
<code>colorbar</code> gives the current scale of the color scheme on the
imPanel.  <code>opPanel</code> is a generic <a href="#sec-3-3">panel</a> for the user to input data
about the current region of interest.  <code>posPanel</code> displays
position information to the user.  <code>cmp</code> stores the current color
map for use on the <code>imPanel</code>. <code>specDlg</code> is a <i>dialog box</i>
which handles displaying and saving wavelength spectrums.
Finally, <code>imageSaveDialog</code> is a custom file saving dialog for
handling saving the current detector image to a file.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span><span style="color: #74af68;">Create items in the frame</span>
<span style="color: #ffad29; font-weight: bold;">self</span>.yPanel = GraphPanel(<span style="color: #ffad29; font-weight: bold;">self</span>,(2,8),64,GraphPanel.VERTICAL)
<span style="color: #ffad29; font-weight: bold;">self</span>.xPanel = GraphPanel(<span style="color: #ffad29; font-weight: bold;">self</span>,(8,2),64,GraphPanel.INVERTED)
<span style="color: #ffad29; font-weight: bold;">self</span>.colorbar = ColorBarPanel(<span style="color: #ffad29; font-weight: bold;">self</span>,cm.jet)
<span style="color: #ffad29; font-weight: bold;">self</span>.opPanel = PelvisOptionPanel(<span style="color: #ffad29; font-weight: bold;">self</span>)
<span style="color: #ffad29; font-weight: bold;">self</span>.posPanel = PositionPanel(<span style="color: #ffad29; font-weight: bold;">self</span>)
<span style="color: #ffad29; font-weight: bold;">self</span>.imPanel = ImagePanel(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #ffad29; font-weight: bold;">self</span>.posPanel.<span style="color: #23d7d7;">set</span>,
                          <span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.setPosMin,<span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.setPosMax)
<span style="color: #ffad29; font-weight: bold;">self</span>.specDlg = SpectrumDialog(<span style="color: #ffad29; font-weight: bold;">self</span>)

<span style="color: #ffad29; font-weight: bold;">self</span>.<span style="color: #23d7d7;">cmp</span> = <span style="color: #008b8b;">None</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">color map</span>
<span style="color: #ffad29; font-weight: bold;">self</span>.imageSaveDialog=wx.FileDialog(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #e67128;">"Choose graphics file"</span>,wildcard=<span style="color: #e67128;">"Portable Network Graphic (png)|*.PNG|Windows Bitmap (bmp)|*.BMP|Joint Photographic Experts Group (jpg)|*.JPG|Portable Network Monocrome (pnm)|*.PNM|Tagged Image File Format (tif)|*.TIF|Archaic, useless format (pcx)|*.PCX"</span>,style=wx.FD_SAVE|wx.FD_OVERWRITE_PROMPT)
</pre>
</div>

<p>
The Pelvis Frame class has two dynamic member functions.  The
first is <code>update</code>, which is responsible for setting the image in
the image panel.  The function assumes that the 3D array of data
that has been displayed hasn't changed, but that some of the
parameters for the display (e.g. wavelength range, intensity
caps) may have changed.  The other member function, <code>updateData</code>,
is used whenever the underlying 3D array may have changed.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">self</span>.update = <span style="color: #ffad29; font-weight: bold;">self</span>.updateSingle<span style="color: #74af68;">#</span><span style="color: #74af68;">update the image</span>
<span style="color: #ffad29; font-weight: bold;">self</span>.updateData = <span style="color: #ffad29; font-weight: bold;">self</span>.updateSingleData<span style="color: #74af68;">#</span><span style="color: #74af68;">update the data in the image</span>
</pre>
</div>

<p>
Below is the creation and layout of the menu for the PELVis
application.  To add an entry to a menu, we need to append both a
message code (e.g. <code>ID_EXIT</code>) and a title.  If the title contains
a tab character, a hotkey can follow that tab character to allow
for a more keyboard oriented interaction with the program.
Additionally, if there is an ampersand in front of a character,
then that character will serve as the hotkey for that command
when accessing the menu through the keyboard.  The <code>Append</code>
function will also accept tooltext for the menu, but the current
version of wxpython seems to be ignoring it.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span><span style="color: #74af68;">Create the menu</span>
<span style="color: #dbdb95;">menubar</span> = wx.MenuBar()
<span style="color: #dbdb95;">filemenu</span> = wx.Menu()
<span style="color: #dbdb95;">editmenu</span> = wx.Menu()
<span style="color: #dbdb95;">scalemenu</span> = wx.Menu()
<span style="color: #dbdb95;">analysismenu</span> = wx.Menu()
<span style="color: #dbdb95;">noisemenu</span> = wx.Menu()

<span style="color: #74af68;">#</span><span style="color: #74af68;">populate the menu</span>
filemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_OPEN,<span style="color: #e67128;">"&amp;Open\tCtrl-O"</span>,<span style="color: #e67128;">" Open a PEL file"</span>)
filemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_OPENTWO,<span style="color: #e67128;">"&amp;Polarized Set"</span>,<span style="color: #e67128;">" Open two PEL files"</span>)
filemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_SAVE,<span style="color: #e67128;">"&amp;Save\tCtrl-S"</span>,<span style="color: #e67128;">" Save an image file"</span>)
filemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_SPECTRUM,<span style="color: #e67128;">"Spectrum"</span>,<span style="color: #e67128;">" View the TOF spectrum"</span>)
filemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_IMAGE_ARRAY,<span style="color: #e67128;">"&amp;Export Images..."</span>,<span style="color: #e67128;">" Save a series of TOF snapshots"</span>)
filemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_EXIT,<span style="color: #e67128;">"&amp;Quit\tCtrl-Q"</span>,<span style="color: #e67128;">" Quit"</span>)

editmenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_COPY,<span style="color: #e67128;">"&amp;Copy\tCtrl-c"</span>,<span style="color: #e67128;">"Copy the current image to the clipboard"</span>)

scalemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_GREY,<span style="color: #e67128;">"Greyscale\tCtrl-G"</span>,<span style="color: #e67128;">"Monochrome images"</span>)
scalemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_HUEVAL,<span style="color: #e67128;">"Hue and Value\tCtrl-H"</span>,<span style="color: #e67128;">"Scaled Rainbow Images"</span>)
scalemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_SPECTRAL,<span style="color: #e67128;">"spectral"</span>,<span style="color: #e67128;">"Uses spectrum of light"</span>)
scalemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_PICKER,<span style="color: #e67128;">"Map Picker..."</span>,<span style="color: #e67128;">" Select from the full list of colormaps"</span>)

analysismenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_POLAR,<span style="color: #e67128;">"Check Polarization\tCtrl-P"</span>,<span style="color: #e67128;">"2d plot of polarization data"</span>)
analysismenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_FLIPPING,<span style="color: #e67128;">"Check Flipping Ratio\tCtrl-F"</span>,<span style="color: #e67128;">"2d plot of  spin up over spin down"</span>)
analysismenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_SPIN_UP,<span style="color: #e67128;">"View Spin Up State\tCtrl-U"</span>,<span style="color: #e67128;">"2d plot of  spin up"</span>)
analysismenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_SPIN_DOWN,<span style="color: #e67128;">"View Spin Down State\tCtrl-D"</span>,<span style="color: #e67128;">"2d plot of  spin down"</span>)

noisemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_FLAT,<span style="color: #e67128;">"&amp;Load Flat"</span>,<span style="color: #e67128;">" Load a blank run for background subtraction"</span>)
noisemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_FAKEFLAT,<span style="color: #e67128;">"Si&amp;mulate Flat"</span>,<span style="color: #e67128;">" Drop out background within the same image"</span>)
noisemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_ROD,<span style="color: #e67128;">"Region of &amp;Disinterest"</span>,<span style="color: #e67128;">" Drop out background within the same image"</span>)
noisemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_EXPORT_ROI,<span style="color: #e67128;">"Export ROI"</span>,<span style="color: #e67128;">" Export a binary file corresponding to where the data is above the minimum intensity."</span>)
noisemenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_IMPORT_ROI,<span style="color: #e67128;">"Import ROI"</span>,<span style="color: #e67128;">" Add another exclusion mask."</span>)
</pre>
</div>

<p>
Each menu item needs to be bound to a function.  This is
performed by connecting the menu signal (e.g. <code>ID_EXIT</code>) to the
corresponding function (e.g. <code>OnExit</code>).  There's probably a
better way of doing this through some config file, but that will
be left as an exercise to the reader.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span><span style="color: #74af68;">Bind events to the menu</span>
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_EXIT,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnExit)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_OPEN,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnOpen)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_OPENTWO,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnOpenSet)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_SAVE,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnSave)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_SPECTRUM,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnSpectrum)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_IMAGE_ARRAY,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnImageArray)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_GREY,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnGrey)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_HUEVAL,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnHueVal)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_SPECTRAL,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnSpectral)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_PICKER,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnPicker)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_POLAR,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnPolar)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_FLIPPING,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnFlipping)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_SPIN_UP,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnAnalysisSpinUp)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_SPIN_DOWN,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnAnalysisSpinDown)

<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_FLAT,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnFlat)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_FAKEFLAT,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnFakeFlat)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_ROD,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnROD)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_EXPORT_ROI,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnExportROI)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_IMPORT_ROI,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnImportROI)
<span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_COPY,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnCopy)
</pre>
</div>

<p>
We can now add the menus into the menubar and assign that menubar
to the application.  Adding an ampersand into the title of a
menu assigns an Alt hotkey to that menu (e.g. pressing Alt+F
will open the <code>&amp;File</code> menu).
</p>

<div class="org-src-container">

<pre class="src src-python">menubar.Append(filemenu,<span style="color: #e67128;">"&amp;File"</span>)
menubar.Append(editmenu,<span style="color: #e67128;">"&amp;Edit"</span>)
menubar.Append(scalemenu,<span style="color: #e67128;">"&amp;Color"</span>)
menubar.Append(analysismenu,<span style="color: #e67128;">"&amp;Analysis"</span>)
menubar.Append(noisemenu,<span style="color: #e67128;">"&amp;Noise"</span>)
<span style="color: #ffad29; font-weight: bold;">self</span>.SetMenuBar(menubar)
</pre>
</div>

<p>
We can now add all of the GUI components to the window.  A
progress bar is added to the bottom of the window to give
feedback on the loading of files.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span><span style="color: #74af68;">arrange window</span>
<span style="color: #dbdb95;">sizer</span> = wx.GridBagSizer()
sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.colorbar,pos=wx.GBPosition(0,9),span=wx.GBSpan(9,1))
sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.imPanel,pos=wx.GBPosition(0,1),span=wx.GBSpan(8,8))
sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.yPanel,pos=wx.GBPosition(0,0),span=wx.GBSpan(8,1))
sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.xPanel,pos=wx.GBPosition(8,1),span=wx.GBSpan(1,8))
sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.opPanel,pos=wx.GBPosition(0,10),span=wx.GBSpan(8,1),flag=wx.EXPAND)
sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.posPanel,pos=wx.GBPosition(8,0),flag=wx.EXPAND)
<span style="color: #ffad29; font-weight: bold;">self</span>.progress = wx.Gauge(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #23d7d7;">range</span>=1000)
sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.progress,pos=wx.GBPosition(9,0),span=wx.GBSpan(1,11),flag=wx.EXPAND)
</pre>
</div>

<p>
A button to force the image display to update is added and bound
to the <a href="#pelvis_on_update_button_link">OnUpdateButton</a> function.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #dbdb95;">updateButton</span> = wx.Button(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">"Update"</span>)
updateButton.Bind(wx.EVT_BUTTON,<span style="color: #ffad29; font-weight: bold;">self</span>.OnUpdateButton)
sizer.Add(updateButton,flag=wx.EXPAND,pos=wx.GBPosition(8,10))
</pre>
</div>

<p>
All that remains is some final cleanup.  The data is set to an
empty file, the background is set to empty, as the window
undergoes stanard intialization.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">self</span>.data = <span style="color: #ffad29; font-weight: bold;">self</span>.makePel()
<span style="color: #ffad29; font-weight: bold;">self</span>.flatrun = <span style="color: #008b8b;">None</span><span style="color: #74af68;">#</span><span style="color: #74af68;">background data</span>

sizer.SetSizeHints(<span style="color: #ffad29; font-weight: bold;">self</span>)
<span style="color: #ffad29; font-weight: bold;">self</span>.SetSizer(sizer)
<span style="color: #ffad29; font-weight: bold;">self</span>.Show(<span style="color: #008b8b;">True</span>)
</pre>
</div>
</div>
</div>



<div id="outline-container-sec-3-1-2" class="outline-4">
<h4 id="sec-3-1-2"><span class="section-number-4">3.1.2</span> Handling Pel Files</h4>
<div class="outline-text-4" id="text-3-1-2">
<p>
There's a large amount of references to Pel files in this
section, which might be confusing, since you will almost never
encounter an actual Pel file.  The PELVis program was originally
written to view neutron data comes of off the PAPA detector.  The
data off of the PAPA was saved in a binary format called the PAPA
Electronic Log, or PEL for short.  
</p>

<p>
The software which came with the detector was written in
Labview 5.  <a href="http://ni.com/labview">Labview</a> files are stored in a proprietary format
which can only be read by Labview itself.  Modern versions of
Labview are not backwards compatible enough to read Labview 5
code.  Versions of Labview old enough to read the code are
generally unavailable and difficult to install on modern
operating systems.  Thus, while the vendor's supplied code could
open the files, we could not extended it to perform the sorts of
calulcations that we would like.  Thus, it was necessary to write
a new program from scratch to read these files.  This is that
application.
</p>

<p>
Once we obtained the Helium-3 detector, we replaced the PAPA
detector, as the PAPA had terrible noise issues.  However, PELVis
had grown to the point where the reading of the data file was
only a small part of the functionality.  By changing the <i>reader</i>
code to handle the SNS file format (which was quite similar to
the Pel format), we were able to continue using the same suite.
</p>

<p>
The <code>makePel</code> function creates a blank neutron run.  It's just a
default for when the user hasn't loaded any data yet.
</p>

<div class="org-src-container">

<pre class="src src-python" id="pelvis_handle_pels"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">makePel</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #e67128;">"""Create a blank Pel object for loading detector data"""</span>
    <span style="color: #dbdb95;">data</span> = PelFile()
    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">statusfunc</span>(x):
        <span style="color: #ffad29; font-weight: bold;">self</span>.progress.SetValue(x)
        <span style="color: #ffad29; font-weight: bold;">self</span>.Yield()
    <span style="color: #dbdb95;">data.statusfunc</span> = statusfunc
    <span style="color: #ffad29; font-weight: bold;">return</span> data
</pre>
</div>

<p>
The <code>loadPel</code> command reads in a neutron data file.  It takes as
a single parameter a message to display to the user about what
sort of file should be loaded.  There is also the ability to load
a pre-histogrammed version of the neutron data, stored in the
<a href="http://docs.numpy.org">numpy's</a> native binary format.  In practice, this hasn't been that
useful and may be dropped.  The numpy files do read far faster,
but they also take up huge amounts of disk space compared to the
event files, plus they need preprocessing from said event files
to be created in the first place.
</p>

<p>
This function also loads the monitor file that corresponds to the
data set.
</p>

<div class="org-src-container">

<pre class="src src-python" id="pelvis_handle_pels"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">loadPel</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,message):
    <span style="color: #e67128;">"""Load a .pel file and its monitor data.</span>

<span style="color: #e67128;">    Keyword arguments:</span>
<span style="color: #e67128;">    message -- The title for the load file dialog.</span>

<span style="color: #e67128;">    """</span>
    <span style="color: #dbdb95;">dlg</span>=wx.FileDialog(<span style="color: #ffad29; font-weight: bold;">self</span>,message,wildcard=<span style="color: #e67128;">"He3 data|*neutron_event.dat|Preformatted Histograms|*.npy"</span>,style=wx.FD_OPEN)
    <span style="color: #ffad29; font-weight: bold;">if</span> dlg.ShowModal()==wx.ID_OK:
    <span style="color: #74af68;">#            </span><span style="color: #74af68;">self.SetCursor(wx.CURSOR_WAIT)</span>
        <span style="color: #dbdb95;">path</span> = dlg.GetPath()
        <span style="color: #ffad29; font-weight: bold;">if</span> path[-3:] == <span style="color: #e67128;">"dat"</span>:
            data = <span style="color: #ffad29; font-weight: bold;">self</span>.makePel()
            data.readfileimage(path)
        <span style="color: #ffad29; font-weight: bold;">elif</span> path[-3:] == <span style="color: #e67128;">"npy"</span>:
            data = np.load(path)
    <span style="color: #74af68;">#            </span><span style="color: #74af68;">self.SetCursor(wx.CURSOR_ARROW)</span>
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #ffad29; font-weight: bold;">return</span> (<span style="color: #008b8b;">None</span>,<span style="color: #008b8b;">None</span>)
    mon = MonFile(path[:-17]+<span style="color: #e67128;">"bmon_histo.dat"</span>)
    <span style="color: #ffad29; font-weight: bold;">return</span> (data,mon)
</pre>
</div>

<p>
The <code>loadNormPel</code> function loads a neutron data set and a set of
counts from the beam monitor.  In the unlikely event that there
is a <i>flat run</i>, the flat is subtracted out of the data set.  The
neutron data is then normalized to the monitor count.
</p>

<div class="org-src-container">

<pre class="src src-python" id="pelvis_load_norm_pel"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">loadNormPel</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,message):
    <span style="color: #e67128;">"""Load a .pel file, normalize it by monitor, and subtract background"""</span>
    (data,mon) = <span style="color: #ffad29; font-weight: bold;">self</span>.loadPel(message)
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">isinstance</span>(data,PelFile):
        <span style="color: #dbdb95;">data</span> = np.asarray(data.make3d(),np.float32)
    <span style="color: #ffad29; font-weight: bold;">if</span> mon <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #ffad29; font-weight: bold;">return</span> (data,1)
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.flatrun != <span style="color: #008b8b;">None</span>:
        <span style="color: #dbdb95;">flatrun</span> = np.load(<span style="color: #ffad29; font-weight: bold;">self</span>.flatrun)
        <span style="color: #ffad29; font-weight: bold;">self</span>.flatrun.seek(0)
        <span style="color: #dbdb95;">flatrun</span> *= mon.time
        <span style="color: #dbdb95;">data</span> -= flatrun
    <span style="color: #dbdb95;">spec</span> = mon.spec
    <span style="color: #dbdb95;">monsum</span> = np.<span style="color: #23d7d7;">sum</span>(spec)
    <span style="color: #ffad29; font-weight: bold;">print</span>(<span style="color: #e67128;">"Integrated monitor counts: "</span> + <span style="color: #23d7d7;">str</span>(monsum))
    <span style="color: #dbdb95;">data</span> /= monsum
    <span style="color: #ffad29; font-weight: bold;">return</span> (data,np.<span style="color: #23d7d7;">sum</span>(mon.spec))
</pre>
</div>

<p>
The <code>loadUpAndDown</code> function is a helper function to load both
spin states of a flipping measurement.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">loadUpAndDown</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #e67128;">"""Read in spin flip data"""</span>
    <span style="color: #dbdb95;">u3d</span>,<span style="color: #dbdb95;">uscale</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.loadNormPel(<span style="color: #e67128;">"Spin Up State"</span>)
    <span style="color: #ffad29; font-weight: bold;">if</span> u3d <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #008b8b;">False</span>
    <span style="color: #ffad29; font-weight: bold;">del</span> <span style="color: #ffad29; font-weight: bold;">self</span>.data
    <span style="color: #dbdb95;">d3d</span>,<span style="color: #dbdb95;">dscale</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.loadNormPel(<span style="color: #e67128;">"Spin Down State"</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.data = (u3d,d3d)
    <span style="color: #ffad29; font-weight: bold;">self</span>.scale = (uscale,dscale)
    <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #008b8b;">True</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-3-1-3" class="outline-4">
<h4 id="sec-3-1-3"><span class="section-number-4">3.1.3</span> Menu Commands</h4>
<div class="outline-text-4" id="text-3-1-3">
<p>
The Image Array command causes Pelvis to export the detector
image, one wavelength bin at a time.  It can be useful to find
effects which are sensitive to both position and wavelength, but
it honestly hasn't seen much use.
</p>

<p>
The <code>path</code> and <code>ext</code> variables are used to get the file name that
the user chose and then sandwich the wavelength between them.
</p>

<div class="org-src-container">

<pre class="src src-python" id="pelvis_on_image_array"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnImageArray</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Exports the 2d detector image by wavelength"""</span>
    <span style="color: #dbdb95;">dlg</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.imageSaveDialog
    <span style="color: #ffad29; font-weight: bold;">if</span> dlg.ShowModal()==wx.ID_OK:
        <span style="color: #dbdb95;">path</span>=dlg.GetPath()
        <span style="color: #dbdb95;">ext</span> = path[-4:]
        <span style="color: #dbdb95;">path</span> = path[:-4]
        (lmin,lmax) = <span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.getLambdaRange()
        <span style="color: #ffad29; font-weight: bold;">for</span> i <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(lmin,lmax):
            <span style="color: #23d7d7;">file</span>=path+(<span style="color: #e67128;">"%03i"</span>%i)+ext
            <span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.setLambdaRange(0.1*i,0.1*(i+1))
            <span style="color: #ffad29; font-weight: bold;">self</span>.updateData()
            <span style="color: #ffad29; font-weight: bold;">self</span>.update()
            <span style="color: #ffad29; font-weight: bold;">self</span>.imPanel.saveImage(<span style="color: #23d7d7;">file</span>)
            <span style="color: #ffad29; font-weight: bold;">self</span>.progress.SetValue(1000*(i-lmin)/(lmax-lmin))
            <span style="color: #ffad29; font-weight: bold;">self</span>.Yield()
        <span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.setLambdaRange(lmin*0.1,lmax*0.1)
        <span style="color: #ffad29; font-weight: bold;">self</span>.updateData()
        <span style="color: #ffad29; font-weight: bold;">self</span>.progress.SetValue(0)
</pre>
</div>

<p>
The <code>OnUpdateButton</code> isn't really a menu command, but is rather
the calback for when the user clicks the update button.  All it
does is call the current value of the <code>updateData</code> function.
This function exists mostly because wxWidgets won't follow the
dynamically changing definition for <code>updateData</code> and needs a
static location for the callback.
</p>

<p>
<a id="pelvis_on_update_button_link" name="pelvis_on_update_button_link"></a>
</p>
<div class="org-src-container">

<pre class="src src-python" id="pelvis_on_update_button"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnUpdateButton</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Refresh the data when the user pushes the "Update" button"""</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">This function is needed for wxWidgets to allow</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">for dynamically changing the bound function</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateData(event)
</pre>
</div>

<p>
The <code>OnOpen</code> function handles opening a single data set.
<i>loadNormPel</i> does all of the actual file loading.  The <code>data</code> and
<code>scale</code> values are set to the actual neutron data and monitor
counts, respectively.  The <code>updateData</code> and <code>update</code> functions
are also set to single data file mode.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnOpen</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Load a single .pel file for display"""</span>
    <span style="color: #dbdb95;">data</span>,<span style="color: #dbdb95;">scale</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.loadNormPel(<span style="color: #e67128;">"Choose the Pel File to Open"</span>)
    <span style="color: #ffad29; font-weight: bold;">if</span> data <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #ffad29; font-weight: bold;">return</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.data = data
    <span style="color: #ffad29; font-weight: bold;">self</span>.scale = scale
    <span style="color: #ffad29; font-weight: bold;">self</span>.progress.SetValue(0)
    <span style="color: #ffad29; font-weight: bold;">self</span>.specDlg.setMode(<span style="color: #e67128;">"up"</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateData = <span style="color: #ffad29; font-weight: bold;">self</span>.updateSingleData
    <span style="color: #ffad29; font-weight: bold;">self</span>.update = <span style="color: #ffad29; font-weight: bold;">self</span>.updateSingle
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateData()
</pre>
</div>

<p>
Similarly to <code>OnOpen</code>, <code>OnOpenSet</code> loads two data files for
examining a polarization measurement.  The actual file loading is
handled by <i>loadUpAndDown</i>.  Should the files load, the application
switches to presenting polarization information.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnOpenSet</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Load a spin flip measurement for display"""</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.loadUpAndDown():
        <span style="color: #ffad29; font-weight: bold;">self</span>.OnPolar(event)
</pre>
</div>

<p>
Back when the PAPA detector first arrived, there was a light leak
that caused an enormous noise signal across the detector.  The
flat files were an attempt to eliminate that.  The flat files are
essentiall a position sensitive calculation of the detector noise
per unit time.  In practice, this functionality is almost never
used and should probably be removed, as it may be out of date or
inaccurate. 
</p>

<p>
<code>OnFlat</code> starts by having the user load in a background run.
This run is then flattened into a 3D positional map (the
background is assumed to be wavelength independent).  This 2D map
is normalized to the time of the measurement.
</p>

<p>
The <code>OnFakeFlat</code> function tries to use the background to simulate
having performed a flat measurement.  Honestly, this is probably
better perofrmed by simple background subtraction and should be
removed from the program.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnFlat</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Load a blank run for background subtraction"""</span>
    (data,mon) = <span style="color: #ffad29; font-weight: bold;">self</span>.loadPel(<span style="color: #e67128;">"Choose a Blank Run"</span>)
    <span style="color: #ffad29; font-weight: bold;">if</span> data == <span style="color: #008b8b;">None</span>:
        <span style="color: #ffad29; font-weight: bold;">return</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">isinstance</span>(data,PelFile):
        flatrun = data.make3d()
    <span style="color: #ffad29; font-weight: bold;">elif</span> <span style="color: #23d7d7;">isinstance</span>(data,np.ndarray):
        flatrun = data
    flatrun = np.<span style="color: #23d7d7;">sum</span>(flatrun,axis=2)
    flatrun /= RESOLUTION
    flatrun /= <span style="color: #23d7d7;">float</span>(mon.time)
    flatrun = np.expand_dims(flatrun,2)
    <span style="color: #ffad29; font-weight: bold;">self</span>.flatrun = TemporaryFile()
    np.save(<span style="color: #ffad29; font-weight: bold;">self</span>.flatrun,flatrun)
    <span style="color: #ffad29; font-weight: bold;">self</span>.flatrun.seek(0)
    <span style="color: #ffad29; font-weight: bold;">self</span>.progress.SetValue(0)

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnFakeFlat</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Create a fake background run from outside the region of interest."""</span>
    (xMin,xMax,yMin,yMax)=<span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.getRoi()
    totarea = 512*512
    centarea = (yMax-yMin)*(xMax-xMin)
    backgroundarea = totarea-centarea
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">type</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.data) <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #23d7d7;">tuple</span>:
        (u,d)=<span style="color: #ffad29; font-weight: bold;">self</span>.data

        totu = np.<span style="color: #23d7d7;">sum</span>(u)
        totd = np.<span style="color: #23d7d7;">sum</span>(d)
        centu = np.<span style="color: #23d7d7;">sum</span>(u[yMin:yMax,xMin:xMax,:])
        centd = np.<span style="color: #23d7d7;">sum</span>(d[yMin:yMax,xMin:xMax,:])

        backgroundu = totu-centu
        backgroundd = totd-centd
        backgroundrateu = backgroundu/backgroundarea
        backgroundrated = backgroundd/backgroundarea
        backgroundrateu /= (RESOLUTION + 1) <span style="color: #74af68;">#</span><span style="color: #74af68;">normalize against the wavelengths</span>
        backgroundrated /= (RESOLUTION + 1) <span style="color: #74af68;">#</span><span style="color: #74af68;">normalize against the wavelengths</span>
        <span style="color: #74af68;">###</span><span style="color: #74af68;">Stupid Memory Errors</span>
        <span style="color: #ffad29; font-weight: bold;">del</span> <span style="color: #ffad29; font-weight: bold;">self</span>.data
        u -= backgroundrateu
        d -= backgroundrated
        <span style="color: #74af68;">###</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.data=(u,d)
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        d=<span style="color: #ffad29; font-weight: bold;">self</span>.data
        tot = np.<span style="color: #23d7d7;">sum</span>(d)
        cent = np.<span style="color: #23d7d7;">sum</span>(d[yMin:yMax,xMin:xMax,:])
        background = tot-cent
        backgroundrate = background/backgroundarea
        backgroundrate /= (RESOLUTION + 1) <span style="color: #74af68;">#</span><span style="color: #74af68;">normalize against the wavelengths</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.data-=backgroundrate
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateData()
</pre>
</div>

<p>
The <code>OnROD</code> command is really just the background subtraction
function.  The <code>ROD</code> standards for "Region of Disinterest", which
is a play on the phrase "Region of Interest".
</p>

<p>
The code simply finds the average per pixel count rate in the current
selected region of interest and subtracts it from all the pixel.
Note that the background subtraction is performed per wavelength
bin, so wavelength specific backgrounds are handled appropriately.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span><span style="color: #74af68;">Subtract out the region of disinterest</span>
<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnROD</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Take the region of interest as background noise"""</span>
    (xMin,xMax,yMin,yMax)=<span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.getRoi()
    <span style="color: #dbdb95;">area</span> = (yMax-yMin)*(xMax-xMin)
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">type</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.data) <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #23d7d7;">tuple</span>:
        <span style="color: #dbdb95;">u</span>,<span style="color: #dbdb95;">d</span>=<span style="color: #ffad29; font-weight: bold;">self</span>.data
        <span style="color: #ffad29; font-weight: bold;">del</span> <span style="color: #ffad29; font-weight: bold;">self</span>.data
        <span style="color: #dbdb95;">totu</span> = np.<span style="color: #23d7d7;">sum</span>(np.<span style="color: #23d7d7;">sum</span>(u[yMin:yMax,xMin:xMax,:],axis=0),axis=0)
        <span style="color: #dbdb95;">totd</span> = np.<span style="color: #23d7d7;">sum</span>(np.<span style="color: #23d7d7;">sum</span>(d[yMin:yMax,xMin:xMax,:],axis=0),axis=0)
        <span style="color: #dbdb95;">totu</span> /= area
        <span style="color: #dbdb95;">totd</span> /= area
        <span style="color: #dbdb95;">u</span> -= totu
        <span style="color: #dbdb95;">d</span> -= totd
        <span style="color: #ffad29; font-weight: bold;">self</span>.data=(u,d)
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #dbdb95;">d</span>=<span style="color: #ffad29; font-weight: bold;">self</span>.data
        <span style="color: #dbdb95;">totd</span> = np.<span style="color: #23d7d7;">sum</span>(np.<span style="color: #23d7d7;">sum</span>(d[yMin:yMax,xMin:xMax,:],axis=0),axis=0)
        <span style="color: #74af68;">#</span><span style="color: #74af68;">totd = np.atleast_3d(totd)</span>
        <span style="color: #dbdb95;">totd</span> /= area
        <span style="color: #74af68;">#</span><span style="color: #74af68;">print(totd.shape)</span>
        <span style="color: #74af68;">#</span><span style="color: #74af68;">print(self.data.shape)</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.data -= totd
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateData()
</pre>
</div>

<p>
The <code>OnExportROI</code> function creates a 2D binary map of all of the
pixels where the intensity is less that the minimum intensity and
saves the map to a file.  The map can either be a text file for
readability or a binary file in numpy format for speed and
compactness.  Not that <code>OnExportROI</code> does <b>not</b> change the
current mask for the application. 
</p>

<p>
<a id="OnExportROI" name="OnExportROI"></a>
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnExportROI</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Save a file containing a map of where the current data</span>
<span style="color: #e67128;">    image is greater than vmin"""</span>
    <span style="color: #dbdb95;">vMin</span>,<span style="color: #dbdb95;">_</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.getIntensityRange()
    <span style="color: #dbdb95;">mask</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.flatdata &gt; vMin
    <span style="color: #74af68;"># </span><span style="color: #74af68;">(vMin,vMax) = self.opPanel.getIntensityRange()#</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">(xMin,xMax,yMin,yMax) = self.opPanel.getRoi()#</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">(lMin,lMax) = self.opPanel.getLambdaRange()#</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">(lMin,lMax) = (lMin/10,lMax/10)#</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">mask = [["xMin",xMin], ["xMax",xMax], ["yMin",yMin], ["yMax",yMax], \</span>
    <span style="color: #74af68;">#         </span><span style="color: #74af68;">["lMin",lMin], ["lMax",lMax], ["vMin",vMin], ["vMax",vMax]]#</span>
    <span style="color: #dbdb95;">dlg</span> = wx.FileDialog(<span style="color: #ffad29; font-weight: bold;">self</span>,
                        <span style="color: #e67128;">"Where to save the mask file?"</span>,
                        wildcard=<span style="color: #e67128;">"Numpy dump (npy)|*.npy|Text (dat)|*.dat"</span>,
                        style=wx.FD_SAVE|wx.FD_OVERWRITE_PROMPT)
    <span style="color: #ffad29; font-weight: bold;">if</span> dlg.ShowModal()==wx.ID_OK:
        <span style="color: #dbdb95;">path</span>=dlg.GetPath()
        <span style="color: #dbdb95;">ext</span> = path[-4:]
        <span style="color: #ffad29; font-weight: bold;">if</span> ext == <span style="color: #e67128;">".dat"</span>:
            np.savetxt(path,mask,fmt=<span style="color: #e67128;">"%d"</span>)
        <span style="color: #ffad29; font-weight: bold;">else</span>:
            np.save(path,mask)
</pre>
</div>

<p>
The <code>OnImportROI</code> sets the detector mask used for specifying the
region of interest.  It can load either of the mask formats
exported by <code>OnExportROI</code>.  A mask is loaded additively - if a
pixel is masked in either the current mask or in the loaded mask
file, it will be masked in the final mask.  Currently, the only
way to remove a pixel from the mask is to restart the
application.  Obviously, this is suboptimal and a simple
<code>RemoveMask</code> function should be written to return to an unmasked
state.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnImportROI</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Adds another mask to the current system mask"""</span>
    <span style="color: #dbdb95;">dlg</span> = wx.FileDialog(<span style="color: #ffad29; font-weight: bold;">self</span>,
                        <span style="color: #e67128;">"Which Mask File?"</span>,
                        wildcard=<span style="color: #e67128;">"Numpy dump (npy)|*.npy|Text (dat)|*.dat"</span>,
                        style=wx.FD_OPEN)
    time.sleep(.1)
    <span style="color: #ffad29; font-weight: bold;">if</span> dlg.ShowModal()==wx.ID_OK:
        <span style="color: #dbdb95;">path</span> = dlg.GetPath()
        <span style="color: #dbdb95;">ext</span> = path[-4:]
        <span style="color: #ffad29; font-weight: bold;">if</span> ext == <span style="color: #e67128;">".dat"</span>:
            newmask = np.loadtxt(path,dtype=np.<span style="color: #23d7d7;">bool</span>)
            newmask=<span style="color: #23d7d7;">dict</span>(newmask)<span style="color: #74af68;">#</span>
        <span style="color: #ffad29; font-weight: bold;">else</span>:
            newmask = np.load(path)
        <span style="color: #ffad29; font-weight: bold;">self</span>.mask = np.logical_and(<span style="color: #ffad29; font-weight: bold;">self</span>.mask,newmask)
        <span style="color: #74af68;">#</span><span style="color: #74af68;">self.opPanel.setPosMin(newmask["xMin"],newmask["yMin"])#</span>
        <span style="color: #74af68;">#</span><span style="color: #74af68;">self.opPanel.setPosMax(newmask["xMax"],newmask["yMax"])#</span>
        <span style="color: #74af68;">#</span><span style="color: #74af68;">self.opPanel.setLambdaRange(newmask["lMin"],newmask["lMax"])#</span>
        <span style="color: #74af68;">#</span><span style="color: #74af68;">self.opPanel.setIntensityRange(newmask["vMin"],newmask["vMax"])#</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.updateData()
</pre>
</div>

<p>
<code>OnSave</code> save the current detector image to a graphics file.  The
actual image saving is handled by the <i>ImagePanel</i> class.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnSave</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Save the current 2D image to a file"""</span>
    <span style="color: #ffad29; font-weight: bold;">print</span>(<span style="color: #e67128;">"OnSave"</span>)
<span style="color: #74af68;">#        </span><span style="color: #74af68;">dlg=wx.FileDialog(self,"Choose graphics file",wildcard="Windows Bitmap (bmp)|*.BMP|Portable Network Graphic (png)|*.PNG|Joint Photographic Experts Group (jpg)|*.JPG|Portable Network Monocrome (pnm)|*.PNM|Tagged Image File Format (tif)|*.TIF|Archaic, useless format (pcx)|*.PCX",style=wx.FD_SAVE|wx.FD_OVERWRITE_PROMPT)</span>
    <span style="color: #dbdb95;">dlg</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.imageSaveDialog
    <span style="color: #ffad29; font-weight: bold;">if</span> dlg.ShowModal()==wx.ID_OK:
        <span style="color: #ffad29; font-weight: bold;">self</span>.imPanel.saveImage(dlg.GetPath())
</pre>
</div>

<p>
The <code>OnSpectrum</code> function formats the data into a 1D format for
use by the <i>SpectrumDialog</i> in actually giving the spectral
information.  The data is masked by both the mask generated by
<code>OnImportROI</code> and by the user's chosen region of interest.  The
total counts per wavelength bin are then sent to the
SpectrumDialog, along with the scale from the monitor count. 
</p>

<p>
The user's chosen intensity range display is also sent to the
spectrum dialog.  This is helpful in getting proper bounds for
graphing the polarization and flipping ratio, since dividing by
small numbers can give strange boundary ranges.  Unfortunately,
this is NOT useful with raw intensity rates, since the intensity
range per pixel on the detector doesn't necessarily correspond to
what we're interested in with  the intensity per wavelength bin.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnSpectrum</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Display a plot of the region of interest versus wavelength"""</span>
    <span style="color: #ffad29; font-weight: bold;">print</span>(<span style="color: #e67128;">"OnSpectrum"</span>)
    (xMin,xMax,yMin,yMax)=<span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.getRoi()
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">type</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.data) <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #23d7d7;">tuple</span>:
        <span style="color: #dbdb95;">u3d</span>,<span style="color: #dbdb95;">d3d</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.data
        <span style="color: #dbdb95;">u3d</span> = u3d[:,:,:]
        <span style="color: #dbdb95;">d3d</span> = d3d[:,:,:]
        <span style="color: #dbdb95;">u3d</span>[np.logical_not(<span style="color: #ffad29; font-weight: bold;">self</span>.mask)] = 0
        <span style="color: #dbdb95;">d3d</span>[np.logical_not(<span style="color: #ffad29; font-weight: bold;">self</span>.mask)] = 0
        <span style="color: #dbdb95;">u</span> = np.<span style="color: #23d7d7;">sum</span>(np.<span style="color: #23d7d7;">sum</span>(u3d[yMin:yMax,xMin:xMax],0),0)
        <span style="color: #dbdb95;">d</span> = np.<span style="color: #23d7d7;">sum</span>(np.<span style="color: #23d7d7;">sum</span>(d3d[yMin:yMax,xMin:xMax],0),0)
        <span style="color: #dbdb95;">uscale</span>,<span style="color: #dbdb95;">dscale</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.scale
        <span style="color: #ffad29; font-weight: bold;">self</span>.specDlg.setScale(uscale,dscale)            
        <span style="color: #ffad29; font-weight: bold;">self</span>.specDlg.setData(u,d)
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #dbdb95;">copy</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.data[:,:,:]
        <span style="color: #dbdb95;">copy</span>[np.logical_not(<span style="color: #ffad29; font-weight: bold;">self</span>.mask)] = 0
        <span style="color: #dbdb95;">u</span> = np.<span style="color: #23d7d7;">sum</span>(np.<span style="color: #23d7d7;">sum</span>(copy[yMin:yMax,xMin:xMax],0),0)
        <span style="color: #74af68;">#            </span><span style="color: #74af68;">u *= self.scale</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.specDlg.setScale(<span style="color: #ffad29; font-weight: bold;">self</span>.scale)
        <span style="color: #ffad29; font-weight: bold;">self</span>.specDlg.setData(u)
    <span style="color: #ffad29; font-weight: bold;">self</span>.specDlg.setIntensityRange(<span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.getIntensityRange())
    <span style="color: #ffad29; font-weight: bold;">self</span>.specDlg.Show()
</pre>
</div>

<p>
There are a couple of menu functions for setting the color scheme
of the detector image.  <code>OnGrey</code> gives a greyscale image, as one
would expect.  <code>OnHueVal</code> gives an image where the intensity if
encoded into the Hue, with the saturation and Value both pegged
at the maximum.  Finally, <code>OnSpectral</code> is the default, with a
color scheme that starts at zero and passes through the range of
hues before arriving at white.
</p>

<p>
If the user wants a different color map, they can use the
<i>ColorMapPicker</i> to chose from any of the installed color maps.
PELVis currently does not support creating custom color spectra.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnGrey</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Set the colormap to gray"""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.imPanel.cmap = cm.gray
    <span style="color: #ffad29; font-weight: bold;">self</span>.colorbar.setCmap(cm.gray)
    <span style="color: #ffad29; font-weight: bold;">self</span>.update()

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnHueVal</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Set the colormap to a rainbow"""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.imPanel.cmap = cm.jet
    <span style="color: #ffad29; font-weight: bold;">self</span>.colorbar.setCmap(cm.jet)
    <span style="color: #ffad29; font-weight: bold;">self</span>.update()

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnSpectral</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Set the colormap to the spectral map"""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.imPanel.cmap = cm.spectral
    <span style="color: #ffad29; font-weight: bold;">self</span>.colorbar.setCmap(cm.spectral)
    <span style="color: #ffad29; font-weight: bold;">self</span>.update()

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnPicker</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Let the user pick a color map from a list"""</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.<span style="color: #23d7d7;">cmp</span> <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #ffad29; font-weight: bold;">self</span>.<span style="color: #23d7d7;">cmp</span> = ColorMapPicker(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #ffad29; font-weight: bold;">self</span>.setColorMap)
    <span style="color: #ffad29; font-weight: bold;">self</span>.<span style="color: #23d7d7;">cmp</span>.Show()
</pre>
</div>

<p>
The <code>OnExit</code> function is run when the user closes the program
from the menu.  It's not that interesting.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnExit</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
      <span style="color: #e67128;">"""Quit the program"""</span>
      <span style="color: #ffad29; font-weight: bold;">self</span>.Close()
</pre>
</div>

<p>
There are four functions to set the current data interpretation
mode for the application.  Each one sets the <code>update</code> and
<code>updateData</code> functions to the <a href="#sec-3-1-4">proper function</a> to handle the data
type, then sets the mode of the spectrum dialog.
</p>

<p>
It currently looks like the update function is always set to
updateSingle.  If this is the case, then the code can be
simplified.  This is worth investigation.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnPolar</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Display neutron polarization"""</span>
    <span style="color: #ffad29; font-weight: bold;">print</span>(<span style="color: #e67128;">"OnPolar"</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.specDlg.setMode(<span style="color: #e67128;">"polar"</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateData = <span style="color: #ffad29; font-weight: bold;">self</span>.updateDataPolar
    <span style="color: #ffad29; font-weight: bold;">self</span>.update = <span style="color: #ffad29; font-weight: bold;">self</span>.updateSingle
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateData()

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnFlipping</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Display the flipping ratio"""</span>
    <span style="color: #ffad29; font-weight: bold;">print</span>(<span style="color: #e67128;">"OnFlip"</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.specDlg.setMode(<span style="color: #e67128;">"flipping"</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateData = <span style="color: #ffad29; font-weight: bold;">self</span>.updateDataFlip
    <span style="color: #ffad29; font-weight: bold;">self</span>.update = <span style="color: #ffad29; font-weight: bold;">self</span>.updateSingle
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateData()

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnAnalysisSpinUp</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Display the Spin Up data"""</span>
    <span style="color: #ffad29; font-weight: bold;">print</span>(<span style="color: #e67128;">"OnSpinUp"</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.specDlg.setMode(<span style="color: #e67128;">"up"</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateData = <span style="color: #ffad29; font-weight: bold;">self</span>.updateDataUp
    <span style="color: #ffad29; font-weight: bold;">self</span>.update = <span style="color: #ffad29; font-weight: bold;">self</span>.updateSingle
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateData()

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnAnalysisSpinDown</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Display the Spin Down data"""</span>
    <span style="color: #ffad29; font-weight: bold;">print</span>(<span style="color: #e67128;">"OnSpinDown"</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.specDlg.setMode(<span style="color: #e67128;">"down"</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateData = <span style="color: #ffad29; font-weight: bold;">self</span>.updateDataDown
    <span style="color: #ffad29; font-weight: bold;">self</span>.update = <span style="color: #ffad29; font-weight: bold;">self</span>.updateSingle
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateData()
</pre>
</div>

<p>
<code>OnCopy</code> is called when a user selects the Copy command from the
Edit menu.  This copies the current detector image to the
clipboard, though everything is really handled by the <i>ImagePanel</i> class.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnCopy</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Copy the image to a clipboard"""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.imPanel.copyToClipboard()
</pre>
</div>
</div>
</div>



<div id="outline-container-sec-3-1-4" class="outline-4">
<h4 id="sec-3-1-4"><span class="section-number-4">3.1.4</span> Updaters</h4>
<div class="outline-text-4" id="text-3-1-4">
<p>
There are two updates which need to be performed.  The first is
updating the data, which involves taking the 3D arrays of neutron
data and turning them into a single, 2D map.  The second is using
that 2D data to update the other parts of the application.  All
of the function with data in the name handle converting the 3D
data into the 2D map, while the remaining functions pass the 2D
data to the rest of the application.
</p>

<p>
<code>updateSingleData</code> is used when only a single file is loaded.  As
the only thing we can do is give intensity per pixel, a simple
sum is performed along the wavelength axis.
</p>

<div class="org-src-container">

<pre class="src src-python" id="pelvis_updaters"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">updateSingleData</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event=<span style="color: #008b8b;">None</span>):
    <span style="color: #e67128;">"""Update changes in wavelength on a single file"""</span>
    <span style="color: #ffad29; font-weight: bold;">print</span>(<span style="color: #e67128;">"Make 2d"</span>)
    (lmin,lmax) = <span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.getLambdaRange()
    <span style="color: #ffad29; font-weight: bold;">self</span>.flatdata = np.<span style="color: #23d7d7;">sum</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.data[:,:,lmin:lmax],2)
    <span style="color: #ffad29; font-weight: bold;">self</span>.update()
</pre>
</div>

<p>
<code>updateDataFlip</code> and <code>updateDataPolar</code> require both an up and
down state from a polarization measurement.  They then calculate
the per pixel neutron flipping ratio and polarization,
respectively.  a value of 10<sup>-9</sup> is added to the denominator to
prevent divide by zero errors.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">updateDataFlip</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event=<span style="color: #008b8b;">None</span>):
    <span style="color: #e67128;">"""Update changes in wavelength for flipping ratios"""</span>
    (lmin,lmax) = <span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.getLambdaRange()
    (u3d,d3d)=<span style="color: #ffad29; font-weight: bold;">self</span>.data
    <span style="color: #dbdb95;">u</span> = np.<span style="color: #23d7d7;">sum</span>(u3d[:,:,lmin:lmax],2)
    <span style="color: #dbdb95;">d</span> = np.<span style="color: #23d7d7;">sum</span>(d3d[:,:,lmin:lmax],2)
    <span style="color: #ffad29; font-weight: bold;">self</span>.flatdata = u/(d+1e-6)
    <span style="color: #ffad29; font-weight: bold;">self</span>.update()

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">updateDataPolar</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event=<span style="color: #008b8b;">None</span>):
    <span style="color: #e67128;">"""Update changes in wavelength for polarizations"""</span>
    (lmin,lmax) = <span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.getLambdaRange()
    (u3d,d3d)=<span style="color: #ffad29; font-weight: bold;">self</span>.data
    <span style="color: #dbdb95;">u</span> = np.<span style="color: #23d7d7;">sum</span>(u3d[:,:,lmin:lmax],2)
    <span style="color: #dbdb95;">d</span> = np.<span style="color: #23d7d7;">sum</span>(d3d[:,:,lmin:lmax],2)
    <span style="color: #ffad29; font-weight: bold;">self</span>.flatdata = (u-d)/(u+d+1e-6)
    <span style="color: #ffad29; font-weight: bold;">self</span>.update()
</pre>
</div>

<p>
The <code>updateDataUp</code> and <code>updateDataDown</code> commands display the
neutron intensity per pixel in a single spin state.  They are
largely identical to <code>updateSingleData</code>, except for the line
which selects the spin state.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">updateDataUp</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event=<span style="color: #008b8b;">None</span>):
    <span style="color: #e67128;">"""Update changes in wavelength for the spin up state"""</span>
    (lmin,lmax) = <span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.getLambdaRange()
    (u3d,_)=<span style="color: #ffad29; font-weight: bold;">self</span>.data
    <span style="color: #ffad29; font-weight: bold;">self</span>.flatdata = np.<span style="color: #23d7d7;">sum</span>(u3d[:,:,lmin:lmax],2)
    <span style="color: #ffad29; font-weight: bold;">self</span>.update()

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">updateDataDown</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event=<span style="color: #008b8b;">None</span>):
    <span style="color: #e67128;">"""Update changes in wavelength for the spin down state"""</span>
    (lmin,lmax) = <span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.getLambdaRange()
    (_,d3d)=<span style="color: #ffad29; font-weight: bold;">self</span>.data
    <span style="color: #ffad29; font-weight: bold;">self</span>.flatdata = np.<span style="color: #23d7d7;">sum</span>(d3d[:,:,lmin:lmax],2)
    <span style="color: #ffad29; font-weight: bold;">self</span>.update()
</pre>
</div>

<p>
The <code>updateSingle</code> function takes the current 2D data, performs
the appropriate masking, and updates the data in the <i>GraphPanels</i>.
It also updates the range on the color bar and forces the
<i>detector image</i> to update.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">updateSingle</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event=<span style="color: #008b8b;">None</span>):
    <span style="color: #e67128;">"""Update the 2D data for the region of interest and intensity"""</span>
    (vMin,vMax) = <span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.getIntensityRange()
    (xMin,xMax,yMin,yMax) = <span style="color: #ffad29; font-weight: bold;">self</span>.opPanel.getRoi()
    <span style="color: #dbdb95;">data</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.flatdata[:,:]

    <span style="color: #74af68;">#</span><span style="color: #74af68;">Mask to zero during the summing parts</span>
    <span style="color: #dbdb95;">data</span>[np.logical_not(<span style="color: #ffad29; font-weight: bold;">self</span>.mask)] = 0
    <span style="color: #ffad29; font-weight: bold;">self</span>.posPanel.data = data
    <span style="color: #ffad29; font-weight: bold;">self</span>.posPanel.setRange(xMin,yMin,xMax,yMax)
    <span style="color: #dbdb95;">x</span>=np.arange(128,0,-1)
    <span style="color: #dbdb95;">y</span>=np.<span style="color: #23d7d7;">sum</span>(data[:,xMin:xMax],axis=1)
    <span style="color: #ffad29; font-weight: bold;">self</span>.yPanel.SetPlot(x,y)
    <span style="color: #74af68;">#</span><span style="color: #74af68;">handle the x-plot</span>
    <span style="color: #dbdb95;">x</span>=np.arange(0,16,1)
    <span style="color: #dbdb95;">y</span>=np.<span style="color: #23d7d7;">sum</span>(data[yMin:yMax,:],axis=0)
    <span style="color: #ffad29; font-weight: bold;">self</span>.xPanel.SetPlot(x,y)
    <span style="color: #ffad29; font-weight: bold;">if</span> vMin <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #dbdb95;">vMin</span> = np.<span style="color: #23d7d7;">min</span>(data)
    <span style="color: #ffad29; font-weight: bold;">if</span> vMax <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #dbdb95;">vMax</span> = np.<span style="color: #23d7d7;">max</span>(data)
    <span style="color: #ffad29; font-weight: bold;">self</span>.colorbar.setRange(vMin,vMax)
    <span style="color: #ffad29; font-weight: bold;">self</span>.colorbar.update()
    <span style="color: #74af68;">#</span><span style="color: #74af68;">mask to vmin for the plotting</span>
    <span style="color: #dbdb95;">data</span>[np.logical_not(<span style="color: #ffad29; font-weight: bold;">self</span>.mask)] = vMin
    <span style="color: #ffad29; font-weight: bold;">self</span>.imPanel.update(<span style="color: #ffad29; font-weight: bold;">self</span>.flatdata,vMin,vMax)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Position Panel</h3>
<div class="outline-text-3" id="text-3-2">
<p>
This is a class to provide a small panel which provides
information about single pixels of detector data via the cursor
position.  It also provides aggregate information over the region
of interest.
</p>
</div>

<div id="outline-container-sec-3-2-1" class="outline-4">
<h4 id="sec-3-2-1"><span class="section-number-4">3.2.1</span> Position Panel Class Skeleton</h4>
<div class="outline-text-4" id="text-3-2-1">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">PositionPanel</span>(wx.Panel):
    <span style="color: #e67128;">"""A panel with pixel information</span>

<span style="color: #e67128;">    The intent of this panel is to provide information about</span>
<span style="color: #e67128;">    single pixels of detector data via cursor position.  It</span>
<span style="color: #e67128;">    also provides aggregate information over the region of</span>
<span style="color: #e67128;">    interest.</span>

<span style="color: #e67128;">    """</span>

    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,parent):
        <span style="color: #e67128;">"""Create a PositionPanel"""</span>
        &lt;&lt;position_panel_init&gt;&gt;
    &lt;&lt;position_panel_updating&gt;&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-2-2" class="outline-4">
<h4 id="sec-3-2-2"><span class="section-number-4">3.2.2</span> Initialization of the PositionPanel</h4>
<div class="outline-text-4" id="text-3-2-2">
<p>
Creating a new PositionPanel requires only a single parameter:
the parent frame which will hold the panel.  The constructor
begins by creating the text controls that display the X and Y
position of the cursor, as well as the value under the cursor (Z)
and the integrated value over the region of interest (ROI).
</p>

<div class="org-src-container">

<pre class="src src-python" id="position_panel_init">wx.Panel.__init__(<span style="color: #ffad29; font-weight: bold;">self</span>,parent)
<span style="color: #dbdb95;">sizer</span>=wx.GridBagSizer(3,2)
sizer.Add(wx.StaticText(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">"X:"</span>),pos=wx.GBPosition(0,0))
<span style="color: #ffad29; font-weight: bold;">self</span>.x = wx.TextCtrl(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">""</span>)   
sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.x,pos=wx.GBPosition(0,1))
sizer.Add(wx.StaticText(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">"Y:"</span>),pos=wx.GBPosition(1,0))
<span style="color: #ffad29; font-weight: bold;">self</span>.y = wx.TextCtrl(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">""</span>)
sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.y,pos=wx.GBPosition(1,1))
sizer.Add(wx.StaticText(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">"Z:"</span>),pos=wx.GBPosition(2,0))
<span style="color: #ffad29; font-weight: bold;">self</span>.intensity = wx.TextCtrl(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">""</span>)
sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.intensity,pos=wx.GBPosition(2,1))
<span style="color: #ffad29; font-weight: bold;">self</span>.integrate = wx.TextCtrl(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">""</span>)
sizer.Add(wx.StaticText(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">"ROI:"</span>),pos=wx.GBPosition(3,0))
sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.integrate,pos=wx.GBPosition(3,1))
</pre>
</div>

<p>
We give a default region of interest that covers the entire detector.
</p>

<div class="org-src-container">

<pre class="src src-python" id="position_panel_init"><span style="color: #74af68;">#</span><span style="color: #74af68;">Set the starting region of interest</span>
<span style="color: #ffad29; font-weight: bold;">self</span>.minX = 0
<span style="color: #ffad29; font-weight: bold;">self</span>.minY = 0
<span style="color: #ffad29; font-weight: bold;">self</span>.maxX = 16
<span style="color: #ffad29; font-weight: bold;">self</span>.maxY = 128
</pre>
</div>

<p>
The text controls are for display purposes only, so we'll ensure
that they aren't editable.
</p>

<div class="org-src-container">

<pre class="src src-python" id="position_panel_init"><span style="color: #ffad29; font-weight: bold;">self</span>.x.SetEditable(<span style="color: #008b8b;">False</span>)
<span style="color: #ffad29; font-weight: bold;">self</span>.y.SetEditable(<span style="color: #008b8b;">False</span>)
<span style="color: #ffad29; font-weight: bold;">self</span>.intensity.SetEditable(<span style="color: #008b8b;">False</span>)
</pre>
</div>

<p>
The class member <code>self.data</code> is a pointer to the actual data
being examined.  We'll initialize it to <code>None</code> to begin with.
</p>

<div class="org-src-container">

<pre class="src src-python" id="position_panel_init"><span style="color: #ffad29; font-weight: bold;">self</span>.data = <span style="color: #008b8b;">None</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">A 2D numpy array of the data being examined.</span>
</pre>
</div>

<p>
Finally, we need to do the standard GUI layout code.
</p>

<div class="org-src-container">

<pre class="src src-python" id="position_panel_init"><span style="color: #ffad29; font-weight: bold;">self</span>.SetAutoLayout(<span style="color: #008b8b;">True</span>)
sizer.SetSizeHints(<span style="color: #ffad29; font-weight: bold;">self</span>)
<span style="color: #ffad29; font-weight: bold;">self</span>.SetSizer(sizer)
<span style="color: #ffad29; font-weight: bold;">self</span>.Layout()
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-2-3" class="outline-4">
<h4 id="sec-3-2-3"><span class="section-number-4">3.2.3</span> Update position data</h4>
<div class="outline-text-4" id="text-3-2-3">
<p>
As implied by the name, the primary function of the position
panel is to provide the direct numbers for the value under the
user's cursor.  To do that, it must know where the mouse is.  The
<code>set</code> function takes the x and y position of the cursor and
updates the panel accordingly.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">set</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,x,y):
    <span style="color: #e67128;">"""Updates the position being examined"""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.x.SetValue(<span style="color: #23d7d7;">str</span>(x))
    <span style="color: #ffad29; font-weight: bold;">self</span>.y.SetValue(<span style="color: #23d7d7;">str</span>(y))
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.data <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #ffad29; font-weight: bold;">return</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.intensity.SetValue(<span style="color: #23d7d7;">str</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.data[y,x]))
</pre>
</div>

<p>
Obviously, this is of no use if the panel doesn't know the
detector values.  The <code>setData</code> function provides a 2D array of
values for the Panel to report on.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">setData</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,data):
    <span style="color: #e67128;">"""Updates the data being examined"""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.data=data
</pre>
</div>

<p>
The remaining functions deal with the region of interest
integration.  The <code>setRange</code> function controls the region of
interest while the <code>updateIntegration</code> function handles
calculating 
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">setRange</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,minX,minY,maxX,maxY):
    <span style="color: #e67128;">"""Updates the region of interest for integration"""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.minX = minX
    <span style="color: #ffad29; font-weight: bold;">self</span>.minY = minY
    <span style="color: #ffad29; font-weight: bold;">self</span>.maxX = maxX
    <span style="color: #ffad29; font-weight: bold;">self</span>.maxY = maxY
    <span style="color: #ffad29; font-weight: bold;">self</span>.updateIntegration()
<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">updateIntegration</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #e67128;">"""Calculates the sum of the data over the region of interest"""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.integrate.SetValue(
        <span style="color: #23d7d7;">str</span>(np.<span style="color: #23d7d7;">sum</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.data[<span style="color: #ffad29; font-weight: bold;">self</span>.minY:<span style="color: #ffad29; font-weight: bold;">self</span>.maxY,<span style="color: #ffad29; font-weight: bold;">self</span>.minX:<span style="color: #ffad29; font-weight: bold;">self</span>.maxX])))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> Option Panel</h3>
<div class="outline-text-3" id="text-3-3">
<p>
The class PelvisOptionPanel creates a panel of labeled text boxes
for user entry.  This is used to control values such as the
wavelength range, region of interest, and intensity values.
</p>

<p>
As an experiment in software architecture, the class generates the
layout of the panel from a list of configurations.  Each list item
is a tuple of four values
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="left" />

<col  class="left" />

<col  class="right" />

<col  class="left" />

<col  class="left" />
</colgroup>
<tbody>
<tr>
<td class="left">Position</td>
<td class="left">0</td>
<td class="right">1</td>
<td class="left">2</td>
<td class="left">3</td>
</tr>

<tr>
<td class="left">Value</td>
<td class="left">Name</td>
<td class="right">Relative list position</td>
<td class="left">Label</td>
<td class="left">Default Value</td>
</tr>

<tr>
<td class="left">Type</td>
<td class="left">string</td>
<td class="right">int</td>
<td class="left">string</td>
<td class="left">string</td>
</tr>

<tr>
<td class="left">Example</td>
<td class="left">"lambdaMax"</td>
<td class="right">30</td>
<td class="left">"Maximum Wavelength"</td>
<td class="left">"19.7"</td>
</tr>
</tbody>
</table>

<p>
The panel generates a set of text controls with the given labels
and default values.  The text controls are arranged from top to
bottom by the order of the relative list position from smallest to
largest.
</p>

<p>
The advantage to this setup is that adding new options onto the
panel is trivial.  Putting a new item into the list adds a new
option onto the panel.  The disadvantage is that the data is a
little more cumbersome to access as the values are not members of
the class.  This could be fixed with Python accessors and
properties, but I have not done so yet.  As this design decision
was made to ease life for future maintainers and, seeing as you're
reading this, you are the future maintainer, feel free to return
to hard coded values if you find it easier to handle.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">PelvisOptionPanel</span>(wx.Panel):
    <span style="color: #e67128;">"""A panel for user parameters</span>

<span style="color: #e67128;">    The panel gets it's parameters and appearance from the built in</span>
<span style="color: #e67128;">    DEFAULTS variable.  This was designed to allow the easy addition</span>
<span style="color: #e67128;">    of more parameters in the future.</span>

<span style="color: #e67128;">    """</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">Each parameter is a tuple</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">0 - variable name</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">1 - position in list</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">2 - label</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">3 - default value</span>
    <span style="color: #dbdb95;">DEFAULTS</span> = [(<span style="color: #e67128;">"lambdaMax"</span>,0,<span style="color: #e67128;">"Maximum Wavelength"</span>,<span style="color: #e67128;">"20"</span>),
                (<span style="color: #e67128;">"lambdaMin"</span>,10,<span style="color: #e67128;">"Minimum Wavelength"</span>,<span style="color: #e67128;">"0"</span>),
                (<span style="color: #e67128;">"intMax"</span>,20,<span style="color: #e67128;">"Maximum Intensity"</span>,<span style="color: #e67128;">""</span>),
                (<span style="color: #e67128;">"intMin"</span>,30,<span style="color: #e67128;">"Minimum Intensity"</span>,<span style="color: #e67128;">""</span>),
                (<span style="color: #e67128;">"xMin"</span>,40,<span style="color: #e67128;">"Minimun X"</span>,<span style="color: #e67128;">"0"</span>),
                (<span style="color: #e67128;">"xMax"</span>,50,<span style="color: #e67128;">"Maximum X"</span>,<span style="color: #e67128;">"16"</span>),
                (<span style="color: #e67128;">"yMin"</span>,60,<span style="color: #e67128;">"Minimun Y"</span>,<span style="color: #e67128;">"0"</span>),
                (<span style="color: #e67128;">"yMax"</span>,70,<span style="color: #e67128;">"Maximum Y"</span>,<span style="color: #e67128;">"128"</span>)]

    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,parent):
        <span style="color: #e67128;">"""Creates a PelvisOptionPanel"""</span>
        &lt;&lt;pelvis_option_panel_init&gt;&gt;

    &lt;&lt;pelvis_option_panel_wavelength&gt;&gt;

    &lt;&lt;pelvis_option_panel_intensity&gt;&gt;

    &lt;&lt;pelvis_option_panel_roi&gt;&gt;
</pre>
</div>
</div>

<div id="outline-container-sec-3-3-1" class="outline-4">
<h4 id="sec-3-3-1"><span class="section-number-4">3.3.1</span> Initialization</h4>
<div class="outline-text-4" id="text-3-3-1">
<p>
We begin by initializing the superclass and creating a sizer for
the panel
</p>
<div class="org-src-container">

<pre class="src src-python">wx.Panel.__init__(<span style="color: #ffad29; font-weight: bold;">self</span>,parent)
<span style="color: #dbdb95;">sizer</span>=wx.BoxSizer(wx.VERTICAL)
</pre>
</div>

<p>
We then create the text controls.  The controls are held in the
local dictionary <code>options</code>, which will need to be used every time
we want to access one of the values.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">self</span>.options={}<span style="color: #74af68;">#</span><span style="color: #74af68;">member which holds the created text controls</span>

<span style="color: #ffad29; font-weight: bold;">self</span>.DEFAULTS.sort(<span style="color: #ffad29; font-weight: bold;">lambda</span> x,y: x[1]-y[1])
<span style="color: #ffad29; font-weight: bold;">for</span> option <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #ffad29; font-weight: bold;">self</span>.DEFAULTS:
    (key,_,title,val) = option
    sizer.Add(wx.StaticText(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,title))
    <span style="color: #ffad29; font-weight: bold;">self</span>.options[key] = wx.TextCtrl(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,val)
    sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.options[key])
</pre>
</div>

<p>
Finally, we perform the standard cleanup for a wxPanel
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">self</span>.SetAutoLayout(<span style="color: #008b8b;">True</span>)
<span style="color: #ffad29; font-weight: bold;">self</span>.specDlg = SpectrumDialog(<span style="color: #ffad29; font-weight: bold;">self</span>)
sizer.SetSizeHints(<span style="color: #ffad29; font-weight: bold;">self</span>)
<span style="color: #ffad29; font-weight: bold;">self</span>.SetSizer(sizer)
<span style="color: #ffad29; font-weight: bold;">self</span>.Layout()
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-3-2" class="outline-4">
<h4 id="sec-3-3-2"><span class="section-number-4">3.3.2</span> Wavelength Range</h4>
<div class="outline-text-4" id="text-3-3-2">
<p>
When a set of parameters is added, it's useful to put in a
standard getter and setter.  The setters are fairly standard, but
the getter can be a little tricky, since the user might add a
non-standard value.  It's good to provide default values if the
user's input cannot be parsed.
</p>

<p>
Note that the code below is <b>wrong</b>.  It holds true while
the RESOLUTION is 200, which is the default case, but the
multiplication by ten should be replaced with a value dependent
on the current resolution.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">getLambdaRange</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #e67128;">"""Gives a tuple with the minimum and maximum wavelength indices"""</span>
    <span style="color: #ffad29; font-weight: bold;">try</span>:
        <span style="color: #dbdb95;">lmin</span> = <span style="color: #23d7d7;">int</span>(<span style="color: #23d7d7;">float</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"lambdaMin"</span>].GetValue())*10)
    <span style="color: #ffad29; font-weight: bold;">except</span> <span style="color: #34cae2;">ValueError</span>:
        <span style="color: #dbdb95;">lmin</span> = 0
    <span style="color: #ffad29; font-weight: bold;">try</span>:
        <span style="color: #dbdb95;">lmax</span> = <span style="color: #23d7d7;">int</span>(<span style="color: #23d7d7;">float</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"lambdaMax"</span>].GetValue())*10)
    <span style="color: #ffad29; font-weight: bold;">except</span> <span style="color: #34cae2;">ValueError</span>:
        <span style="color: #dbdb95;">lmax</span> = RESOLUTION
    <span style="color: #ffad29; font-weight: bold;">return</span> (lmin,lmax)

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">setLambdaRange</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #23d7d7;">min</span>,<span style="color: #23d7d7;">max</span>):
    <span style="color: #e67128;">"""Set the minimum and maximum wavelengths"""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"lambdaMin"</span>].SetValue(<span style="color: #23d7d7;">str</span>(<span style="color: #23d7d7;">min</span>))
    <span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"lambdaMax"</span>].SetValue(<span style="color: #23d7d7;">str</span>(<span style="color: #23d7d7;">max</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-3-3" class="outline-4">
<h4 id="sec-3-3-3"><span class="section-number-4">3.3.3</span> Intensity Range</h4>
<div class="outline-text-4" id="text-3-3-3">
<p>
We create similar getters and setters for the minimum and maximum
intensity.  The values create bounds for both the 2D color plot
and the spectrum display.  They're also used as part of the mask
making routines.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">getIntensityRange</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #e67128;">"""Return a tuple with the floor and ceilling for intensity</span>

<span style="color: #e67128;">    If a value isn't specified, or is not a number, None is returned</span>
<span style="color: #e67128;">    for that part of the range.</span>

<span style="color: #e67128;">    """</span>
    <span style="color: #ffad29; font-weight: bold;">try</span>:
        <span style="color: #dbdb95;">vMin</span> = <span style="color: #23d7d7;">float</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"intMin"</span>].GetValue())
    <span style="color: #ffad29; font-weight: bold;">except</span> <span style="color: #34cae2;">ValueError</span>:
        <span style="color: #dbdb95;">vMin</span> = <span style="color: #008b8b;">None</span>
    <span style="color: #ffad29; font-weight: bold;">try</span>:
        <span style="color: #dbdb95;">vMax</span> = <span style="color: #23d7d7;">float</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"intMax"</span>].GetValue())
    <span style="color: #ffad29; font-weight: bold;">except</span> <span style="color: #34cae2;">ValueError</span>:
        <span style="color: #dbdb95;">vMax</span> = <span style="color: #008b8b;">None</span>
    <span style="color: #ffad29; font-weight: bold;">return</span> (vMin,vMax)

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">setIntensityRange</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #23d7d7;">min</span>,<span style="color: #23d7d7;">max</span>):
    <span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"intMin"</span>].SetValue(<span style="color: #23d7d7;">str</span>(<span style="color: #23d7d7;">min</span>))
    <span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"intMax"</span>].SetValue(<span style="color: #23d7d7;">str</span>(<span style="color: #23d7d7;">max</span>))
    <span style="color: #ffad29; font-weight: bold;">self</span>.specDlg.setIntensityRange((<span style="color: #23d7d7;">min</span>,<span style="color: #23d7d7;">max</span>))
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-3-4" class="outline-4">
<h4 id="sec-3-3-4"><span class="section-number-4">3.3.4</span> Region of Interest</h4>
<div class="outline-text-4" id="text-3-3-4">
<p>
Finally, we need getters and setters for our region of interest.
The getter works pretty much the same as the others, but the
setter has been split into two functions: one for the upper left
corner and another for the lower right.  This allows us to set
the region of interest with two mouse clicks.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">getRoi</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #e67128;">"""Returns a 4-tuple with the region of interest</span>

<span style="color: #e67128;">    Returns (xmin,xmax,ymin,ymax).  Minimum values, if</span>
<span style="color: #e67128;">    unspecified, are set to zero.  Maximum values, if</span>
<span style="color: #e67128;">    unspecified, are set to 512.</span>

<span style="color: #e67128;">    """</span>
    <span style="color: #ffad29; font-weight: bold;">try</span>:
        <span style="color: #dbdb95;">xMin</span> = <span style="color: #23d7d7;">int</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"xMin"</span>].GetValue())
    <span style="color: #ffad29; font-weight: bold;">except</span> <span style="color: #34cae2;">ValueError</span>:
        <span style="color: #dbdb95;">xMin</span> = 0
    <span style="color: #ffad29; font-weight: bold;">try</span>:
        <span style="color: #dbdb95;">xMax</span> = <span style="color: #23d7d7;">int</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"xMax"</span>].GetValue())
    <span style="color: #ffad29; font-weight: bold;">except</span> <span style="color: #34cae2;">ValueError</span>:
        <span style="color: #dbdb95;">xMax</span> = 512
    <span style="color: #ffad29; font-weight: bold;">try</span>:
        <span style="color: #dbdb95;">yMin</span> = <span style="color: #23d7d7;">int</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"yMin"</span>].GetValue())
    <span style="color: #ffad29; font-weight: bold;">except</span> <span style="color: #34cae2;">ValueError</span>:
        <span style="color: #dbdb95;">yMin</span> = 0
    <span style="color: #ffad29; font-weight: bold;">try</span>:
        <span style="color: #dbdb95;">yMax</span> = <span style="color: #23d7d7;">int</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"yMax"</span>].GetValue())
    <span style="color: #ffad29; font-weight: bold;">except</span> <span style="color: #34cae2;">ValueError</span>:
        <span style="color: #dbdb95;">yMax</span> = 512
    <span style="color: #ffad29; font-weight: bold;">return</span> (xMin,xMax,yMin,yMax)

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">setPosMin</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,x,y):
    <span style="color: #e67128;">"""Takes the x and y coordinates for the NW corner of the ROI."""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"xMin"</span>].SetValue(<span style="color: #23d7d7;">str</span>(x))
    <span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"yMin"</span>].SetValue(<span style="color: #23d7d7;">str</span>(y))

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">setPosMax</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,x,y):
    <span style="color: #e67128;">"""Takes the x and y coordinates for the SE corner of the ROI."""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"xMax"</span>].SetValue(<span style="color: #23d7d7;">str</span>(x))
    <span style="color: #ffad29; font-weight: bold;">self</span>.options[<span style="color: #e67128;">"yMax"</span>].SetValue(<span style="color: #23d7d7;">str</span>(y))
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Graph Panel</h3>
<div class="outline-text-3" id="text-3-4">
<p>
The <code>GraphPanel</code> module creates a single filled-line plot that can
be embedded in a wxWidgets frame.  It's used by PelVis to present
the detector image integrated along axis.
</p>
</div>

<div id="outline-container-sec-3-4-1" class="outline-4">
<h4 id="sec-3-4-1"><span class="section-number-4">3.4.1</span> Graph Panel Skeleton</h4>
<div class="outline-text-4" id="text-3-4-1">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #e67128;">"""Classes for adding sumlines to frames</span>

<span style="color: #e67128;">This module contains a single class, GraphPanel, which plots two dimensional</span>
<span style="color: #e67128;">data filled along a chosen axis.  This class was originally designed for giving</span>
<span style="color: #e67128;">the summation of a matrix along a given axis, but there's not reason that it</span>
<span style="color: #e67128;">couldn't be expanded for other purposes.</span>

<span style="color: #e67128;">"""</span>

<span style="color: #ffad29; font-weight: bold;">import</span> numpy <span style="color: #ffad29; font-weight: bold;">as</span> np

<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.backends.backend_wxagg <span style="color: #ffad29; font-weight: bold;">import</span> FigureCanvasWxAgg <span style="color: #ffad29; font-weight: bold;">as</span> FigureCanvas
<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.backends.backend_wx <span style="color: #ffad29; font-weight: bold;">import</span> NavigationToolbar2Wx
<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.figure <span style="color: #ffad29; font-weight: bold;">import</span> Figure
<span style="color: #74af68;">#</span><span style="color: #74af68;">import matplotlib.cm as cm</span>

<span style="color: #ffad29; font-weight: bold;">import</span> wx

&lt;&lt;graphpanel_rebin&gt;&gt;

<span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">GraphPanel</span>(wx.Panel):
    <span style="color: #e67128;">"""This class creates a panel that displays a filled plot. """</span>


    <span style="color: #dbdb95;">HORIZONTAL</span> = 0 
    <span style="color: #dbdb95;">INVERTED</span> = 1
    <span style="color: #dbdb95;">VERTICAL</span> = 2
    &lt;&lt;graphpanel_init&gt;&gt;
    &lt;&lt;graphpanel_setplot&gt;&gt;

<span style="color: #74af68;">#     </span><span style="color: #74af68;">def SetYLim(self,range):</span>
<span style="color: #74af68;">#         </span><span style="color: #74af68;">self.axes.set_ylim(range)</span>

<span style="color: #74af68;">#     </span><span style="color: #74af68;">def SetXLim(self,range):</span>
<span style="color: #74af68;">#         </span><span style="color: #74af68;">self.axes.set_xlim(range)</span>

    &lt;&lt;graphpanel_setpos&gt;&gt;

    &lt;&lt;graphpanel_onpaint&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-4-2" class="outline-4">
<h4 id="sec-3-4-2"><span class="section-number-4">3.4.2</span> rebin function</h4>
<div class="outline-text-4" id="text-3-4-2">
<p>
The rebin function takes an numpy array and an integer of how many
bins to combine.  The result is a new numpy array where each group of
<code>count</code> bins have been averaged together.
</p>

<p>
This is non-intuitive and the <code>mean</code> function should be replaced with
a <code>sum</code> to make the results more obvious.
</p>

<p>
This function is no longer in use and should probably be removed.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;"># </span><span style="color: #74af68;">FIXME:  This function is extremely brittle</span>
<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">rebin</span>(a,count):
    <span style="color: #e67128;">"""A quick function to rebin an array</span>

<span style="color: #e67128;">    This function takes an array and rebins it into a smaller array.</span>
<span style="color: #e67128;">    Note that, if the length of the array isn't divisible by the binning</span>
<span style="color: #e67128;">    factor, the end of the array will be truncated.  This is probably</span>
<span style="color: #e67128;">    not a sane default, but I don't have any better ideas.</span>

<span style="color: #e67128;">    Keyword arguments:</span>
<span style="color: #e67128;">    a -- The numpy array to be rebinned.</span>
<span style="color: #e67128;">    count -- The number of bins to be combined.  For instance, if the array</span>
<span style="color: #e67128;">             has a length of 100 and the count is 4, the return value</span>
<span style="color: #e67128;">             will have a length of 25</span>

<span style="color: #e67128;">    """</span>

    <span style="color: #ffad29; font-weight: bold;">return</span> np.array([a[i:i+count].mean() <span style="color: #ffad29; font-weight: bold;">for</span> i <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(0,<span style="color: #23d7d7;">len</span>(a),count)])
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-4-3" class="outline-4">
<h4 id="sec-3-4-3"><span class="section-number-4">3.4.3</span> Initialization</h4>
<div class="outline-text-4" id="text-3-4-3">
<p>
A <code>GraphPanel</code> object needs four parameters.  The first is the
<code>parent</code>, which holds the container in which the panel will be
displayed.  The second, <code>fig</code>, is a tuple with the relative
dimensions of the panel.  For instance, if <code>fig</code> is <code>(2,3)</code>, then
the panel will be two units wide and three units tall.  The <code>res</code>
parameter gives the number of pixels per unit for the dimensions
in <code>fig</code>.  Finally, the orientation is either
<code>GraphPanel.HORIZONTAL</code>, <code>GraphPanel.INVERTED</code>, or
<code>GraphPanel.VERTICAL</code>.  A <code>HORIZONTAL</code> gives a graph with the
x-axis along the bottom and the y-axis pointing up.  <code>VERTICAL</code>
has it's x-axis along the right edge and the y-axis pointing
left.  Finally, <code>INVERTED</code> has it's x-axis along the top and the
y-axis pointing downward.
</p>

<p>
Just as with the <code>[[Image Panel]]</code>, the object contains a matplotlib
<code>Figure</code> and a wxAgg <code>FigureCanvas</code> to do the actual plotting.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,parent,fig,res,orientation):
    <span style="color: #e67128;">"""Create a new panel for plotting.</span>

<span style="color: #e67128;">    Keyword Arguments:</span>
<span style="color: #e67128;">    parent -- the panel in which the new one is to be displayed</span>
<span style="color: #e67128;">    fig -- a tuple representing the relative dimensions of the panel</span>
<span style="color: #e67128;">    res -- the number of pixels per part of the fig tuple.</span>
<span style="color: #e67128;">    orientation -- the rotation of the image</span>

<span style="color: #e67128;">    fig and res combine to produce the total size, in pixels, of the</span>
<span style="color: #e67128;">    panel.  For instance, if fig=(2,8) and res=64, the final panel</span>
<span style="color: #e67128;">    has a size of (128,512)</span>

<span style="color: #e67128;">    The orientation can be one of HORIZONTAL, VERTICAL, or INVERTED,</span>
<span style="color: #e67128;">    as defined as constants in the class definition. Horitzontal uses</span>
<span style="color: #e67128;">    the standard x and y axes, and is best for putting above a 2d image.</span>
<span style="color: #e67128;">    VERTICAL swaps the x and y axes and is best for going to the right</span>
<span style="color: #e67128;">    of an image.  INVERTED plots with x and -y, and is best below the image.</span>

<span style="color: #e67128;">    """</span>
    wx.Panel.__init__(<span style="color: #ffad29; font-weight: bold;">self</span>,parent)
    <span style="color: #ffad29; font-weight: bold;">self</span>.Bind(wx.EVT_PAINT,<span style="color: #ffad29; font-weight: bold;">self</span>.__OnPaint)
    <span style="color: #74af68;">#</span><span style="color: #74af68;">The actual figure for plotting</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.figure = Figure(figsize=fig,dpi=res)
    <span style="color: #74af68;">#</span><span style="color: #74af68;">The space where th figure is drawn</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.canvas = FigureCanvas(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #ffad29; font-weight: bold;">self</span>.figure)
    <span style="color: #74af68;">#</span><span style="color: #74af68;">The rotation of the figure.</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.orientation=orientation
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-3-4-4" class="outline-4">
<h4 id="sec-3-4-4"><span class="section-number-4">3.4.4</span> Plotting</h4>
<div class="outline-text-4" id="text-3-4-4">
<p>
The <code>SetPlot</code> function gives the panel its data for plotting.
The first variable is an array of the x-coordinate and the second
is the y-coordinates.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">SetPlot</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,x,y):
    <span style="color: #e67128;">"""Set the x and y coordinates of the data to be plotted."""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.figure.clear()
    <span style="color: #ffad29; font-weight: bold;">self</span>.axes = <span style="color: #ffad29; font-weight: bold;">self</span>.figure.add_subplot(111)
    <span style="color: #74af68;">#</span><span style="color: #74af68;">We rebin the data in steps of four to smooth out the dead PMTs</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">If all of the PMTs have been fixed, this step could be taken out.</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.orientation==<span style="color: #ffad29; font-weight: bold;">self</span>.INVERTED:
        <span style="color: #ffad29; font-weight: bold;">self</span>.axes.fill_between(x,y)
        <span style="color: #ffad29; font-weight: bold;">self</span>.SetPos([0,0.1,1,0.9])
        <span style="color: #ffad29; font-weight: bold;">self</span>.axes.set_xlim((0,np.<span style="color: #23d7d7;">max</span>(x)))
        <span style="color: #74af68;">#</span><span style="color: #74af68;">Reverse the order of the limits to get an inverted graph</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.axes.set_ylim((np.<span style="color: #23d7d7;">max</span>(y),0))
    <span style="color: #ffad29; font-weight: bold;">elif</span> <span style="color: #ffad29; font-weight: bold;">self</span>.orientation==<span style="color: #ffad29; font-weight: bold;">self</span>.HORIZONTAL:
        <span style="color: #ffad29; font-weight: bold;">self</span>.axes.fill_between(x,y)
        <span style="color: #ffad29; font-weight: bold;">self</span>.SetPos([0.1,0.1,0.9,0.9])
        <span style="color: #ffad29; font-weight: bold;">self</span>.axes.set_xlim((0,np.<span style="color: #23d7d7;">max</span>(x)))
        <span style="color: #ffad29; font-weight: bold;">self</span>.axes.set_ylim((0,np.<span style="color: #23d7d7;">max</span>(y)))
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #74af68;">#</span><span style="color: #74af68;">Notice that we now fill along the x axis</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.axes.fill_betweenx(x,-y)
        <span style="color: #ffad29; font-weight: bold;">self</span>.SetPos([0.2,0,0.8,1])
        <span style="color: #ffad29; font-weight: bold;">self</span>.axes.set_ylim((0,128))

    <span style="color: #ffad29; font-weight: bold;">self</span>.axes.autoscale_view(<span style="color: #008b8b;">True</span>,<span style="color: #008b8b;">True</span>,<span style="color: #008b8b;">True</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.Refresh()
</pre>
</div>

<p>
The <code>SetPlot</code> function uses <code>SetPos</code> to move the graph around
within the panel.  We want the graph to extend across the whole
panel, but, by default, matplotlib takes some space for the
axes.  We use <code>SetPos</code> to tell matplotlib to only use the part of
the plot that contains the actual graph.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">SetPos</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,pos):
    <span style="color: #e67128;">"""Set the position of the graph within the panel.</span>

<span style="color: #e67128;">    This function take a four element array which marks the far</span>
<span style="color: #e67128;">    corners of the graph.  The coordinates are given as a fraction</span>
<span style="color: #e67128;">    of the size of the panel.  For instance, pos=[0,0.3333,1,0.6666]</span>
<span style="color: #e67128;">    would produce a graph that stretches across the panel in the x</span>
<span style="color: #e67128;">    direction, but only uses the middle third in the y direction.</span>
<span style="color: #e67128;">    You will probably need to play with these values in order to be </span>
<span style="color: #e67128;">    able to view the values of the axes on the plot.</span>

<span style="color: #e67128;">    """</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.axes.set_position(pos)
</pre>
</div>

<p>
We need to override the <code>OnPaint</code> event handler to tell the
<code>FigureCanvas</code> to redraw the graph every time the panel is
redrawn.
</p>

<div class="org-src-container">

<pre class="src src-python" id="graphpanel_onpaint"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__OnPaint</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""An event handler to tell the canvas to draw</span>
<span style="color: #e67128;">    when the panel is redrawn."""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.canvas.draw()
    event.Skip()
</pre>
</div>
</div>
</div>
</div>



<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> Image Panel</h3>
<div class="outline-text-3" id="text-3-5">
<p>
The Image Panel is a custom widget for displaying a 2D array of
data.  It forms the largest part of the graphical representation
of the data in PELVis.
</p>
</div>

<div id="outline-container-sec-3-5-1" class="outline-4">
<h4 id="sec-3-5-1"><span class="section-number-4">3.5.1</span> Image Panel Skeleton</h4>
<div class="outline-text-4" id="text-3-5-1">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #e67128;">"""This module contains classes which help in displaying 2D data</span>

<span style="color: #e67128;">This module currently contains one class: ImagePanel.  The imagePanel</span>
<span style="color: #e67128;">takes a 2D array and displays it as a color plot.</span>

<span style="color: #e67128;">"""</span>

<span style="color: #ffad29; font-weight: bold;">import</span> numpy <span style="color: #ffad29; font-weight: bold;">as</span> np

<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.backends.backend_wxagg <span style="color: #ffad29; font-weight: bold;">import</span> FigureCanvasWxAgg <span style="color: #ffad29; font-weight: bold;">as</span> FigureCanvas
<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.backends.backend_wx <span style="color: #ffad29; font-weight: bold;">import</span> NavigationToolbar2Wx
<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.figure <span style="color: #ffad29; font-weight: bold;">import</span> Figure
<span style="color: #ffad29; font-weight: bold;">import</span> matplotlib.cm <span style="color: #ffad29; font-weight: bold;">as</span> cm

<span style="color: #ffad29; font-weight: bold;">import</span> wx


<span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">__name__</span> == <span style="color: #e67128;">"__main__"</span>:
    <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Hello World"</span>;

<span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">ImagePanel</span>(wx.Panel):
    <span style="color: #e67128;">"""This class displays 2D data as a color plot"""</span>
    &lt;&lt;imagepanel_init&gt;&gt;

    &lt;&lt;imagepanel_events&gt;&gt;

    &lt;&lt;imagepanel_update&gt;&gt;


    &lt;&lt;imagepanel_saveImage&gt;&gt;

    &lt;&lt;imagepanel_copytoclipboard&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-5-2" class="outline-4">
<h4 id="sec-3-5-2"><span class="section-number-4">3.5.2</span> Initialization</h4>
<div class="outline-text-4" id="text-3-5-2">
<p>
The panel is constructed with a couple of arguments.  The first
is simply the parent frame where the image is to be displayed.
It then takes three callback functions.  The <code>posFunction</code>
callback is called every time the mouse is moved within the
panel.  The <code>setMin</code> function is called every time the user
performs a left click, which will set the upper left hand corner
of the region of interest.  Finally, the setMax function is
called every time the user performs a right click, which should
set the lower right corner of the region of interest.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,parent,posFunction=<span style="color: #008b8b;">None</span>,setMin=<span style="color: #008b8b;">None</span>,setMax=<span style="color: #008b8b;">None</span>):
    <span style="color: #e67128;">"""This creates an ImagePanel</span>

<span style="color: #e67128;">    Keyword arguments:</span>
<span style="color: #e67128;">    parent -- The container which will hold the panel</span>
<span style="color: #e67128;">    posFunction -- function to be updated with mouse position</span>
<span style="color: #e67128;">    setMin -- function to be called on left click</span>
<span style="color: #e67128;">    setMax -- function to be called on right click</span>

<span style="color: #e67128;">    """</span>
    wx.Panel.__init__(<span style="color: #ffad29; font-weight: bold;">self</span>,parent)
    <span style="color: #ffad29; font-weight: bold;">self</span>.Bind(wx.EVT_PAINT,<span style="color: #ffad29; font-weight: bold;">self</span>.__OnPaint)
    <span style="color: #ffad29; font-weight: bold;">self</span>.posFunction = posFunction<span style="color: #74af68;">#</span><span style="color: #74af68;">Function to call on mouse movement</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.setMin = setMin<span style="color: #74af68;">#</span><span style="color: #74af68;">Function to call on right click</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.setMax = setMax<span style="color: #74af68;">#</span><span style="color: #74af68;">Function to call on left click</span>
</pre>
</div>

<p>
The <code>figure</code> member is the actual matplotlib graph that displays
the detector image.  We set it to 512 pixels by 512 pixels, as
its easier to read than a true 128 pixel by 16 pixel plot. The
<code>FigureCanvas</code> is then the wxWidget which lets us embed the graph
into the window.  It's provided by the backend<sub>wxagg</sub> module from
matplotlib.
</p>

<p>
We bind the mouse events to three private member functions and
set the default spectrum to <code>spectral</code>.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span><span style="color: #74af68;">The figure which holds the graph</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.figure = Figure(figsize=(1,1),dpi=512)
    <span style="color: #74af68;">#</span><span style="color: #74af68;">The object where the graph is drawn</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.canvas = FigureCanvas(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #ffad29; font-weight: bold;">self</span>.figure)
    <span style="color: #ffad29; font-weight: bold;">self</span>.canvas.Bind(wx.EVT_MOTION,<span style="color: #ffad29; font-weight: bold;">self</span>.__OnMouseMove)
    <span style="color: #ffad29; font-weight: bold;">self</span>.canvas.Bind(wx.EVT_LEFT_UP,<span style="color: #ffad29; font-weight: bold;">self</span>.__OnMouseLeft)
    <span style="color: #ffad29; font-weight: bold;">self</span>.canvas.Bind(wx.EVT_RIGHT_UP,<span style="color: #ffad29; font-weight: bold;">self</span>.__OnMouseRight)

    <span style="color: #ffad29; font-weight: bold;">self</span>.cmap = cm.spectral<span style="color: #74af68;">#</span><span style="color: #74af68;">The color map for the graph</span>
</pre>
</div>

<p>
Finally, the <code>handlers</code> member is a dictionary of all of the
image file formats that wxWidgets knows for file encoding.  If
wxWidgets adds a new image file format, this dict will need to be
updated manually, but it's unlikely that they'll add any news
formats any time soon.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span><span style="color: #74af68;">Known file formats for saving images</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.handlers={u<span style="color: #e67128;">"BMP"</span>:wx.BITMAP_TYPE_BMP,
                    u<span style="color: #e67128;">"JPG"</span>:wx.BITMAP_TYPE_JPEG,
                    u<span style="color: #e67128;">"PNG"</span>:wx.BITMAP_TYPE_PNG,
                    u<span style="color: #e67128;">"PCX"</span>:wx.BITMAP_TYPE_PCX,
                    u<span style="color: #e67128;">"PNM"</span>:wx.BITMAP_TYPE_PNM,
                    u<span style="color: #e67128;">"TIF"</span>:wx.BITMAP_TYPE_TIF}
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-5-3" class="outline-4">
<h4 id="sec-3-5-3"><span class="section-number-4">3.5.3</span> Event Handling</h4>
<div class="outline-text-4" id="text-3-5-3">
<p>
When an event occurs, it calls the bound callback function with a
single <code>Event</code> object.  This event contains the information that
the callback needs to perform its duties (e.g. a mouse click
event will have the mouse position).  We can either eat the
event, which is the default, or pass the event on by calling
<code>event.Skip</code>.  This allows the event to trigger multiple
callbacks.
</p>

<p>
There are four events that we need to be able to handle.  The
simplest one is when the graphics need to be updated.  We force
the FigureCanvas to draw itself, then pass the event on to any
other handlers.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__OnPaint</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Event handler to redraw graph when panel is redrawn."""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.canvas.draw()
    event.Skip()
</pre>
</div>

<p>
The <code>OnMouseMove</code> function is bound to events triggered by the
mouse moving through the Image Panel.  The current position on
the 512 by 512 panel is converted back into the actual pixels in
the neutron data.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__OnMouseMove</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Event handler when the mouse moves over the graph"""</span>
    (x,y) = event.GetPosition()
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.posFunction <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>: <span style="color: #ffad29; font-weight: bold;">return</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.posFunction(x/32,y/4)
</pre>
</div>

<p>
<code>OnMouseLeft</code> is triggered by the user left clicking on the image
panel.  The position is then converted back to the raw detector
pixel and passed to the <code>setMin</code> function.  <code>OnMouseRight is
     identical, except the raw position is passed to =setMax</code>.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__OnMouseLeft</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Event handler for left clicking on the graph."""</span>
    (x,y) = event.GetPosition()
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.setMin <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>: 
        <span style="color: #008b8b;">None</span>
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #ffad29; font-weight: bold;">self</span>.setMin(x/32,y/4)
    event.Skip()

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__OnMouseRight</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Event handler for right clicking on the graph."""</span>
    (x,y) = event.GetPosition()
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.setMax <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>: 
        <span style="color: #008b8b;">None</span>
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #ffad29; font-weight: bold;">self</span>.setMax(x/32,y/4)
    event.Skip()
</pre>
</div>

<p>
While not strictly an event, the outer PELVis frame has a menu
event that will call <code>saveImage</code> to put the 
</p>
</div>
</div>

<div id="outline-container-sec-3-5-4" class="outline-4">
<h4 id="sec-3-5-4"><span class="section-number-4">3.5.4</span> Data Handling</h4>
<div class="outline-text-4" id="text-3-5-4">
<p>
The single most important part of the Image Panel is the <code>update</code>
function, which gives the Image Panel the data to display.  It
expects a 2d array of numbers, as well as a minimum and maximum
value (i.e. <code>vmin</code> and <code>vmax</code>) for the range on the numbers.  The
display is clamped to those values.
</p>

<p>
Currently, each pixel is drawn as a solid block of constant
color.  Changing the <code>interpolation</code> parameter of <code>imshow</code> from
='none'= to ='bicubic'= will create a much smoother transition,
but it will also be harder to identify the pixel boundaries.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">update</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,data,vmin=10,vmax=20):
    <span style="color: #e67128;">"""Change the dataset for the graph</span>

<span style="color: #e67128;">    Keyword arguments:</span>
<span style="color: #e67128;">    data -- 2D numpy array</span>
<span style="color: #e67128;">    vmin -- floor value for graphing</span>
<span style="color: #e67128;">    vmax -- ceiling value for graphing</span>

<span style="color: #e67128;">    """</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.data=data
    <span style="color: #ffad29; font-weight: bold;">self</span>.figure.clear()
    <span style="color: #ffad29; font-weight: bold;">self</span>.figure.add_axes((0,0,1,1),autoscale_on=<span style="color: #008b8b;">True</span>,frameon=<span style="color: #008b8b;">False</span>,yticks=[0,1],xticks=[0,1])
    <span style="color: #ffad29; font-weight: bold;">self</span>.figure.get_axes()[-1].get_xaxis().set_visible(<span style="color: #008b8b;">False</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.figure.get_axes()[-1].get_yaxis().set_visible(<span style="color: #008b8b;">False</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.figure.get_axes()[-1].imshow(data,cmap=<span style="color: #ffad29; font-weight: bold;">self</span>.cmap,vmin=vmin,vmax=vmax,aspect=<span style="color: #e67128;">"auto"</span>,interpolation=<span style="color: #e67128;">'none'</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.figure.canvas.draw()
    <span style="color: #ffad29; font-weight: bold;">self</span>.Refresh()
</pre>
</div>


<p>
The <code>saveImage</code> function takes the current display of the panel
and saves it to a file.  As a quick walk through, we begin by
creating an empty bitmap.  We then create a drawing context on
top of this bitmap, which allows wxWidgets to treat the bitmap as
though it were just more pixels on the screen.  We then tell the
canvas to draw into this context, as opposed to on the screen.
This buts the actual pixel information into the bitmap.  We then
take this bitmap, which is hardware dependent on the computer,
and turn it into a device independent Image.  This image is then
saved to a file.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">saveImage</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,path):
    <span style="color: #e67128;">"""Saves the graph to an image file"""</span>
    <span style="color: #dbdb95;">bitmap</span> = wx.EmptyBitmap(512,512,24)
    <span style="color: #dbdb95;">memdc</span> = wx.MemoryDC(bitmap)
    <span style="color: #ffad29; font-weight: bold;">self</span>.figure.canvas.draw(memdc)
    <span style="color: #dbdb95;">image</span> = wx.Bitmap.ConvertToImage(bitmap)
    image.SaveFile(path,<span style="color: #ffad29; font-weight: bold;">self</span>.handlers[path[-3:].encode(<span style="color: #e67128;">'ascii'</span>)])
</pre>
</div>

<p>
As similar procedure is used to copy the image into the
clipboard.  The only difference is that we create a
<code>BitmapDataObject</code> instead of an <code>Image</code>, since that's that the
clipboard expects.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">copyToClipboard</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #e67128;">"""Copies the image of the graph to the system Clipboard."""</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> wx.TheClipboard.Open():
        <span style="color: #dbdb95;">bitmap</span> = wx.EmptyBitmap(512,512,24)
        <span style="color: #dbdb95;">memdc</span> = wx.MemoryDC(bitmap)
        <span style="color: #ffad29; font-weight: bold;">self</span>.figure.canvas.draw(memdc)
        wx.TheClipboard.Clear()
        wx.TheClipboard.SetData(wx.BitmapDataObject(bitmap))
        wx.TheClipboard.Close()
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3-6" class="outline-3">
<h3 id="sec-3-6"><span class="section-number-3">3.6</span> Color Bar Panel</h3>
<div class="outline-text-3" id="text-3-6">
</div><div id="outline-container-sec-3-6-1" class="outline-4">
<h4 id="sec-3-6-1"><span class="section-number-4">3.6.1</span> Color Bar Skeleton</h4>
<div class="outline-text-4" id="text-3-6-1">
<p>
The skeleton for the color bar panel also handles the <a href="#sec-3-7">3.7</a> and the <i>Color Bar Picker</i>.  All three are used for displaying
and chosing a maping between an intensity and a color for display
of the 2D detector data.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #e67128;">"""Classes for handling color spectra</span>

<span style="color: #e67128;">This module implements a series of classes for handling the different color</span>
<span style="color: #e67128;">spectra produced by matplot lib.  The basic class is ColorBarPanel, which</span>
<span style="color: #e67128;">simply displays a given color map.  ActionColorbar subclasses ColorBarPanel</span>
<span style="color: #e67128;">to add simple click response abilities.  Finally, ColorBarPicker gives the</span>
<span style="color: #e67128;">user the ability to select any of the color maps that matplotlib is aware of.</span>
<span style="color: #e67128;">Note that ColorBarPicker takes time to render when it first loads, so care</span>
<span style="color: #e67128;">should be taken not to create one unless it's necessary and then to keep</span>
<span style="color: #e67128;">that same on for as long as possible.</span>

<span style="color: #e67128;">"""</span>

<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.backends.backend_wxagg <span style="color: #ffad29; font-weight: bold;">import</span> FigureCanvasWxAgg <span style="color: #ffad29; font-weight: bold;">as</span> FigureCanvas
<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.backends.backend_wx <span style="color: #ffad29; font-weight: bold;">import</span> NavigationToolbar2Wx
<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.figure <span style="color: #ffad29; font-weight: bold;">import</span> Figure
<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.colorbar <span style="color: #ffad29; font-weight: bold;">import</span> ColorbarBase
<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.colors <span style="color: #ffad29; font-weight: bold;">import</span> Normalize
<span style="color: #ffad29; font-weight: bold;">import</span> matplotlib.cm <span style="color: #ffad29; font-weight: bold;">as</span> cm

<span style="color: #ffad29; font-weight: bold;">import</span> wx

<span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">ColorBarPanel</span>(wx.Panel):
    <span style="color: #e67128;">"""Panel to display a ColorBar in a wxWidgets container."""</span>
    &lt;&lt;colorbarpanel_init&gt;&gt;    
    &lt;&lt;colorbarpanel_setrange&gt;&gt;
    &lt;&lt;colorbarpanel_setcmap&gt;&gt;
    &lt;&lt;colorbarpanel_update&gt;&gt;

    &lt;&lt;colorbarpanel_onpaint&gt;&gt;

&lt;&lt;actioncolorbar&gt;&gt;

&lt;&lt;colormappicker&gt;&gt;



<span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">__name__</span> == <span style="color: #e67128;">'__main__'</span>:
    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">printcmap</span>(cmap):
        <span style="color: #ffad29; font-weight: bold;">print</span>(cmap)

    app=wx.PySimpleApp()
    frame = ColorMapPicker(<span style="color: #008b8b;">None</span>,printcmap)
    frame.Show()
    app.MainLoop()
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-6-2" class="outline-4">
<h4 id="sec-3-6-2"><span class="section-number-4">3.6.2</span> Initialization</h4>
<div class="outline-text-4" id="text-3-6-2">
<p>
The color bar panel takes several parameters
</p>

<dl class="org-dl">
<dt> parent </dt><dd>The container for the panel
</dd>
<dt> cmap </dt><dd>A starting color bar for the panel
</dd>
<dt> fig </dt><dd>A tuple containing the dimensions of the panel in
arbitrary units.  For example, the value of (2,3) would
make the panel two units tall by three units wide.  The
default value is (1,10), which fits in with the layout of
the PELVis frame.
</dd>
<dt> res </dt><dd>The number of pixels per unit in fig.
</dd>
<dt> orientation </dt><dd>The direction along which the color bar's
spectrum is encoded.  If the value is the string
'vertical', the rainbow will progress from top
to bottom.  To have the rainbow move from left to
right, set the value to 'horizontal'.
</dd>
<dt> size </dt><dd>By default, matplotlib includes a scale on the color bar
panel.  This is useful along the axis of the rainbow,
but rather obviously useless in the other direction.
The size command picks a subset of the colorbar to
eliminate the extra axis.
</dd>
</dl>

<p>
As with other panels, the general framework is a matplotlib
<code>Figure</code> and a wxAgg <code>FigureCanvas</code> to provide the actual graphing
components. 
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,parent,cmap,fig=(1,10),
             res=64,orientation=<span style="color: #e67128;">'vertical'</span>,
             size=[0.05,0.025,.25,0.95]):
    <span style="color: #e67128;">"""Creates a ColorBarPanel.</span>

<span style="color: #e67128;">    Keyword arguments:</span>
<span style="color: #e67128;">    parent -- container which holds the panel.</span>
<span style="color: #e67128;">    cmap -- the color map to display in the color bar.</span>
<span style="color: #e67128;">            This should be a matplotlib cmap object</span>
<span style="color: #e67128;">    fig -- the relative width to height of the color bar</span>
<span style="color: #e67128;">    res -- the number of pixels per unit in fig</span>
<span style="color: #e67128;">    orientation -- the rotation of the color bar</span>
<span style="color: #e67128;">    size -- the position of the color bar in the panel</span>

<span style="color: #e67128;">    res and size combine to produce the actual size of the</span>
<span style="color: #e67128;">    panel in pixels.  For instance, with fig=(1,10) and res=64,</span>
<span style="color: #e67128;">    the panel will be 64 pixels wide and 640 pixels tall.</span>

<span style="color: #e67128;">    size is a four element array which marks the far</span>
<span style="color: #e67128;">    corners of the graph.  The coordinates are given as a fraction</span>
<span style="color: #e67128;">    of the size of the panel.  For instance, pos=[0,0.3333,1,0.6666]</span>
<span style="color: #e67128;">    would produce a graph that stretches across the panel in the x</span>
<span style="color: #e67128;">    direction, but only uses the middle third in the y direction.</span>
<span style="color: #e67128;">    The default value should allow the axes to be seen.</span>

<span style="color: #e67128;">    """</span>

    wx.Panel.__init__(<span style="color: #ffad29; font-weight: bold;">self</span>,parent)
    <span style="color: #ffad29; font-weight: bold;">self</span>.Bind(wx.EVT_PAINT,<span style="color: #ffad29; font-weight: bold;">self</span>.__OnPaint)

    <span style="color: #ffad29; font-weight: bold;">self</span>.figure = Figure(figsize=fig,dpi=res)<span style="color: #74af68;">#</span><span style="color: #74af68;">the actual plot</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">the object to display the plot</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.canvas = FigureCanvas(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #ffad29; font-weight: bold;">self</span>.figure)
    <span style="color: #74af68;">#</span><span style="color: #74af68;">the direction of the color bar</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.orientation=orientation
    <span style="color: #74af68;">#</span><span style="color: #74af68;">the color map to use</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.cmap=cmap
    <span style="color: #ffad29; font-weight: bold;">self</span>.vmin=0 <span style="color: #74af68;">#</span><span style="color: #74af68;">The minimum value on the color bar</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.vmax=18 <span style="color: #74af68;">#</span><span style="color: #74af68;">The maximum value on the color bar</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.size=size <span style="color: #74af68;">#</span><span style="color: #74af68;">The position of the color bar in the frame</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.update()
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-6-3" class="outline-4">
<h4 id="sec-3-6-3"><span class="section-number-4">3.6.3</span> Display</h4>
<div class="outline-text-4" id="text-3-6-3">
<p>
The <code>update</code> function replots thecolor bar.  This is necessary
after any of the parameters have changed.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">update</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #e67128;">"""Reacts to any changes in the objects members."""</span>
    <span style="color: #dbdb95;">axes</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.figure.add_axes(<span style="color: #ffad29; font-weight: bold;">self</span>.size)
    <span style="color: #dbdb95;">norm</span> = Normalize(vmin=<span style="color: #ffad29; font-weight: bold;">self</span>.vmin,vmax=<span style="color: #ffad29; font-weight: bold;">self</span>.vmax)
    <span style="color: #dbdb95;">colorbar</span> = ColorbarBase(axes,cmap=<span style="color: #ffad29; font-weight: bold;">self</span>.cmap,norm=norm,
                            orientation=<span style="color: #ffad29; font-weight: bold;">self</span>.orientation)
    <span style="color: #ffad29; font-weight: bold;">self</span>.Refresh()
</pre>
</div>

<p>
As with any graphical widget, we need to intercept the OnPaint
event to ensure that the graph is drawn onto the panel.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__OnPaint</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""An event handler to update the graph when the panel is redrawn."""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.canvas.draw()
    event.Skip()
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-6-4" class="outline-4">
<h4 id="sec-3-6-4"><span class="section-number-4">3.6.4</span> Configuration</h4>
<div class="outline-text-4" id="text-3-6-4">
<p>
The <code>setRange</code> function choses the domain over which the colarbar
will map values into colors.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">setRange</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,vmin,vmax):
    <span style="color: #e67128;">"""Set the range for the axes on the colorbar."""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.vmin=vmin
    <span style="color: #ffad29; font-weight: bold;">self</span>.vmax=vmax
</pre>
</div>

<p>
The <code>setCmap</code> function sets the color map for the panel.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">setCmap</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,cmap):
    <span style="color: #e67128;">"""Pick the colormap to display."""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.cmap = cmap
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-3-7" class="outline-3">
<h3 id="sec-3-7"><span class="section-number-3">3.7</span> Action Color Bar</h3>
<div class="outline-text-3" id="text-3-7">
<p>
The Action Color Bar is a color bar that also functions as a
button.  The class itself lives in the <a href="#sec-3-6-1">colorbar</a> module.  It's
primary purpose is to provide a clickable colorbar for the <i>picker</i>.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">ActionColorbar</span>(ColorBarPanel):
    <span style="color: #e67128;">"""A simplistic colorbar button</span>

<span style="color: #e67128;">    This class displays a colormap and returns the name of its colormap</span>
<span style="color: #e67128;">    to a given function when clicked on by the user.</span>

<span style="color: #e67128;">    """</span>
</pre>
</div>

<p>
The initialization is much simpler than for the <a href="#sec-3-6">Color Bar Panel</a>.
</p>
<dl class="org-dl">
<dt> parent </dt><dd>The container to hold the action color bar
</dd>
<dt> cmap </dt><dd>The actual color map for the color bar
</dd>
<dt> command </dt><dd>The function to be called when the color bar is clicked
</dd>
</dl>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,parent,cmap,command):
        <span style="color: #e67128;">"""Creates an ActionColorbar</span>

<span style="color: #e67128;">        Keyword arguments:</span>
<span style="color: #e67128;">        parent -- the container to hold the panel.</span>
<span style="color: #e67128;">        cmap -- a string naming a colormap.</span>
<span style="color: #e67128;">        command -- the function to run when the colormap is clicked.</span>

<span style="color: #e67128;">        """</span>
        <span style="color: #74af68;">#</span><span style="color: #74af68;">title attribute is needed by update, which is called by init</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.title=cmap<span style="color: #74af68;">#</span><span style="color: #74af68;">The title of the colormap</span>
        ColorBarPanel.__init__(<span style="color: #ffad29; font-weight: bold;">self</span>,parent,cm.get_cmap(cmap),fig=(5,1),orientation=<span style="color: #e67128;">'horizontal'</span>,size=[0,0,1,0.6])
        <span style="color: #ffad29; font-weight: bold;">self</span>.comm = command<span style="color: #74af68;">#</span><span style="color: #74af68;">The command to run on clicks</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.canvas.Bind(wx.EVT_LEFT_UP,<span style="color: #ffad29; font-weight: bold;">self</span>.__OnClick)
</pre>
</div>

<p>
The <code>update</code> function is identical to that of the regular Color Bar
Panel, except that a title has been added to the figure so that
it's possible to know the name of the color map being clicked.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">update</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
        <span style="color: #e67128;">"""Reacts to any changes in the objects members."""</span>
        <span style="color: #dbdb95;">axes</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.figure.add_axes(<span style="color: #ffad29; font-weight: bold;">self</span>.size,title=<span style="color: #ffad29; font-weight: bold;">self</span>.title)
        <span style="color: #dbdb95;">norm</span> = Normalize(vmin=<span style="color: #ffad29; font-weight: bold;">self</span>.vmin,vmax=<span style="color: #ffad29; font-weight: bold;">self</span>.vmax)
        <span style="color: #dbdb95;">colorbar</span> = ColorbarBase(axes,cmap=<span style="color: #ffad29; font-weight: bold;">self</span>.cmap,norm=norm,
                                orientation=<span style="color: #ffad29; font-weight: bold;">self</span>.orientation)
        <span style="color: #ffad29; font-weight: bold;">self</span>.Refresh()
</pre>
</div>

<p>
<code>__OnClick</code> is the event handler for when the user left clicks on
the action bar.  It calls the command using the current color map
as its only argument.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__OnClick</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
        <span style="color: #e67128;">"""Event handler to call self.comm when the panel is clicked."""</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.comm(<span style="color: #ffad29; font-weight: bold;">self</span>.cmap)
        event.Skip()
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-8" class="outline-3">
<h3 id="sec-3-8"><span class="section-number-3">3.8</span> Color Map Picker</h3>
<div class="outline-text-3" id="text-3-8">
<p>
The color map picker is a dialog box which presents all of the
color maps know to matplotlib and allows the user to chose one by
clicking on it.
</p>

<p>
Since it generates so many graphs (one for each color map), it can
take quite a while to load.  It's usually only generated the first
time that the user calls for it and is not regenerated as long as
the program runs.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">ColorMapPicker</span>(wx.Frame):
    <span style="color: #e67128;">"""A window for selecting a color map"""</span>
</pre>
</div>

<p>
The initialization takes only two parameters.  The first is a
parent window that the dialog will be attached to.  If the parent
is <code>None</code>, the picker will be the main application window.  The
second parameter expects a function that takes one string
argument.  Whenever the user clicks on a color map, this function
is called on the name of the color map.
</p>

<p>
The <code>cm.datad.keys</code> function returns a list of all of the color
maps known to matplotlib.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,parent,command):
        <span style="color: #e67128;">"""Creates a ColorMapPicker</span>

<span style="color: #e67128;">        Keyword arguments:</span>
<span style="color: #e67128;">        parent -- parent of this frame or None</span>
<span style="color: #e67128;">        command -- function to be called on the chosen colormap name</span>

<span style="color: #e67128;">        """</span>
        wx.Frame.__init__(<span style="color: #ffad29; font-weight: bold;">self</span>,parent,wx.ID_ANY,<span style="color: #e67128;">"Maps"</span>,size=(345,355))
        <span style="color: #dbdb95;">scroll</span> = wx.ScrolledWindow(<span style="color: #ffad29; font-weight: bold;">self</span>,-1)
        <span style="color: #dbdb95;">sizer</span> = wx.BoxSizer(wx.VERTICAL)
        <span style="color: #dbdb95;">keys</span> = cm.datad.keys()
        <span style="color: #74af68;">#</span><span style="color: #74af68;">Iterate through all of the colormap names</span>
        <span style="color: #ffad29; font-weight: bold;">for</span> key <span style="color: #ffad29; font-weight: bold;">in</span> keys[:]:
            sizer.Add(ActionColorbar(scroll,key,command))
            scroll.SetScrollbars(0,64,0,64)
        sizer.SetSizeHints(scroll)
        scroll.SetSizer(sizer)
        <span style="color: #ffad29; font-weight: bold;">self</span>.Bind(wx.EVT_CLOSE,<span style="color: #ffad29; font-weight: bold;">self</span>.__OnClose)
</pre>
</div>

<p>
Since the window takes so long to create, we don't want to recreate
it each time it is called for.  To this end, we're overriding the
Close event and ignoring it, simply hiding the window instead.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__OnClose</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
        <span style="color: #e67128;">"""Event handler for closing the window</span>

<span style="color: #e67128;">        Since the window takes so long to build and render, we</span>
<span style="color: #e67128;">        don't want to be forces to make a new one each time it's</span>
<span style="color: #e67128;">        closed, so we merely hide it when the user closes it."""</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.Hide()
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-9" class="outline-3">
<h3 id="sec-3-9"><span class="section-number-3">3.9</span> Graph Frame</h3>
<div class="outline-text-3" id="text-3-9">
<p>
The Graph Frame module provides a class for easily displaying 2D
line plots.  It's used by <a href="#sec-4-2">MonFile</a> and <a href="#sec-3-10">3.10</a> to give
information versus wavelength.
</p>

<p>
The frame largely serves the same purpose ad
matplotlib.pyplot.plot, but it works well with the wx backend that
we're using for the rest of the PelVis application and try to start
its own main loop.  If you're writing a console application that
just needs to draw a couple of graphs, you're better off just
working straight through matplotlib.
</p>
</div>

<div id="outline-container-sec-3-9-1" class="outline-4">
<h4 id="sec-3-9-1"><span class="section-number-4">3.9.1</span> GraphFrame Skeleton</h4>
<div class="outline-text-4" id="text-3-9-1">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #e67128;">"""Convenience classes for plotting data</span>

<span style="color: #e67128;">This module contains a single class, GraphFrame, which is used for easily</span>
<span style="color: #e67128;">plotting two dimensional data.  If other such convenience classes are</span>
<span style="color: #e67128;">ever to be written, they should be put into this module.</span>

<span style="color: #e67128;">"""</span>

<span style="color: #ffad29; font-weight: bold;">import</span> wx

<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.backends.backend_wxagg <span style="color: #ffad29; font-weight: bold;">import</span> FigureCanvasWxAgg <span style="color: #ffad29; font-weight: bold;">as</span> FigureCanvas
<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.backends.backend_wx <span style="color: #ffad29; font-weight: bold;">import</span> NavigationToolbar2Wx
<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib.figure <span style="color: #ffad29; font-weight: bold;">import</span> Figure

<span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">GraphFrame</span>(wx.Frame):
    <span style="color: #e67128;">"""</span>
<span style="color: #e67128;">    This class merges wxWidgets and matplotlib to produce an </span>
<span style="color: #e67128;">    independent frame which can display a two dimensional</span>
<span style="color: #e67128;">    plot fo arbitrary data.</span>

<span style="color: #e67128;">    """</span>
    <span style="color: #dbdb95;">ID_COPY</span> = 500
    &lt;&lt;graphframe_init&gt;&gt;

    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__PanelPaint</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
        <span style="color: #e67128;">"""Event handler to tell the canvas to </span>
<span style="color: #e67128;">        redraw when the window is drawn."""</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.canvas.draw()
        event.Skip()

    &lt;&lt;graphframe_oncopy&gt;&gt;

    &lt;&lt;graphframe_plot&gt;&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-9-2" class="outline-4">
<h4 id="sec-3-9-2"><span class="section-number-4">3.9.2</span> Initialization</h4>
<div class="outline-text-4" id="text-3-9-2">
<p>
#+end<sub>src</sub>
</p>

<p>
The frame begins with two parameters.  The first is a parent
window, which can be <code>None</code> to make this window independent.  The
second is an optional tital to display in the window's titlebar.
</p>

<p>
The constructor begins by performing the basic construction of a
frame and creating a panel with a custom paint handler. 
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,parent=<span style="color: #008b8b;">None</span>,title=<span style="color: #e67128;">""</span>):
    <span style="color: #e67128;">"""Creates a new frame for displaying graphs</span>

<span style="color: #e67128;">    Keyword arguments:</span>
<span style="color: #e67128;">    parent -- the parent frame of the new frame</span>
<span style="color: #e67128;">    title -- the title for the frame.  This is not the title</span>
<span style="color: #e67128;">             for the graph.</span>

<span style="color: #e67128;">    """</span>
    wx.Frame.__init__(<span style="color: #ffad29; font-weight: bold;">self</span>,parent,wx.ID_ANY,title)

    <span style="color: #ffad29; font-weight: bold;">self</span>.panel = wx.Panel(<span style="color: #ffad29; font-weight: bold;">self</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.panel.Bind(wx.EVT_PAINT,<span style="color: #ffad29; font-weight: bold;">self</span>.__PanelPaint)
</pre>
</div>

<p>
We add a menu bar purely to handle the <code>Copy</code> command.  We use this
to allow the user to copy the graph to the clipboard, saving the
effort of writing the image to a disk and loading it up in another
application.  Establishing the menu also bounds the copy command
to the <code>Ctrl-c</code> hotkey.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #dbdb95;">menubar</span> = wx.MenuBar()
    <span style="color: #dbdb95;">editmenu</span> = wx.Menu()
    editmenu.Append(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_COPY,<span style="color: #e67128;">"&amp;Copy\tCtrl-C"</span>,<span style="color: #e67128;">" Copy image to the clipboard"</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.Connect(<span style="color: #ffad29; font-weight: bold;">self</span>.ID_COPY,-1,wx.wxEVT_COMMAND_MENU_SELECTED,<span style="color: #ffad29; font-weight: bold;">self</span>.OnCopy)
    menubar.Append(editmenu,<span style="color: #e67128;">"&amp;Edit"</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.SetMenuBar(menubar)
</pre>
</div>

<p>
We create a matplotlib <code>Figure</code> and a wxAgg <code>FigureCanvas</code> to
handle the actual plotting.  The matplotlib wx backend also
provides a convenient Navigation Toolbar that is identical to the
one used by <code>pyplot.plot</code> and allows the user to scale and
translate the graph at will.  The toolbar also handles saving the
image to a file.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#   </span>

    <span style="color: #74af68;">#</span><span style="color: #74af68;">First, make the plotting figure.</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.figure = Figure()
    <span style="color: #74af68;">#</span><span style="color: #74af68;">Then give the figure somewhere to display.</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.canvas = FigureCanvas(<span style="color: #ffad29; font-weight: bold;">self</span>.panel,-1,<span style="color: #ffad29; font-weight: bold;">self</span>.figure)
    <span style="color: #74af68;">#</span><span style="color: #74af68;">Finally, make a Toolbar to adjust the canvas at runtime.</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.toolbar = NavigationToolbar2Wx(<span style="color: #ffad29; font-weight: bold;">self</span>.canvas)
    <span style="color: #ffad29; font-weight: bold;">self</span>.toolbar.Realize()
</pre>
</div>

<p>
Finally, everything is added to the panel and the sizers are set.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #dbdb95;">sizer</span> = wx.GridBagSizer()
    sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.canvas,pos=wx.GBPosition(1,0))
    sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.toolbar,pos=wx.GBPosition(0,0))
    sizer.SetSizeHints(<span style="color: #ffad29; font-weight: bold;">self</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.SetSizer(sizer)
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-3-9-3" class="outline-4">
<h4 id="sec-3-9-3"><span class="section-number-4">3.9.3</span> Image Export</h4>
<div class="outline-text-4" id="text-3-9-3">
<p>
The <code>plot</code> function handles actualling turning data points into a
graph.
</p>

<dl class="org-dl">
<dt> x </dt><dd>An array of the x-coordinates of the data
</dd>
<dt> y </dt><dd>An array of the y-coordinates of the data
</dd>
<dt> range </dt><dd>An optional tuple of the minimum and maximum y values
to plot.  Useful for handling things like flipping
ratios, where most of the values will probably be
around 30, but a low statistics data point out at 18 Å
will suddenly take the plot up to five million.  If the
range is <code>None</code>, then the graph will auto-scale
</dd>
<dt> xerr </dt><dd>An optional array of the uncertainties on the
x-coordinates.  If <code>None</code>, then no x errorbars are used.
</dd>
<dt> yerr </dt><dd>An optional array of the uncertainties of the
y-coordinates.  If =None, then no y errorbars are used.
</dd>
</dl>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">plot</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,x,y,<span style="color: #23d7d7;">range</span>=<span style="color: #008b8b;">None</span>,xerr=<span style="color: #008b8b;">None</span>,yerr=<span style="color: #008b8b;">None</span>):
    <span style="color: #e67128;">"""Plots 2D data in the frame</span>

<span style="color: #e67128;">    This method is the main workhorse of the class.  It plots</span>
<span style="color: #e67128;">    a line representing the x and y data, with optional errorbars.</span>

<span style="color: #e67128;">    Keyword arguments:</span>
<span style="color: #e67128;">    x -- numpy array of x coordinates</span>
<span style="color: #e67128;">    y -- numpy array of y corrdinates</span>
<span style="color: #e67128;">    range -- either a tuple with the minimum and maximum y values,</span>
<span style="color: #e67128;">             or None for autoscaling</span>
<span style="color: #e67128;">    xerr -- numpy array of the errors in the x direction</span>
<span style="color: #e67128;">    yerr -- numpy array of errors in the y direction</span>

<span style="color: #e67128;">    """</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.figure.clear()
    <span style="color: #dbdb95;">axes</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.figure.add_subplot(111)
    <span style="color: #ffad29; font-weight: bold;">print</span>(x.shape)
    <span style="color: #ffad29; font-weight: bold;">print</span>(y.shape)
    axes.errorbar(x,y,xerr=xerr,yerr=yerr)
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">range</span>==<span style="color: #008b8b;">None</span>:
        axes.autoscale_view(<span style="color: #008b8b;">True</span>,<span style="color: #008b8b;">True</span>,<span style="color: #008b8b;">True</span>)
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        (vmin,vmax)=<span style="color: #23d7d7;">range</span>
        axes.set_ylim(vmin,vmax)
        axes.autoscale_view(<span style="color: #008b8b;">True</span>,<span style="color: #008b8b;">True</span>,<span style="color: #008b8b;">False</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.Show()
</pre>
</div>

<p>
The <code>OnCopy</code> function is an event handler for the user requesting
that the graph be copied to the clipboard.  A new bitmap is made
that is the current size of the canvas.  The figure is then drawn
onto this bitmap and the bitmap is passed to the clipboard.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">OnCopy</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Copies the image of the graph to the system Clipboard"""</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> wx.TheClipboard.Open():
        <span style="color: #ffad29; font-weight: bold;">print</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.canvas.GetSize())
        <span style="color: #dbdb95;">w</span>,<span style="color: #dbdb95;">h</span>=<span style="color: #ffad29; font-weight: bold;">self</span>.canvas.GetSize()
        <span style="color: #dbdb95;">bitmap</span> = wx.EmptyBitmap(w,h,24)
        <span style="color: #dbdb95;">memdc</span> = wx.MemoryDC(bitmap)
        <span style="color: #ffad29; font-weight: bold;">self</span>.figure.canvas.draw(memdc)
        wx.TheClipboard.Clear()
        wx.TheClipboard.SetData(wx.BitmapDataObject(bitmap))
        wx.TheClipboard.Close()
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-3-10" class="outline-3">
<h3 id="sec-3-10"><span class="section-number-3">3.10</span> Spectrum Dialog</h3>
<div class="outline-text-3" id="text-3-10">
<p>
The Spectrum Dialog presents a dialog box to the user which
presents the user options on what they would like to do with the
spectrum information passed by PELVis.  The information can be
given custom wavelength binning and either plotted to the screen or
saved in an ASCII file.
</p>
</div>

<div id="outline-container-sec-3-10-1" class="outline-4">
<h4 id="sec-3-10-1"><span class="section-number-4">3.10.1</span> Spectrum Dialog Skeleton</h4>
<div class="outline-text-4" id="text-3-10-1">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #e67128;">"""Classes for dealing with neutron spectra</span>

<span style="color: #e67128;">This module contains a single class:  SpectrumDialog.  This dialog</span>
<span style="color: #e67128;">handles all of the options and parameters for creating spectrum</span>
<span style="color: #e67128;">plots of intensities and polarization.  This class also handles</span>
<span style="color: #e67128;">automated rebinning of data.</span>

<span style="color: #e67128;">"""</span>

<span style="color: #ffad29; font-weight: bold;">import</span> wx
<span style="color: #ffad29; font-weight: bold;">import</span> numpy <span style="color: #ffad29; font-weight: bold;">as</span> np
<span style="color: #ffad29; font-weight: bold;">from</span> graphframe <span style="color: #ffad29; font-weight: bold;">import</span> GraphFrame

<span style="color: #dbdb95;">RESOLUTION</span> = 400

<span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">SpectrumDialog</span>(wx.Dialog):
    <span style="color: #e67128;">"""A dialog to set the options on a spectrum plot"""</span>

    &lt;&lt;spectrumdialog_init&gt;&gt;
    &lt;&lt;spectrumdialog_setdata&gt;&gt;
    &lt;&lt;spectrumdialog_setscale&gt;&gt;
    &lt;&lt;spectrumdialog_setintensityrange&gt;&gt;

    &lt;&lt;spectrumdialog_onview&gt;&gt;

    &lt;&lt;spectrumdialog_onsave&gt;&gt;

    &lt;&lt;spectrumdialog_setmode&gt;&gt;

    &lt;&lt;spectrumdialog_autobinset&gt;&gt;

    &lt;&lt;spectrumdialog_autobin&gt;&gt;
    &lt;&lt;spectrumdialog_modefunctions&gt;&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-3-10-2" class="outline-4">
<h4 id="sec-3-10-2"><span class="section-number-4">3.10.2</span> Initialization</h4>
<div class="outline-text-4" id="text-3-10-2">
<p>
The only parameter for the constructor on the SpectrumDialog is
the parent frame for the dialog.  The constructor begins by
calling the constructor of its superclass to make the actual
dialog box.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,parent=<span style="color: #008b8b;">None</span>):
    <span style="color: #e67128;">"""Create a SpectrumDialog"""</span>
    wx.Dialog.__init__(<span style="color: #ffad29; font-weight: bold;">self</span>,parent,wx.ID_ANY,<span style="color: #e67128;">"Spectrum Options"</span>)
    <span style="color: #dbdb95;">sizer</span> = wx.GridBagSizer()
</pre>
</div>

<p>
The class has two members for the data.  <code>up</code> is the count of the
neutrons per wavelength bin in the spin up state and and <code>down</code> is
the count of the neutrons per wavelength bin in the spin down state.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.up = <span style="color: #008b8b;">None</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">The spin up data array</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.down = <span style="color: #008b8b;">None</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">The spin down data array</span>
</pre>
</div>

<p>
The <code>mode</code> member is a dictionary to convert between a mode string
sent by the application and the function which handles that form
of data.  The <code>calSpec</code> function should point to the current
processing function.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>

    <span style="color: #74af68;">#</span><span style="color: #74af68;">A dictionary of the available manipulations to perform</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">on the data before plotting it.</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.modes = {<span style="color: #e67128;">"up"</span>:<span style="color: #ffad29; font-weight: bold;">self</span>.spinUp,
                  <span style="color: #e67128;">"down"</span>:<span style="color: #ffad29; font-weight: bold;">self</span>.spinDown,
                  <span style="color: #e67128;">"polar"</span>:<span style="color: #ffad29; font-weight: bold;">self</span>.polar,
                  <span style="color: #e67128;">"flipping"</span>:<span style="color: #ffad29; font-weight: bold;">self</span>.flipping}
    <span style="color: #ffad29; font-weight: bold;">self</span>.calcSpec = <span style="color: #ffad29; font-weight: bold;">self</span>.spinUp <span style="color: #74af68;">#</span><span style="color: #74af68;">The current data manipulation function</span>
</pre>
</div>

<p>
Two buttons are added to the bottom of the dialog to allow the
user to either view the image on the screen or save the data to an
ASCII file.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>

    <span style="color: #dbdb95;">saveButton</span> = wx.Button(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">"Save Spectrum"</span>)
    <span style="color: #dbdb95;">viewButton</span> = wx.Button(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">"View Spectrum"</span>)
    viewButton.Bind(wx.EVT_BUTTON,<span style="color: #ffad29; font-weight: bold;">self</span>.onView)
    saveButton.Bind(wx.EVT_BUTTON,<span style="color: #ffad29; font-weight: bold;">self</span>.onSave)
</pre>
</div>

<p>
A single text box is added with the label "Minimum Percent
Error".  This label is horribly misleading and should be changed.
In auto-binning mode, it does allow the user to input the minimum
percentage error.  However, in fixed binning mode, the value is
used to the maximum number of bins.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>

    sizer.Add(wx.StaticText(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">"Minimum Percent Error"</span>),
              pos=wx.GBPosition(0,0), flag=wx.EXPAND)
    <span style="color: #74af68;">#</span><span style="color: #74af68;">An input box for the user's chosen percentage error</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.minerr = wx.TextCtrl(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">"10"</span>)
    sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.minerr,pos=wx.GBPosition(0,1), flag=wx.EXPAND)
</pre>
</div>

<p>
Three radio buttons allow the user to pick the binning mode.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#    </span>

    <span style="color: #74af68;">#</span><span style="color: #74af68;">A checkbox for whether the user wants the data autobinned</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.nobinrad = wx.RadioButton(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">"Raw Data"</span>,style=wx.RB_GROUP)
    <span style="color: #ffad29; font-weight: bold;">self</span>.autobinrad = wx.RadioButton(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">"Auto binning"</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.setbinrad = wx.RadioButton(<span style="color: #ffad29; font-weight: bold;">self</span>,-1,<span style="color: #e67128;">"Fixed Binning"</span>)
</pre>
</div>

<p>
Finally, everything needs to be added to the actual panel
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.nobinrad,wx.GBPosition(1,0),flag=wx.EXPAND)
    sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.autobinrad,wx.GBPosition(1,1),flag=wx.EXPAND)
    sizer.Add(<span style="color: #ffad29; font-weight: bold;">self</span>.setbinrad,wx.GBPosition(1,2),flag=wx.EXPAND)

    sizer.Add(saveButton,pos=wx.GBPosition(2,0),flag=wx.EXPAND)
    sizer.Add(viewButton,pos=wx.GBPosition(2,1),flag=wx.EXPAND)
    sizer.SetSizeHints(<span style="color: #ffad29; font-weight: bold;">self</span>)
    <span style="color: #ffad29; font-weight: bold;">self</span>.SetSizer(sizer)
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-3-10-3" class="outline-4">
<h4 id="sec-3-10-3"><span class="section-number-4">3.10.3</span> Configuration</h4>
<div class="outline-text-4" id="text-3-10-3">
<p>
The <code>setData</code> function gives the actual neutron count arrays to
the Spectrum Dialog.  If there is only one spin state, it is put
in the <code>up</code> member and the <code>down</code> member is set to none.  Since
both arrays are supposed to represent neutron counts, we set any
data points less than zero equal to zero, since you can't have a
negative count.  This prevents issues like having the polarization
go above one or the flipping ratio being negative.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">setData</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,up,down=<span style="color: #008b8b;">None</span>):
    <span style="color: #e67128;">"""Sets the spin up and spin down spectra.  Expects two numpys arrays"""</span>
    <span style="color: #ffad29; font-weight: bold;">del</span> <span style="color: #ffad29; font-weight: bold;">self</span>.up
    <span style="color: #ffad29; font-weight: bold;">del</span> <span style="color: #ffad29; font-weight: bold;">self</span>.down
    <span style="color: #dbdb95;">up</span>[up &lt; 0.0] = 0.0
    <span style="color: #ffad29; font-weight: bold;">if</span> down <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #dbdb95;">down</span>[down &lt; 0.0] = 0.0
    <span style="color: #ffad29; font-weight: bold;">self</span>.up=up
    <span style="color: #ffad29; font-weight: bold;">self</span>.down=down
</pre>
</div>

<p>
The array received by <code>setData</code> are normalized to monitor count.
The uscale and dscale variables are the total monitor counts in
the up and down states, respectively.  This allows us to recover
the raw counts so that we can calculate the uncertainties from the
counting statistics.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">setScale</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,up,down=<span style="color: #008b8b;">None</span>):
    <span style="color: #e67128;">"""Sets the scaling constants for the spin up and spin down states.</span>

<span style="color: #e67128;">    To calculate error, we need the raw neutron counts, not just the</span>
<span style="color: #e67128;">    monitor normalized ones.  This function accepts the monitor counts</span>
<span style="color: #e67128;">    used to do the initial scaling on the detector data, so that</span>
<span style="color: #e67128;">    the raw counts can be recalculated.</span>

<span style="color: #e67128;">    """</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.uscale=up
    <span style="color: #ffad29; font-weight: bold;">self</span>.dscale=down
</pre>
</div>

<p>
When the data is being plot, it can be helpful to clamp the range
of the plot.  The <code>setIntensityRange</code> function accepts a tuple
with the minimum and maximum values for the plot range.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">setIntensityRange</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #23d7d7;">range</span>):
    <span style="color: #e67128;">"""Set the minimum and maximum y axis for plotting"""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.vmin,<span style="color: #ffad29; font-weight: bold;">self</span>.vmax = <span style="color: #23d7d7;">range</span>
</pre>
</div>

<p>
Currently, the spectrum dialog supports plotting the spin up
intensity, the spin down intensity, the polarization, and the
flipping ratio, all versus wavelength.  The <code>setmode</code> function
choses the mode with one of the keys of the <code>modes</code> member and
adjust <code>calcSpec</code> accordingly.
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_setmode"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">setMode</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,mode):
    <span style="color: #e67128;">"""Chooses the calculation to perform on the data</span>

<span style="color: #e67128;">    Keyword arguments:</span>
<span style="color: #e67128;">    mode -- a string describing which function out of self.modes</span>
<span style="color: #e67128;">            should be performed on the data.</span>

<span style="color: #e67128;">    """</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.calcSpec = <span style="color: #ffad29; font-weight: bold;">self</span>.modes[mode]
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-10-4" class="outline-4">
<h4 id="sec-3-10-4"><span class="section-number-4">3.10.4</span> Buttons</h4>
<div class="outline-text-4" id="text-3-10-4">
<p>
The <code>onView</code> function is called when the user clicks on the <code>View</code>
button.  The actual data to plot is calculated by the <code>calcSpec</code>
function and then displayed by a <a href="#sec-3-9">GraphFrame object</a>.
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_onview"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">onView</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Display a graph of the spectrum."""</span>
    <span style="color: #dbdb95;">x</span>,<span style="color: #dbdb95;">y</span>,<span style="color: #dbdb95;">e</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.calcSpec()
    <span style="color: #dbdb95;">graph</span> = GraphFrame(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #e67128;">"Spectrum"</span>)
    graph.plot(x,y,<span style="color: #23d7d7;">range</span>=(<span style="color: #ffad29; font-weight: bold;">self</span>.vmin,<span style="color: #ffad29; font-weight: bold;">self</span>.vmax),yerr=e)
    <span style="color: #ffad29; font-weight: bold;">self</span>.Show(<span style="color: #008b8b;">False</span>)
</pre>
</div>


<p>
The <code>onSave</code> function is called when the user clicks on the <code>Save</code>
button.  The actual data to plot is calculated by the <code>calcSpec</code>
function and then written to a file of the user's choice.  The
file writing routine should probably be replaced by a numpy
savetxt function.
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_onsave"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">onSave</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,event):
    <span style="color: #e67128;">"""Save a graph of the spectrum to a file."""</span>
    <span style="color: #dbdb95;">x</span>,<span style="color: #dbdb95;">y</span>,<span style="color: #dbdb95;">e</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.calcSpec()
    <span style="color: #dbdb95;">dialog</span>=wx.FileDialog(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #e67128;">"Name the spectm file"</span>,
                         wildcard=<span style="color: #e67128;">"ASCII (dat)|*.dat"</span>,
                         style=wx.FD_SAVE|wx.FD_OVERWRITE_PROMPT)
    <span style="color: #ffad29; font-weight: bold;">if</span> dialog.ShowModal()==wx.ID_OK:
        <span style="color: #ffad29; font-weight: bold;">with</span> <span style="color: #23d7d7;">open</span>(dialog.GetPath(),<span style="color: #e67128;">"w"</span>) <span style="color: #ffad29; font-weight: bold;">as</span> stream:
            <span style="color: #ffad29; font-weight: bold;">for</span> i <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(<span style="color: #23d7d7;">len</span>(x)):
                stream.write(<span style="color: #e67128;">"%f\t%f\t%f\n"</span>%(x[i],y[i],e[i]))
    <span style="color: #ffad29; font-weight: bold;">self</span>.Show(<span style="color: #008b8b;">False</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-10-5" class="outline-4">
<h4 id="sec-3-10-5"><span class="section-number-4">3.10.5</span> Spectrum Modes</h4>
<div class="outline-text-4" id="text-3-10-5">
<p>
The <code>flipping</code> function presents the two spin states as a flipping
ration.  It begins by getting the binned data from autobinset.
Note that this means that, for auto-binned graphs, it is the
individual spin states who error have been minimized, not the
final flipping ratio.
</p>

<p>
    With the binned data, the flipping ratio and error are
    calculated.  Note that a small value is added to the denominator
    of the flipping ratio to prevent divide by zero errors.
#+end<sub>src</sub>
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_modefunctions"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">flipping</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #e67128;">"""Calculate the flipping ratio"""</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.down <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
        (x,u,d)=<span style="color: #ffad29; font-weight: bold;">self</span>.autobinset()
        <span style="color: #dbdb95;">y</span> = u/(d+1e-6)
        <span style="color: #dbdb95;">uerr</span> = np.sqrt(u*<span style="color: #ffad29; font-weight: bold;">self</span>.uscale)/<span style="color: #ffad29; font-weight: bold;">self</span>.uscale
        <span style="color: #dbdb95;">derr</span> = np.sqrt(d*<span style="color: #ffad29; font-weight: bold;">self</span>.dscale)/<span style="color: #ffad29; font-weight: bold;">self</span>.dscale
        <span style="color: #dbdb95;">e</span> = y*np.sqrt((uerr/u)**2+(derr/d)**2)
        <span style="color: #74af68;">#</span><span style="color: #74af68;">e = y * np.sqrt(1/(u + 1e-6)+1/(d + 1e-6))</span>
        <span style="color: #ffad29; font-weight: bold;">return</span> (x,y,e)
</pre>
</div>

<p>
The <code>polar</code> function is similar to <code>flipping</code>, except that the
polarization is calculated, instead of the flipping ratio.  In
this case, no value is added to the denominator.
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_modefunctions"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">polar</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #e67128;">"""Calculate the polarization"""</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.down <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Polar Spectrum"</span>
        (x,u,d)=<span style="color: #ffad29; font-weight: bold;">self</span>.autobinset()
        <span style="color: #74af68;">#</span><span style="color: #74af68;">print((x,u,d))</span>
        <span style="color: #dbdb95;">y</span> = (u-d)/(u+d)
        <span style="color: #dbdb95;">uerr</span> = np.sqrt(u/<span style="color: #ffad29; font-weight: bold;">self</span>.uscale)
        <span style="color: #dbdb95;">derr</span> = np.sqrt(d/<span style="color: #ffad29; font-weight: bold;">self</span>.dscale)
        <span style="color: #dbdb95;">e</span> = 2*np.sqrt(u**2*derr**2+d**2*uerr**2)/(u+d)**2
        <span style="color: #74af68;">#</span><span style="color: #74af68;">e = nerr/n*(1+abs(y))</span>
        <span style="color: #ffad29; font-weight: bold;">return</span> (x,y,e)
</pre>
</div>

<p>
The <code>spinUp</code> returns just the rebinned intensity of the spin up
state.  If there is only one spin state, then this is the mode
which should be used.
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_modefunctions"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">spinUp</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #e67128;">"""Calculate the spin up intensity"""</span>
    (x,y)=<span style="color: #ffad29; font-weight: bold;">self</span>.autobin(<span style="color: #ffad29; font-weight: bold;">self</span>.up*<span style="color: #ffad29; font-weight: bold;">self</span>.uscale,<span style="color: #ffad29; font-weight: bold;">self</span>.uscale)
    <span style="color: #ffad29; font-weight: bold;">return</span> (x,y,np.sqrt(y*<span style="color: #ffad29; font-weight: bold;">self</span>.uscale)/<span style="color: #ffad29; font-weight: bold;">self</span>.uscale)
</pre>
</div>

<p>
Finally, the <code>spinDown</code> function returns the rebinned intensity of
the spin down state.
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_modefunctions"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">spinDown</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #e67128;">"""Calculate the spin down intensity"""</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.down <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
        (x,y)=<span style="color: #ffad29; font-weight: bold;">self</span>.autobin(<span style="color: #ffad29; font-weight: bold;">self</span>.down*<span style="color: #ffad29; font-weight: bold;">self</span>.dscale,<span style="color: #ffad29; font-weight: bold;">self</span>.dscale)
        <span style="color: #ffad29; font-weight: bold;">return</span> (x,y,np.sqrt(y*<span style="color: #ffad29; font-weight: bold;">self</span>.dscale)/<span style="color: #ffad29; font-weight: bold;">self</span>.dscale)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-10-6" class="outline-4">
<h4 id="sec-3-10-6"><span class="section-number-4">3.10.6</span> Binning</h4>
<div class="outline-text-4" id="text-3-10-6">
<p>
There are currently two binning functions.  <code>autobin</code> handles the
binning of a single spin state and autobinset handles the binning
of two spin states.  Each function then uses conditionals to
handle the exact form of binning the user requested.  Honestly,
it's a terrible design and should be improved.
</p>
</div>

<ol class="org-ol"><li>Autobin<br  /><div class="outline-text-5" id="text-3-10-6-1">
<p>
The function takes two parameters
</p>

<dl class="org-dl">
<dt> up </dt><dd>The raw neutron count to be rebinned
</dd>
<dt> scale </dt><dd>The monitor counts for normalization
</dd>
</dl>

<p>
     The function begins by checking if any binning has even been
     requested.  If not, then it returns the normalized counts along
     with a wavelength spectrum.
#+end<sub>src</sub>
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_autobin"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">autobin</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,up,scale):
    <span style="color: #e67128;">"""Rebins one data array based on the user's chosen error</span>

<span style="color: #e67128;">    Keyword arguments:</span>
<span style="color: #e67128;">    up -- the array to be rebinned</span>
<span style="color: #e67128;">    scale -- the conversion factor used to normalize against monitor</span>

<span style="color: #e67128;">    """</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.nobinrad.GetValue():
        <span style="color: #ffad29; font-weight: bold;">return</span> (np.arange(0.0,RESOLUTION)*20.0/RESOLUTION,up/scale)
</pre>
</div>

<p>
The next case tested for is auto-binning.  It iterates through the
count array, adding the neutron events into <code>utot</code> and
incrementing the <code>count</code> since the last data point.  Once the
relative uncertainty on <code>utot</code> is less that the requested value,
the monitor normalized value of utot and the average of the
positions are added appended to the y and x axes, respectively.
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_autobin"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">elif</span> <span style="color: #ffad29; font-weight: bold;">self</span>.autobinrad.GetValue():
        <span style="color: #dbdb95;">x</span>=[]
        <span style="color: #dbdb95;">u</span>=[]
        <span style="color: #dbdb95;">count</span>=0
        <span style="color: #dbdb95;">utot</span>=0
        <span style="color: #74af68;">#</span><span style="color: #74af68;">The maximum percentage error in the spin up or spin down state</span>
        <span style="color: #dbdb95;">emax</span> = <span style="color: #23d7d7;">float</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.minerr.GetValue())/100.0
        <span style="color: #ffad29; font-weight: bold;">for</span> i <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(<span style="color: #23d7d7;">len</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.up)):
            <span style="color: #dbdb95;">utot</span> += up[i]
            <span style="color: #dbdb95;">uerr</span> = 1.0/np.sqrt(utot)
            <span style="color: #ffad29; font-weight: bold;">if</span> uerr &lt; emax:
                u.append(utot/scale/(count+1))
                x.append((i-0.5*count)*20.0/RESOLUTION)
                <span style="color: #dbdb95;">count</span> = 0
                <span style="color: #dbdb95;">utot</span>=0
            <span style="color: #ffad29; font-weight: bold;">else</span>:
                <span style="color: #dbdb95;">count</span> += 1
        <span style="color: #ffad29; font-weight: bold;">return</span> (np.array(x),np.array(u))
</pre>
</div>

<p>
Finally, if the user has selected fixed binning, then the numpy
<a href="http://docs.scipy.org/doc/numpy/reference/generated/numpy.array_split.html">array<sub>split</sub></a> function is used to split the neutron data into the
desired number of bins.  These subs arrays are then summed and
normalized to make the final, binned array.
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_autobin"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">elif</span> <span style="color: #ffad29; font-weight: bold;">self</span>.setbinrad.GetValue():
        <span style="color: #dbdb95;">count</span> = <span style="color: #23d7d7;">int</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.minerr.GetValue())
        <span style="color: #dbdb95;">x</span> = np.arange(0.0,RESOLUTION)*20.0/RESOLUTION
        <span style="color: #dbdb95;">x</span> = np.array([np.mean(y) <span style="color: #ffad29; font-weight: bold;">for</span> y <span style="color: #ffad29; font-weight: bold;">in</span> np.array_split(x,count)])
        <span style="color: #dbdb95;">u</span> = np.array([np.<span style="color: #23d7d7;">sum</span>(y)/scale <span style="color: #ffad29; font-weight: bold;">for</span> y <span style="color: #ffad29; font-weight: bold;">in</span> np.array_split(up,count)])
        <span style="color: #ffad29; font-weight: bold;">return</span> (x,u)
</pre>
</div>
</div>
</li>

<li>Autobinset<br  /><div class="outline-text-5" id="text-3-10-6-2">
<p>
<code>autobinset</code> is similar to <code>autobin</code>, except that it handles
having two spin states.  For the raw and fixed binning, this
doesn't have any effect, but it requires special handling for the
automated binning, since both data sets need to hxave the same
bins.
</p>


<p>
     Again, the function begins by simply returning the values if the
     raw binning has been request, since there is no actual
     calculations to perform.
#+end<sub>src</sub>
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_autobinset"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">autobinset</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #e67128;">"""Rebins both up and down data based on the user's chosen error."""</span>
    <span style="color: #dbdb95;">x</span>=[]
    <span style="color: #dbdb95;">u</span>=[]
    <span style="color: #dbdb95;">d</span>=[]
    <span style="color: #dbdb95;">count</span>=0 <span style="color: #74af68;">#</span><span style="color: #74af68;">number of channels combined since last binning</span>
    <span style="color: #dbdb95;">utot</span>=0 <span style="color: #74af68;">#</span><span style="color: #74af68;">counts in the up state</span>
    <span style="color: #dbdb95;">dtot</span>=0 <span style="color: #74af68;">#</span><span style="color: #74af68;">counts in the down state</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">If there's no chosen error bounds, just return the original data.</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.nobinrad.GetValue():
        <span style="color: #ffad29; font-weight: bold;">return</span> (np.arange(0.0,RESOLUTION)*20.0/RESOLUTION
                ,<span style="color: #ffad29; font-weight: bold;">self</span>.up,<span style="color: #ffad29; font-weight: bold;">self</span>.down)
</pre>
</div>

<p>
If actual calculations are to be involved, then the raw <code>up</code> and
<code>down</code> spin state counts are needed to find the uncertainties.
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_autobinset"><span style="color: #74af68;">#</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">If we're going any sort of binning, we'll need raw values</span>
    <span style="color: #dbdb95;">up</span>=<span style="color: #ffad29; font-weight: bold;">self</span>.up*<span style="color: #ffad29; font-weight: bold;">self</span>.uscale
    <span style="color: #dbdb95;">down</span>=<span style="color: #ffad29; font-weight: bold;">self</span>.down*<span style="color: #ffad29; font-weight: bold;">self</span>.dscale
</pre>
</div>

<p>
The handling of the automatic binning is similar to how it was in
<code>autobin</code>.  The only difference is that the uncertainties of both
the up and down states must be beneath the request relative value
before the bin gets added to the main list.
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_autobinset"><span style="color: #74af68;">#</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">Check for autobinning</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">self</span>.autobinrad.GetValue():
        <span style="color: #74af68;">#</span><span style="color: #74af68;">The maximum percentage error in the spin up or spin down state</span>
        <span style="color: #dbdb95;">emax</span> = <span style="color: #23d7d7;">float</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.minerr.GetValue())/100.0
        <span style="color: #ffad29; font-weight: bold;">for</span> i <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(<span style="color: #23d7d7;">len</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.up)):
            <span style="color: #dbdb95;">utot</span> += up[i]
            <span style="color: #dbdb95;">dtot</span> += down[i]
            <span style="color: #dbdb95;">uerr</span> = 1.0/np.sqrt(utot)<span style="color: #74af68;">#</span><span style="color: #74af68;">error in the up state</span>
            <span style="color: #dbdb95;">derr</span> = 1.0/np.sqrt(dtot)<span style="color: #74af68;">#</span><span style="color: #74af68;">error in the down state</span>
            <span style="color: #74af68;">#</span><span style="color: #74af68;">if the error is below the threshold, add the new data point</span>
            <span style="color: #ffad29; font-weight: bold;">if</span> uerr &lt;= emax <span style="color: #ffad29; font-weight: bold;">and</span> derr &lt;= emax:
                u.append(utot/<span style="color: #ffad29; font-weight: bold;">self</span>.uscale)
                d.append(dtot/<span style="color: #ffad29; font-weight: bold;">self</span>.dscale)
            <span style="color: #74af68;">#</span><span style="color: #74af68;">choose x as the center of the binned data</span>
                x.append((i-0.5*count)*20.0/RESOLUTION)
                <span style="color: #dbdb95;">i</span> = 0
                <span style="color: #dbdb95;">utot</span>=0
                <span style="color: #dbdb95;">dtot</span>=0
                <span style="color: #dbdb95;">count</span>=0
            <span style="color: #ffad29; font-weight: bold;">else</span>:
                <span style="color: #dbdb95;">count</span> += 1
        <span style="color: #ffad29; font-weight: bold;">return</span> (np.array(x),
                np.array(u),
                np.array(d))
</pre>
</div>

<p>
The handling of raw values is exactly identical to how it was
performed in <code>autobin</code>.
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_autobinset"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">elif</span> <span style="color: #ffad29; font-weight: bold;">self</span>.setbinrad.GetValue():
        <span style="color: #dbdb95;">count</span> = <span style="color: #23d7d7;">int</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.minerr.GetValue())
        <span style="color: #dbdb95;">x</span> = [np.mean(y) <span style="color: #ffad29; font-weight: bold;">for</span> y <span style="color: #ffad29; font-weight: bold;">in</span> 
             np.array_split(np.arange(0.0,RESOLUTION)*20.0/RESOLUTION,count)]
        <span style="color: #dbdb95;">u</span> = [np.<span style="color: #23d7d7;">sum</span>(y)/<span style="color: #ffad29; font-weight: bold;">self</span>.uscale <span style="color: #ffad29; font-weight: bold;">for</span> y <span style="color: #ffad29; font-weight: bold;">in</span> np.array_split(up,count)]
        <span style="color: #dbdb95;">d</span> = [np.<span style="color: #23d7d7;">sum</span>(y)/<span style="color: #ffad29; font-weight: bold;">self</span>.dscale <span style="color: #ffad29; font-weight: bold;">for</span> y <span style="color: #ffad29; font-weight: bold;">in</span> np.array_split(down,count)]
        <span style="color: #74af68;">#</span><span style="color: #74af68;">print((x,u,d))</span>
        <span style="color: #ffad29; font-weight: bold;">return</span> (np.array(x),
                np.array(u),
                np.array(d))
</pre>
</div>

<p>
Finally, there is an exception in case some future programmer has
added a radio button to the Spectrum Dialog without implementing
the binning option here.  It's not likely that this code will ever
be called, but it should exist for completeness.
</p>

<div class="org-src-container">

<pre class="src src-python" id="spectrumdialog_autobinset"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #ffad29; font-weight: bold;">raise</span> RuntimeException(<span style="color: #e67128;">"Need to Implement bullet choice!"</span>)
</pre>
</div>
</div>
</li></ol>
</div>
</div>

<div id="outline-container-sec-3-11" class="outline-3">
<h3 id="sec-3-11"><span class="section-number-3">3.11</span> Livewatch</h3>
<div class="outline-text-3" id="text-3-11">
<p>
<code>Livewatch.py</code> is a utility to display the polarization as it comes
in.  It takes two parameters at the command line.  The first is the
run number for the run.  The second is the current in triangle 1
for the runs which we wish to analyze.
</p>
</div>

<div id="outline-container-sec-3-11-1" class="outline-4">
<h4 id="sec-3-11-1"><span class="section-number-4">3.11.1</span> Livewatch skeleton</h4>
<div class="outline-text-4" id="text-3-11-1">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">import</span> numpy <span style="color: #ffad29; font-weight: bold;">as</span> np
<span style="color: #ffad29; font-weight: bold;">from</span> matplotlib <span style="color: #ffad29; font-weight: bold;">import</span> pyplot <span style="color: #ffad29; font-weight: bold;">as</span> plt
<span style="color: #ffad29; font-weight: bold;">import</span> matplotlib <span style="color: #ffad29; font-weight: bold;">as</span> mpl
<span style="color: #ffad29; font-weight: bold;">import</span> time
<span style="color: #ffad29; font-weight: bold;">from</span> reader <span style="color: #ffad29; font-weight: bold;">import</span> PelFile
<span style="color: #ffad29; font-weight: bold;">from</span> monfile <span style="color: #ffad29; font-weight: bold;">import</span> MonFile
<span style="color: #ffad29; font-weight: bold;">import</span> sys
<span style="color: #ffad29; font-weight: bold;">import</span> os.path
<span style="color: #ffad29; font-weight: bold;">import</span> xml.etree.ElementTree <span style="color: #ffad29; font-weight: bold;">as</span> ET
<span style="color: #ffad29; font-weight: bold;">import</span> HTMLParser
<span style="color: #ffad29; font-weight: bold;">import</span> json

<span style="color: #dbdb95;">RUN</span> = 32725
<span style="color: #dbdb95;">basedir</span> = <span style="color: #e67128;">"C:/userfiles/EXP011/"</span>
<span style="color: #dbdb95;">XMLNS</span> = <span style="color: #e67128;">"{http://neutrons.ornl.gov/SNS/DAS/runinfo_v4_3}"</span>
<span style="color: #dbdb95;">REBIN</span> = 4

plt.ion()

&lt;&lt;livewatch_spectrum&gt;&gt;
<span style="color: #dbdb95;">mpl.rcParams</span>[<span style="color: #e67128;">'interactive'</span>] = <span style="color: #008b8b;">True</span>

&lt;&lt;livewatch_manifestly&gt;&gt;
<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">spectra</span>(gen):
    <span style="color: #ffad29; font-weight: bold;">while</span> <span style="color: #008b8b;">True</span>:
        <span style="color: #23d7d7;">next</span> = gen.<span style="color: #23d7d7;">next</span>()
        <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">next</span> <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
            <span style="color: #ffad29; font-weight: bold;">yield</span> <span style="color: #008b8b;">None</span>
            <span style="color: #ffad29; font-weight: bold;">continue</span>
        <span style="color: #dbdb95;">i</span>,<span style="color: #dbdb95;">_</span>=<span style="color: #23d7d7;">next</span>
        <span style="color: #dbdb95;">s</span> = spectrum(i)
        <span style="color: #ffad29; font-weight: bold;">if</span> s <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
            <span style="color: #ffad29; font-weight: bold;">yield</span> <span style="color: #008b8b;">None</span>
        <span style="color: #ffad29; font-weight: bold;">else</span>:
            <span style="color: #dbdb95;">data</span>,<span style="color: #dbdb95;">counts</span>,<span style="color: #dbdb95;">manifest</span> = s
            <span style="color: #ffad29; font-weight: bold;">yield</span> data,counts,manifest
            <span style="color: #ffad29; font-weight: bold;">print</span> i
            <span style="color: #ffad29; font-weight: bold;">print</span>(manifest)
            <span style="color: #dbdb95;">i</span> += 1

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">filter</span>(gen,f):
    <span style="color: #23d7d7;">next</span> = gen.<span style="color: #23d7d7;">next</span>()
    <span style="color: #ffad29; font-weight: bold;">while</span> <span style="color: #008b8b;">True</span>:
        <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">next</span> <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
            <span style="color: #ffad29; font-weight: bold;">yield</span> <span style="color: #008b8b;">None</span>
        <span style="color: #ffad29; font-weight: bold;">else</span>:
            <span style="color: #ffad29; font-weight: bold;">if</span> f(<span style="color: #23d7d7;">next</span>):
                <span style="color: #ffad29; font-weight: bold;">yield</span> <span style="color: #23d7d7;">next</span>
        <span style="color: #23d7d7;">next</span> = gen.<span style="color: #23d7d7;">next</span>()

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">integrator</span>(gen):
    <span style="color: #dbdb95;">data</span> = np.zeros(400/REBIN)
    <span style="color: #dbdb95;">counts</span> = 0
    <span style="color: #ffad29; font-weight: bold;">while</span> <span style="color: #008b8b;">True</span>:
        <span style="color: #23d7d7;">next</span> = gen.<span style="color: #23d7d7;">next</span>()
        <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">next</span> <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
            <span style="color: #dbdb95;">data</span> += rebin(<span style="color: #23d7d7;">next</span>[0],REBIN)
            <span style="color: #dbdb95;">counts</span> += <span style="color: #23d7d7;">next</span>[1]
        <span style="color: #ffad29; font-weight: bold;">yield</span> data/counts,np.sqrt(data)/counts


<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">joiner</span>(gens):
    <span style="color: #ffad29; font-weight: bold;">while</span> <span style="color: #008b8b;">True</span>:
        <span style="color: #dbdb95;">streams</span> = [g.<span style="color: #23d7d7;">next</span>() <span style="color: #ffad29; font-weight: bold;">for</span> g <span style="color: #ffad29; font-weight: bold;">in</span> gens]
        <span style="color: #ffad29; font-weight: bold;">yield</span> streams

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">plotter</span>(source,count=1):
    <span style="color: #dbdb95;">xs</span> = np.arange(0,20,0.05*REBIN) 
    plt.figure(<span style="color: #e67128;">"Live Update"</span>)
    plt.ylim([-1,1])
    <span style="color: #dbdb95;">graphs</span> = [plt.errorbar(xs,np.zeros(400/REBIN),np.zeros(400/REBIN),marker=<span style="color: #e67128;">"o"</span>) <span style="color: #ffad29; font-weight: bold;">for</span> i <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(count)]
    <span style="color: #ffad29; font-weight: bold;">while</span> <span style="color: #008b8b;">True</span>:
        <span style="color: #dbdb95;">data</span>=source.<span style="color: #23d7d7;">next</span>()
        <span style="color: #ffad29; font-weight: bold;">for</span> g,d <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">zip</span>(graphs,data):
            <span style="color: #ffad29; font-weight: bold;">if</span> d <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
                g[0].set_ydata(d)
        plt.draw()
        plt.pause(5)

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">polarization</span>(up,down):
    <span style="color: #dbdb95;">up</span> = integrator(up)
    <span style="color: #dbdb95;">down</span> = integrator(down)
    <span style="color: #ffad29; font-weight: bold;">while</span> <span style="color: #008b8b;">True</span>:
        <span style="color: #dbdb95;">u</span> = up.<span style="color: #23d7d7;">next</span>()[0]
        <span style="color: #dbdb95;">d</span> = down.<span style="color: #23d7d7;">next</span>()[0]
        <span style="color: #ffad29; font-weight: bold;">yield</span> -1*(u-d)/(u+d)
        <span style="color: #74af68;">#</span><span style="color: #74af68;">yield d/u</span>

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">fullpol</span>(i,f):
    <span style="color: #dbdb95;">upstate</span> = <span style="color: #ffad29; font-weight: bold;">lambda</span> x: x[1][<span style="color: #e67128;">'Flipper'</span>] &lt; 0
    <span style="color: #dbdb95;">downstate</span> = <span style="color: #ffad29; font-weight: bold;">lambda</span> x: x[1][<span style="color: #e67128;">'Flipper'</span>] &gt; 0

    <span style="color: #dbdb95;">ups</span> = spectra(<span style="color: #23d7d7;">filter</span>(<span style="color: #23d7d7;">filter</span>(manifestly(i),upstate),f))
    <span style="color: #dbdb95;">downs</span> = spectra(<span style="color: #23d7d7;">filter</span>(<span style="color: #23d7d7;">filter</span>(manifestly(i),downstate),f))
    <span style="color: #ffad29; font-weight: bold;">return</span> polarization(ups,downs)

&lt;&lt;livewatch_rebin&gt;&gt;

<span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">__name__</span>==<span style="color: #e67128;">"__main__"</span>:

    lowcur = <span style="color: #ffad29; font-weight: bold;">lambda</span> x: x[1][<span style="color: #e67128;">'Triangle1'</span>] ==3
    midcur = <span style="color: #ffad29; font-weight: bold;">lambda</span> x: x[1][<span style="color: #e67128;">'Triangle1'</span>] ==9
    hicur = <span style="color: #ffad29; font-weight: bold;">lambda</span> x: x[1][<span style="color: #e67128;">'Triangle1'</span>] ==15

    start = <span style="color: #23d7d7;">int</span>(sys.argv[1])

    filters = [<span style="color: #ffad29; font-weight: bold;">lambda</span> x: x[1][<span style="color: #e67128;">'Triangle1'</span>] == <span style="color: #23d7d7;">float</span>(i) <span style="color: #ffad29; font-weight: bold;">for</span> i <span style="color: #ffad29; font-weight: bold;">in</span> sys.argv[2:]]

    polarizers = [fullpol(start,f) <span style="color: #ffad29; font-weight: bold;">for</span> f <span style="color: #ffad29; font-weight: bold;">in</span> filters]

    p = plotter(joiner(polarizers),count=<span style="color: #23d7d7;">len</span>(polarizers))
    plotter(p)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-3-11-2" class="outline-4">
<h4 id="sec-3-11-2"><span class="section-number-4">3.11.2</span> Low Level Functions</h4>
<div class="outline-text-4" id="text-3-11-2">
<p>
The livewatch<sub>spectrum</sub> function loads in the intensity spectrum and
uncertainty of a single run from its run number.  This code was copied
almost verbatim from <a href="#sec-5">5</a>.  The only major change is that a
dictionary containing the current values is also returned, allowing
for other functions to sort the data.
</p>

<div class="org-src-container">

<pre class="src src-python" id="livewatch_spectrum"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">spectrum</span>(run,mins=(0,0),maxs=(16,128),mask=<span style="color: #008b8b;">None</span>):
    <span style="color: #dbdb95;">eventfile</span> = basedir+<span style="color: #e67128;">"SESAME_%i/SESAME_%i"</span> % (run,run) + <span style="color: #e67128;">"_neutron_event.dat"</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">not</span> os.path.isfile(eventfile):
        <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #008b8b;">None</span>
    <span style="color: #dbdb95;">p</span> = PelFile(eventfile)
    <span style="color: #dbdb95;">mon</span> = MonFile(basedir+<span style="color: #e67128;">"SESAME_%i/SESAME_%i"</span> % (run,run) +<span style="color: #e67128;">"_bmon_histo.dat"</span>,<span style="color: #008b8b;">False</span>)
    <span style="color: #dbdb95;">up</span> = p.make1d(mins,maxs,mask)

    <span style="color: #dbdb95;">manifestFile</span> = basedir+<span style="color: #e67128;">"SESAME_%i/SESAME_%i"</span> % (run,run) + <span style="color: #e67128;">"_runinfo.xml"</span>

    <span style="color: #dbdb95;">text</span> = ET.parse(manifestFile).getroot().find(<span style="color: #e67128;">".//"</span>+XMLNS+<span style="color: #e67128;">"Notes"</span>).text
    <span style="color: #dbdb95;">text</span> = HTMLParser.HTMLParser().unescape(text)
    <span style="color: #dbdb95;">manifest</span> = json.loads(text)

    <span style="color: #ffad29; font-weight: bold;">return</span> up,np.<span style="color: #23d7d7;">sum</span>(mon.spec),manifest
</pre>
</div>

<p>
Livewatch has a function for rebinning numpy arrays.  It takes the
original arrays and a number giving how many of the original array
elements should be combined together in the new array.
</p>

<div class="org-src-container">

<pre class="src src-python" id="livewatch_rebin"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">rebin</span>(x,bins):
    <span style="color: #dbdb95;">result</span>=np.zeros(<span style="color: #23d7d7;">len</span>(x)/bins,dtype=np.float64)
    <span style="color: #ffad29; font-weight: bold;">for</span> b <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(bins):
        <span style="color: #dbdb95;">result</span> += x[b::bins]
    <span style="color: #ffad29; font-weight: bold;">return</span> result
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-3-11-3" class="outline-4">
<h4 id="sec-3-11-3"><span class="section-number-4">3.11.3</span> Generators</h4>
<div class="outline-text-4" id="text-3-11-3">
<p>
The main structure of livewatch is based around python
generators. Generators tend to come in three kinds
</p>

<dl class="org-dl">
<dt> Sources </dt><dd>A generator which produces a continuously updating list
of data.
</dd>
<dt> Pipes </dt><dd>A generator which reads from another generator, performs
some transformations on the results, and yields that
result.
</dd>
</dl>

<p>
There's another related kind of function that isn't a generator.
</p>
<dl class="org-dl">
<dt> Sinks </dt><dd>A function that reads through a generator and performs
actions based on the results, but doesn't perform pass data
to any higher level generators.
</dd>
</dl>
</div>

<ol class="org-ol"><li>Sources<br  /><div class="outline-text-5" id="text-3-11-3-1">
<p>
Manifestly starts with a single run number.  It then continuously
scans that directory, waiting for a monitor file to be written.  If
the monitor file exists, we know that the data acquisition system has
finished then run and we can continue.  If there is no new run, we
signal that information up the chain with a <code>None</code>.
</p>

<p>
Once the monitor file has been written, we read the runinfo file to
get the current data from the <code>Notes</code> heading.  This is turned into a
dictionary via json parsing.  The run number and manifest can then be
passed up the chain.  Finally, we increment the run number and return
to waiting for the new run to finish.
</p>

<p>
I also apologize for the stupid name.
</p>

<div class="org-src-container">

<pre class="src src-python" id="livewatch_manifestly"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">manifestly</span>(start):
    <span style="color: #dbdb95;">i</span> = start
    <span style="color: #ffad29; font-weight: bold;">while</span> <span style="color: #008b8b;">True</span>:
        <span style="color: #dbdb95;">manifestFile</span> = basedir+<span style="color: #e67128;">"SESAME_%i/SESAME_%i"</span> % (i,i) + <span style="color: #e67128;">"_runinfo.xml"</span>
        <span style="color: #dbdb95;">monitorFile</span> = basedir+<span style="color: #e67128;">"SESAME_%i/SESAME_%i"</span> % (i,i) + <span style="color: #e67128;">"_bmon_histo.dat"</span>
        <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #ffad29; font-weight: bold;">not</span> os.path.isfile(monitorFile):
            <span style="color: #74af68;">#</span><span style="color: #74af68;">If the monitor file hasn't been written, the run isn't</span>
            <span style="color: #74af68;">#</span><span style="color: #74af68;">done yet and we shouldnt' read it</span>
            <span style="color: #ffad29; font-weight: bold;">yield</span> <span style="color: #008b8b;">None</span>
        <span style="color: #ffad29; font-weight: bold;">else</span>:
            <span style="color: #ffad29; font-weight: bold;">try</span>:
                <span style="color: #dbdb95;">manifestFile</span> = basedir+<span style="color: #e67128;">"SESAME_%i/SESAME_%i"</span> % (i,i) + <span style="color: #e67128;">"_runinfo.xml"</span>

                <span style="color: #dbdb95;">text</span> = ET.parse(manifestFile).getroot().find(<span style="color: #e67128;">".//"</span>+XMLNS+<span style="color: #e67128;">"Notes"</span>).text
                <span style="color: #dbdb95;">text</span> = HTMLParser.HTMLParser().unescape(text)
                <span style="color: #dbdb95;">manifest</span> = json.loads(text)
                <span style="color: #ffad29; font-weight: bold;">yield</span> i,manifest
                <span style="color: #dbdb95;">i</span> += 1
            <span style="color: #ffad29; font-weight: bold;">except</span> <span style="color: #34cae2;">ValueError</span>:
                <span style="color: #ffad29; font-weight: bold;">yield</span> <span style="color: #008b8b;">None</span>
</pre>
</div>
</div>
</li></ol>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Utility Classes</h2>
<div class="outline-text-2" id="text-4">
<p>
This section is for libraries which are used by more than one part
of the system.  These are usually the modules which read and write
data files, as they are needed by both the GUI and command line applications.
</p>
</div>
<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Reader</h3>
<div class="outline-text-3" id="text-4-1">
<p>
The <code>reader</code> module handles reading and interpreting neutron event
files.  It's main purpose is to take a data file, which is a binary
record of events, and turn it into a histogram of events in space
and time.
</p>
</div>

<div id="outline-container-sec-4-1-1" class="outline-4">
<h4 id="sec-4-1-1"><span class="section-number-4">4.1.1</span> Reader Skeleton</h4>
<div class="outline-text-4" id="text-4-1-1">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #e67128;">"""This module contains classes for reading PEL files</span>

<span style="color: #e67128;">This module contains a single class: PelFile.  This class reads the header</span>
<span style="color: #e67128;">information and neutron data saved in PEL files.  more information about</span>
<span style="color: #e67128;">the format of these files can be found in the Lexitech PAPA Software Manual.</span>

<span style="color: #e67128;">"""</span>

<span style="color: #ffad29; font-weight: bold;">import</span> __future__

<span style="color: #ffad29; font-weight: bold;">import</span> struct
<span style="color: #74af68;">#</span><span style="color: #74af68;">import re</span>
<span style="color: #ffad29; font-weight: bold;">import</span> numpy <span style="color: #ffad29; font-weight: bold;">as</span> np

<span style="color: #ffad29; font-weight: bold;">from</span> time <span style="color: #ffad29; font-weight: bold;">import</span> clock
<span style="color: #ffad29; font-weight: bold;">from</span> collections <span style="color: #ffad29; font-weight: bold;">import</span> namedtuple

<span style="color: #dbdb95;">RESOLUTION</span> = 400

&lt;&lt;reader_mapim&gt;&gt;

<span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">PelFile</span>:
        <span style="color: #e67128;">"""Handles the data stored in PEL files"""</span>
        <span style="color: #dbdb95;">data</span> = np.ndarray(shape=(0),dtype=np.int64)<span style="color: #74af68;">#</span><span style="color: #74af68;">Raw detector data</span>

        &lt;&lt;reader_pelfile_init&gt;&gt;                

        &lt;&lt;reader_pelfile_parseHeader&gt;&gt;
        &lt;&lt;reader_pelfile_convertTime&gt;&gt;
        &lt;&lt;reader_pelfile_make3d&gt;&gt;
        &lt;&lt;reader_pelfile_spectrum&gt;&gt;


        &lt;&lt;reader_pelfile_statusfunc&gt;&gt;
        &lt;&lt;reader_pelfile_getgains&gt;&gt;


        &lt;&lt;reader_pelfile_readfileimage&gt;&gt;

        &lt;&lt;reader_pelfile_make1d&gt;&gt;
</pre>
</div>

<p>
There's some old test code for running the reader by itself.  This
code is old, out of date, and should be  removed.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">__name__</span>==<span style="color: #e67128;">"__main__"</span>:
        data = PelFile()

        data.readfileimage(<span style="color: #e67128;">"C:/Documents and Settings/adlwashi/Desktop/20091102101415-AM12.pel"</span>)
        <span style="color: #ffad29; font-weight: bold;">print</span>(<span style="color: #e67128;">"Read File"</span>)
        data.spectrum(<span style="color: #e67128;">"spectrum.txt"</span>)
        <span style="color: #74af68;">#</span><span style="color: #74af68;">print("Reverse Grey")</span>
        <span style="color: #74af68;">#</span><span style="color: #74af68;">data.reverseGrey()</span>
        <span style="color: #74af68;">#</span><span style="color: #74af68;">temp = set([data.fullGrayCode(i) for i in range(512)])</span>
        <span style="color: #74af68;">#</span><span style="color: #74af68;">for i in temp:</span>
        <span style="color: #74af68;">#        </span><span style="color: #74af68;">print "%03o" % i</span>
        <span style="color: #74af68;">#</span><span style="color: #74af68;">print(len(temp))</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-1-2" class="outline-4">
<h4 id="sec-4-1-2"><span class="section-number-4">4.1.2</span> Image Mapping</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
The TOF for each event is given as a count since the T<sub>0</sub> pulse,
where the each count is 100ns.  The convertTime function takes a
numpy array of counts and turns it into a wavelength into a
wavelength bin, where the bins are spaced by <code>20/RESOLUTION</code>.  For
instance, if RESOLUTION is 200 and the neutron has a 2 Angstrom
wavelength, then the bin is 20.
</p>

<p>
The relationship between TOF and wavelength is controlled almost
completely by the variables <code>distanceToG4</code> and
<code>distanceToDetector</code>.  This sum should be the distance, in meters,
from the neutron moderator to the Helium-3 detector.  The
<code>distanceToG4</code> variable is based on Jak doskow's drawings on how
far it should be from the neutron moderator to the exit of G4.
The actual distance to the detector can then be measured with a
tape measure.
</p>

<p>
According to Dave Baxter's measurements, there is an 860us delay
between the T0 signal and when the neutrons first start coming out
of the moderator.  This value is subtracted off of the times to
compensate.  This value should be checked occasionally to make
sure that it has not changed.  If you are seeing neutrons with
negative wavelengths, or if the proton pulse is not occuring at
zero angstroms, then this value needs to be changed.  The best way
of checking it is via the neutron monitor, as the proton flash is
quite visible in the output and the results are given in 50
microsecond bins.
</p>

<p>
<a id="convertTime" name="convertTime"></a>
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span><span style="color: #74af68;">Remember to use in-place operations to save on memory overhead</span>
<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">convertTime</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,timearr):
        <span style="color: #e67128;">"""Convert an array of TOF data into neutron wavelengths."""</span>
        <span style="color: #74af68;">#</span><span style="color: #74af68;">convert timearr into microseconds</span>
        <span style="color: #dbdb95;">timearr</span> *= 0.1 <span style="color: #74af68;">#</span><span style="color: #74af68;">Convert to microseconds</span>
        <span style="color: #74af68;">#</span><span style="color: #74af68;">convert timearr into wavelength</span>
        <span style="color: #dbdb95;">distanceToG4</span> = 3.7338+2.5297
        <span style="color: #dbdb95;">distanceToDetector</span> = 3.835 <span style="color: #74af68;">#</span><span style="color: #74af68;">FIXME</span>
        <span style="color: #dbdb95;">timearr</span> -= 860
        <span style="color: #dbdb95;">timearr</span> *= 3.956034e-7/(distanceToDetector+distanceToG4)/1e-10*1e-6*(RESOLUTION/20) <span style="color: #74af68;">#</span><span style="color: #74af68;">The last term is to handle fractional angstroms</span>
        <span style="color: #ffad29; font-weight: bold;">return</span> timearr
</pre>
</div>


<p>
The SNS software for the Helium-3 detector returns a set of
events.  Each even has a channel number, the distance along the
channel, and a time of flight.  However, each channel on our
detector has two tubes in series.  Thus, we need to convert the
position on the channel to the position on the tube and assign
the data to the right tube.
</p>

<p>
Paul wrote this code and it has some idiosyncratic behavior.  For
example, the test of 
</p>
<pre class="example">
0.5*ti!=int(0.5*ti)
</pre>
<p>
is really just a test to see if ti is odd or even.  It should
probably be replaced with a simple
</p>
<pre class="example">
ti%2==1
</pre>
<p>
which returns the same result for all values.  In fact, I have a
sneaking suspicion that the entire thing can be done through
numpy, eliminating the need for slow python loops, but I haven't
proved it yet.
</p>

<p>
The function takes a single input value, which is a 2D array of
neutron counts with dimensions <code>XDIM</code> x <code>YDIM</code>.  It returns an array
with dimensions <code>XDIMM</code> and <code>YDIMM</code>.  The <code>ZPAD</code> variable is used
to account for dead pixels at the top or bottom of the tubes.
The <code>maparray</code> variable gives the order of the tubes on the
detector.  This has been found by calibration, but it should be
checked periodically (e.g. biennially) to ensure that it's still accurate.
</p>

<p>
<a id="mapim" name="mapim"></a>
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">mapim</span>(imarray):
    <span style="color: #dbdb95;">XDIM</span>=8
    <span style="color: #dbdb95;">YDIM</span>=256
    <span style="color: #dbdb95;">XDIMIM</span>=16
    <span style="color: #dbdb95;">YDIMIM</span>=128
    <span style="color: #dbdb95;">ZPAD</span>=0
<span style="color: #74af68;">#    </span><span style="color: #74af68;">maparray=[2, 15, 1, 16, 4, 13, 3, 14, 6, 11, 5, 12, 8, 9, 7, 10]</span>
<span style="color: #74af68;">#    </span><span style="color: #74af68;">maparray =[2, 1, 4, 3, 6, 5, 8, 7, 10, 9, 12, 11, 14, 13, 16, 15]#Old July 2013</span>
<span style="color: #74af68;">#    </span><span style="color: #74af68;">maparray =[2, 1, 4, 3, 6, 5, 8, 7, 14, 10, 13, 12, 9, 11, 16, 15]# SESANS October 2013</span>
<span style="color: #74af68;">#    </span><span style="color: #74af68;">maparray =[2, 1, 4, 3, 6, 5, 8, 7, 14, 10, 13, 12, 9, 11, 16, 15]# SESANS July 2013</span>
    <span style="color: #dbdb95;">maparray</span> =[4, 3, 1, 2, 6, 5, 15, 16, 8, 13, 7, 14, 10, 11, 9, 12] <span style="color: #74af68;"># </span><span style="color: #74af68;">From tube mapping October 2013</span>
    <span style="color: #74af68;">#    </span><span style="color: #74af68;">maparray = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]</span>
<span style="color: #74af68;">#    </span><span style="color: #74af68;">maparray = [12, 9, 11, 14, 10, 7, 1, 2, 3, 4, 5, 6, 8, 13, 15, 16]</span>
<span style="color: #74af68;">#    </span><span style="color: #74af68;">maparray =[2, 1, 4, 3, 6, 15, 5, 16, 8, 7, 13, 14, 11, 12, 9, 10]</span>
<span style="color: #74af68;">#    </span><span style="color: #74af68;">maparray =[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16]</span>
    <span style="color: #dbdb95;">newimarray</span>=np.zeros((YDIMIM+ZPAD,XDIMIM))
    <span style="color: #ffad29; font-weight: bold;">for</span> i <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(<span style="color: #23d7d7;">len</span>(maparray)):
        <span style="color: #dbdb95;">ti</span>=maparray[i]
        <span style="color: #ffad29; font-weight: bold;">if</span> 0.5*ti!=<span style="color: #23d7d7;">int</span>(0.5*ti):
           <span style="color: #ffad29; font-weight: bold;">for</span> j <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(YDIMIM):
                <span style="color: #dbdb95;">tj</span>=j
                <span style="color: #ffad29; font-weight: bold;">if</span> ti&lt;9:
                    <span style="color: #dbdb95;">newimarray</span>[j+ZPAD,i]=imarray[YDIMIM-1-tj,(ti-1)/2]
                <span style="color: #ffad29; font-weight: bold;">else</span>:
                    <span style="color: #dbdb95;">newimarray</span>[j,i]=imarray[YDIMIM-1-tj,(ti-1)/2]
        <span style="color: #ffad29; font-weight: bold;">else</span>:
            <span style="color: #ffad29; font-weight: bold;">for</span> j <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(YDIMIM):
                <span style="color: #dbdb95;">tj</span>=j+YDIMIM
                <span style="color: #ffad29; font-weight: bold;">if</span> ti&lt;9:
                    <span style="color: #dbdb95;">newimarray</span>[j+ZPAD,i]=imarray[tj,ti/2-1]
                <span style="color: #ffad29; font-weight: bold;">else</span>:
                    <span style="color: #dbdb95;">newimarray</span>[j,i]=imarray[tj,ti/2-1]
    <span style="color: #ffad29; font-weight: bold;">return</span> newimarray
</pre>
</div>


<p>
The make3D function is the primary function for turning an array
of neutron events into a histogram of events versus position and
wavelength.
</p>

<p>
The data type is 64 bits per event.  The first 32 bits are the
TOF information, which can be turned into a wavelength by the
<a href="#convertTime">4.1.2</a> function.  The next 32 bits are the position
information.
</p>

<p>
We begin by setting some default variables.  The <code>statusfunc</code> is
a function that can be called with the current progress on
loading the file.  It expects a value between 0 and 1000, where 0
is having just started and 1000 means that the process is
complete.  The <code>cube</code> variable is the actual 3D array of neutron
events.  If there is no data in the file, we can immediately
return an empty array.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">make3d</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
        <span style="color: #e67128;">"""Make a 3D histogram from the raw data."""</span>
        <span style="color: #dbdb95;">start</span>=clock()                
        <span style="color: #dbdb95;">statusfunc</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.statusfunc
        <span style="color: #dbdb95;">l</span> = <span style="color: #23d7d7;">len</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.data)
        <span style="color: #dbdb95;">sd</span> =<span style="color: #ffad29; font-weight: bold;">self</span>.data
        <span style="color: #dbdb95;">i</span>=0;

        <span style="color: #dbdb95;">cube</span> = np.zeros([128,16,RESOLUTION],dtype=np.float32)

        <span style="color: #74af68;">#</span><span style="color: #74af68;">If there's no data, return an empty array</span>
        <span style="color: #ffad29; font-weight: bold;">if</span> l==0:
                <span style="color: #ffad29; font-weight: bold;">return</span> cube
</pre>
</div>

<p>
The 64-bit events are broken down into the 32-bit array of
position information, <code>Z</code>, and the 32-bit array of the time
information, <code>timearr</code>.  The time information is then converted
into a wavelength bin.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
        <span style="color: #dbdb95;">Z</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.data[1::2] &amp; 0xFFFF<span style="color: #74af68;">#</span><span style="color: #74af68;">position data</span>

        <span style="color: #dbdb95;">timearr</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.convertTime(np.asarray(<span style="color: #ffad29; font-weight: bold;">self</span>.data[0::2], \
                                              dtype=np.float64))<span style="color: #74af68;">#</span><span style="color: #74af68;">time data</span>
        <span style="color: #dbdb95;">timearr</span> = np.asarray(np.floor(timearr),np.uint16)
</pre>
</div>

<p>
a lot of this code used to purely work with integers.  As such,
numpy was set to <a href="http://docs.scipy.org/doc/numpy/reference/generated/numpy.seterr.html">raise an exception on integer overflow</a>.  This is
largely unnecessary now and could probably be removed.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
        <span style="color: #74af68;">#</span><span style="color: #74af68;">Loop over 20 angstroms in steps of 0.1 angstroms</span>
        np.seterr(over=<span style="color: #e67128;">'raise'</span>)
</pre>
</div>

<p>
It's possible to run the entire histogram calculation in a single
numpy call, which would actually be faster than the code below.
The problem is that the entire application would hang while the
calculation was performed, which leaves you wondering if
everything just crashed.  This slower version was implemented,
since it was easier to put in feedback as to how much time would
be left.
</p>

<p>
The function cycles through each time of flight bin.  The <code>place</code>
variable stores the indexes of events which fall into this time
of flight bin.  If there are any such events, then their position
information is histogrammed into a 1D array.  This array can then
be converted into a 2D array, since we know the number of
channels and the number of points per channel.  Finally, the
<a href="#mapim">4.1.2</a> function takes the point and channel numbers and returns a
2D array of position information.  Finally, this array is copied
into the appropriate wavelength bin in the <code>cube</code> array.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
        <span style="color: #ffad29; font-weight: bold;">for</span> i <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(RESOLUTION):
                <span style="color: #dbdb95;">place</span> = np.where(timearr==i)
                <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">len</span>(place[0]) &gt; 0:
                        <span style="color: #dbdb95;">temp</span>,<span style="color: #dbdb95;">_</span> = np.histogram(Z[place],bins = \
                                              np.arange(8*256+1))
                        <span style="color: #dbdb95;">temp</span> = temp.reshape(256,8,order=<span style="color: #e67128;">"F"</span>)
                        <span style="color: #dbdb95;">cube</span>[:,:,i] = mapim(temp)[::-1,:]
                statusfunc(i*1000.0/RESOLUTION)


        <span style="color: #dbdb95;">stop</span>=clock()
        <span style="color: #ffad29; font-weight: bold;">del</span> timearr

        <span style="color: #ffad29; font-weight: bold;">return</span> cube
</pre>
</div>

<p>
The <code>spectrum</code> member of the <code>PelFile</code> class allows the
wavelength spectrum of the entire file to be export to a text
file.  This code is old, unused, unmaintened, and poorly
written.  It should be deleted soon.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">spectrum</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,output):
        <span style="color: #e67128;">"""Save the neutron spectrum to a text file"""</span>
        <span style="color: #ffad29; font-weight: bold;">with</span> <span style="color: #23d7d7;">open</span>(output,<span style="color: #e67128;">'w'</span>) <span style="color: #ffad29; font-weight: bold;">as</span> of:
                <span style="color: #dbdb95;">timearr</span> = (<span style="color: #ffad29; font-weight: bold;">self</span>.data &gt;&gt; 32) &amp; 0x7FFFFFFF
                <span style="color: #dbdb95;">timearr</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.convertTime(timearr)
                <span style="color: #dbdb95;">timearr</span> /= 10

                <span style="color: #74af68;">#</span><span style="color: #74af68;">Get the spectrum and wavelengths</span>
                (spec,lmbda) = np.histogram(timearr,bins = \
                                            np.arange(2.0,50.0,0.1))
                <span style="color: #dbdb95;">hist</span> = np.column_stack((lmbda[1:],spec))
                <span style="color: #ffad29; font-weight: bold;">for</span> point <span style="color: #ffad29; font-weight: bold;">in</span> hist:
                        of.write(<span style="color: #e67128;">"%f %i\n"</span> % (point[0],point[1]))
                of.close()
                <span style="color: #ffad29; font-weight: bold;">return</span> (spec,lmbda)
</pre>
</div>

<p>
Many of the command line applications want to have the wavelength
spectrum without worrying about the position information.
<code>make1d</code> is the obvious analog of <code>make3d</code>.  It takes as
parameters two tuples of the minimum x and y values as well as
the maximum x and y values.  It will also take an optional 2D
array of booleans to indicate which pixels should be ignored.
The function then returns an array of the total neutron counts
per wavelength bin over the requested area of the detector.
</p>

<p>
Note that this code creates the full 3D histogram, then flattens
it down to a 1D array.  It'd be far more efficient to just create
the single array.  If you're looking to speed up make3d, it might
be a good idea to start with make1D and continue from there.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">make1d</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,mins,maxs,mask=<span style="color: #008b8b;">None</span>):
        <span style="color: #e67128;">"""Make a 1D histogram from the spectrum data."""</span>

        <span style="color: #dbdb95;">c</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.make3d()
        <span style="color: #ffad29; font-weight: bold;">if</span> mask <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
            <span style="color: #dbdb95;">xmin</span>,<span style="color: #dbdb95;">ymin</span> = mins
            <span style="color: #dbdb95;">xmax</span>,<span style="color: #dbdb95;">ymax</span> = maxs
            <span style="color: #dbdb95;">c</span> = c[ymin:ymax,xmin:xmax]
        <span style="color: #ffad29; font-weight: bold;">else</span>:
            <span style="color: #dbdb95;">c</span>[np.logical_not(mask)] = 0
        <span style="color: #ffad29; font-weight: bold;">return</span> np.<span style="color: #23d7d7;">sum</span>(np.<span style="color: #23d7d7;">sum</span>(c,axis=0,dtype=np.float64()),axis=0)
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-4-1-3" class="outline-4">
<h4 id="sec-4-1-3"><span class="section-number-4">4.1.3</span> Initialization</h4>
<div class="outline-text-4" id="text-4-1-3">
<p>
The constructor for the PelFile doesn't need to do much other than
load a file passed as a parameter.  If there is no file, we don't
want to do anything.
</p>

<div class="org-src-container">

<pre class="src src-python" id="reader_pelfile_init"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #23d7d7;">file</span>=<span style="color: #e67128;">""</span>):
        <span style="color: #e67128;">"""Create a PelFile"""</span>
        <span style="color: #ffad29; font-weight: bold;">if</span>(<span style="color: #23d7d7;">file</span>!=<span style="color: #e67128;">""</span>):
                <span style="color: #ffad29; font-weight: bold;">self</span>.readfileimage(<span style="color: #23d7d7;">file</span>)
</pre>
</div>

<p>
The PelFile comes with a defautl status function that doesn't do
anything.  This allows for PelFile to be manipulated without
needing to hook them into a framework to process the update
callbacks.
</p>

<div class="org-src-container">

<pre class="src src-python" id="reader_pelfile_statusfunc"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">statusfunc</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,x):
        <span style="color: #e67128;">"""Status update function</span>

<span style="color: #e67128;">        This function is called to tell other program components</span>
<span style="color: #e67128;">        the progress in loading the PelFile.  The progress is given</span>
<span style="color: #e67128;">        on a scale of 0 to 1000.  This function should be overwritten</span>
<span style="color: #e67128;">        by whatever function is loading the pel file to do what it</span>
<span style="color: #e67128;">        needs with the load time information.</span>

<span style="color: #e67128;">        """</span>
        <span style="color: #ffad29; font-weight: bold;">return</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-1-4" class="outline-4">
<h4 id="sec-4-1-4"><span class="section-number-4">4.1.4</span> File Reading</h4>
<div class="outline-text-4" id="text-4-1-4">
<p>
The original PEL file format used by the PAPA detector included a
256 byte header with metadate about the detector status during the
run.  This function would parse that information into a Python
<a href="https://docs.python.org/2/library/collections.html">namedTuple</a>, which is fairly similar to a standard struct.  With
the new Helium-3 detector, this code is no longer necessary or
useful.  It should not be called and could probably be deleted.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">parseHeader</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #23d7d7;">bytes</span>):
        <span style="color: #e67128;">"""Turn the Pel file header into structured data"""</span>
        <span style="color: #dbdb95;">Header</span> = namedtuple(
                <span style="color: #e67128;">'Header'</span>,
                <span style="color: #e67128;">"pel endian FileMajVer FileMinVer BytesPerSample "</span> +
                <span style="color: #e67128;">"SysHealth AppMajVer AppMinVer AppBetaVer LensPos "</span> +
                <span style="color: #e67128;">"DetectorName ProductNumber BitsPerCoord CanEnergy "</span> +
                <span style="color: #e67128;">"CanTime ADclockFrequ FirmMajVer FirmMinVer FirmBeta Serial "</span> +
                <span style="color: #e67128;">"AcquisitionMode CanAcqMode Shutter "</span> +
                <span style="color: #e67128;">"PAPAPowerSupplyVoltageCommand "</span> +
                <span style="color: #e67128;">"PAPAPowerSupplyVoltageCommandGain "</span> +
                <span style="color: #e67128;">"PAPAPowerSupplyVoltageCommandOffset "</span> +
                <span style="color: #e67128;">"PAPAPowerSupplyControlVoltageCommandGain "</span> +
                <span style="color: #e67128;">"PAPAPowerSupplyControlVoltageCommandOffset "</span> +
                <span style="color: #e67128;">"PAPAPowerSupplyVoltageEnable "</span> +
                <span style="color: #e67128;">"EnergyPowerSupplyVoltageCommand "</span> +
                <span style="color: #e67128;">"EnergyPowerSupplyVoltageCommandGain "</span> +
                <span style="color: #e67128;">"EnergyPowerSupplyVoltageCommandOffset "</span> +
                <span style="color: #e67128;">"EnergyPowerSupplyControlVoltageCommandGain "</span> +
                <span style="color: #e67128;">"EnergyPowerSupplyControlVoltageCommandOffset "</span> +
                <span style="color: #e67128;">"EnergyPowerSupplyVoltageEnable "</span> +
                <span style="color: #e67128;">"MCPPowerSupplyVoltageCommand "</span> +
                <span style="color: #e67128;">"MCPPowerSupplyVoltageCommandGain "</span> +
                <span style="color: #e67128;">"MCPPowerSupplyVoltageCommandOffset "</span> +
                <span style="color: #e67128;">"MCPPowerSupplyControlVoltageCommandGain "</span> +
                <span style="color: #e67128;">"MCPPowerSupplyControlVoltageCommandOffset "</span> +
                <span style="color: #e67128;">"MCPPowerSupplyVoltageEnable "</span> +
                <span style="color: #e67128;">"x1Gain x2Gain x3Gain x4Gain x5Gain x6Gain x7Gain x8Gain x9Gain x10Gain "</span> +
                <span style="color: #e67128;">"y1Gain y2Gain y3Gain y4Gain y5Gain y6Gain y7Gain y8Gain y9Gain y10Gain "</span> +
                <span style="color: #e67128;">"strobeGain EnergyGain ThresholdGain "</span>+
                <span style="color: #e67128;">"ADVoltageOffset ADAOffset ADBOffset ADCOffset ADDOffset "</span>+
                <span style="color: #e67128;">"StrobeTriggerMin StrobeTriggerMax StrobeEndEventFrac "</span> +
                <span style="color: #e67128;">"EnergyTriggerMin EnergyTriggerMax EnergyEndEventFrac "</span> +
                <span style="color: #e67128;">"ADAFillSampleIntervalLength ADDFillSampleIntervalLength "</span> +
                <span style="color: #e67128;">"GateCapturePolarity TimerResetEdgePolarity "</span> +
                <span style="color: #e67128;">"LeadTimer LagTimer Gray BitShift "</span> +
                <span style="color: #e67128;">"TemperatureSetPoint1 TemperatureSetPoint2 "</span> +
                <span style="color: #e67128;">"KP1 KP2 KI1 KI2 KD1 KD2 Temperature1 Temperature2 "</span> +
                <span style="color: #e67128;">"StrobePulseWidth "</span> +
                <span style="color: #e67128;">"Year Month Day Hour Minute Second"</span>)


        <span style="color: #23d7d7;">format</span> = <span style="color: #e67128;">"4s"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">header</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">" ?"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">endian  Note that this is currently ignored</span>
        (pelstring,endian) = struct.unpack(<span style="color: #23d7d7;">format</span>,<span style="color: #23d7d7;">bytes</span>[0:5])

        <span style="color: #ffad29; font-weight: bold;">if</span> endian:
                <span style="color: #23d7d7;">format</span> = <span style="color: #e67128;">"&gt;"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">big endian</span>
        <span style="color: #ffad29; font-weight: bold;">else</span>:
                <span style="color: #23d7d7;">format</span> = <span style="color: #e67128;">"&lt;"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">little endian</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"4s ?"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">header and endian</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Major version</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Minor Version</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Bytes per sample</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">System Health</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Application Software Major Version</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Application Software Minor Version</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Application Software Beta Version</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Lens focus position</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">" 40s "</span> <span style="color: #74af68;"># </span><span style="color: #74af68;">Detector Name</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;"># </span><span style="color: #74af68;">Product Number</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;"># </span><span style="color: #74af68;">Bits per coordinate</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Detector Energy Capability</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Detector Timing Capability</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">AD Clock Frequency</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Firmware Major Version</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Firmware Minor Version</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Firmware Beta Version</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Serial Number</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Acquisition Mode</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"I"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Acquisition Mode Capability</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Shutter State</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">PAPA PMT power supply voltage command</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">PAPA PMT power supply voltage gain</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">PAPA PMT power supply voltage command offset</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">PAPA PMT power supply control voltage command gain</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">PAPA PMT power supply control voltage command offsert</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">PAPA PMT power supply voltage enable</span>

        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Energy PMT power supply voltage command</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Energy PMT power supply voltage gain</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Energy PMT power supply voltage command offset</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Energy PMT power supply control voltage command gain</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Energy PMT power supply control voltage command offsert</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Energy PMT power supply voltage enable</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Intensifier MCP power supply voltage command</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Intensifier MCP power supply voltage gain</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Intensifier MCP power supply voltage command offset</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Intensifier MCP power supply control voltage command gain</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Intensifier MCP power supply control voltage command offsert</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Intensifier MCP power supply voltage enable</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">" 10H "</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">X Channel gains</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">" 10H "</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Y Channel gains</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Strobe PMT Channel Gain</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Energy PMT Channel Gain</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Threshold Channel Gain</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">AD Voltage Offset</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">AD Channel A Offset</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">AD Channel B Offset</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">AD Channel C Offset</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">AD Channel D Offset</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">PAPA Strobe Trigger min</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">PAPA Strobe Trigger max</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">PAPA Strobe end event fraction</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Energy Trigger min</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Energy Trigger max</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Energy end event fraction</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">AD A filter sample interval length</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">AD D filter sample interval length</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Gate Capture Polarity</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Timer reset edge Polarity</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Coincidence lead timer</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Coincidence lag timer</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Gray to binary conversion adder</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"B"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Binary big shift</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">" 2H "</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Zone temperature set point</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">" 2H "</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Zone KP Gain</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">" 2H "</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Zone KI Gain</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">" 2H "</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Zone KD Gain</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">" 2H "</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Zone temperature</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">strobe pulse width</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"39x"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">unused</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Year</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Month</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Day</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Hour</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Minute</span>
        <span style="color: #23d7d7;">format</span> += <span style="color: #e67128;">"H"</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Second</span>
        <span style="color: #dbdb95;">header</span> = Header._make(struct.unpack(<span style="color: #23d7d7;">format</span>,<span style="color: #23d7d7;">bytes</span>))
        <span style="color: #ffad29; font-weight: bold;">return</span> header
</pre>
</div>

<p>
The <code>getgains</code> function returns the signal amplification on the
photomultiplier tubes used to position detection on the PAPA
detector.  This is useful for trying to set the gains on the PMTs
automatically. If the data is coming from the Helium-3 detector, then
this function is worthless.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">getgains</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,h):
        <span style="color: #e67128;">"""Pulls the PMT gains information into a numpy array"""</span>
        <span style="color: #ffad29; font-weight: bold;">return</span> np.array([h.x1Gain,h.x2Gain,h.x3Gain,h.x4Gain,h.x5Gain,h.x6Gain,h.x7Gain,h.x8Gain,h.x9Gain,h.x10Gain,
                h.y1Gain,h.y2Gain,h.y3Gain,h.y4Gain,h.y5Gain,h.y6Gain,h.y7Gain,h.y8Gain,h.y9Gain,h.y10Gain],np.double)
</pre>
</div>

<p>
The <code>readfileimage</code> member loads the raw events from the data file
straight into memory.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">readfileimage</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,path):
        <span style="color: #e67128;">"""Reads a raw Pel File into memory."""</span>
        <span style="color: #dbdb95;">start</span>=clock()
        <span style="color: #dbdb95;">statusfunc</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.statusfunc
        <span style="color: #ffad29; font-weight: bold;">with</span> <span style="color: #23d7d7;">open</span>(path,<span style="color: #e67128;">"rb"</span>) <span style="color: #ffad29; font-weight: bold;">as</span> infile:
            <span style="color: #74af68;">#</span><span style="color: #74af68;">self.header = self.parseHeader(infile.read(256))</span>
            <span style="color: #74af68;">#</span><span style="color: #74af68;">Raw File has no header</span>
            <span style="color: #74af68;">#</span><span style="color: #74af68;">point = infile.read(8)</span>
            <span style="color: #ffad29; font-weight: bold;">self</span>.data = np.fromfile(infile,np.int32,-1)
        infile.close()
        <span style="color: #dbdb95;">stop</span>=clock()
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> MonFile</h3>
<div class="outline-text-3" id="text-4-2">
<p>
The <code>MonFile</code> class is used to read the files produced by the SNS
beam monitor software.
</p>
</div>

<div id="outline-container-sec-4-2-1" class="outline-4">
<h4 id="sec-4-2-1"><span class="section-number-4">4.2.1</span> MonFile Skeleton</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
The monfile package mostly consists of the MonFile class.  There
are, however, a couple of notes which are non-intuitive.  First,
monfile imports graphframe, so it's not suited for use on a
headless system.  In practice, that's not a big deal, but you
should be aware of it.  Also, monfile is one of the oldest parts
of PELVis and has quite a bit of cruft.  For instance, it imports
pylab, but it never uses it.  (That's probably a good thing, as you
shouldn't use pylab.)  I'll try to comment on the cruft as I pass
through, but you should pay attention.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #e67128;">"""Classes for dealing with neutron monitor data</span>

<span style="color: #e67128;">This module contains a single class: MonFile.  This class is used to read</span>
<span style="color: #e67128;">the time, intensity, and spectrum information out of a file produced</span>
<span style="color: #e67128;">by the SNS's BMM_server</span>

<span style="color: #e67128;">"""</span>

<span style="color: #ffad29; font-weight: bold;">import</span> numpy <span style="color: #ffad29; font-weight: bold;">as</span> np
<span style="color: #ffad29; font-weight: bold;">import</span> re
<span style="color: #ffad29; font-weight: bold;">import</span> scipy.interpolate <span style="color: #ffad29; font-weight: bold;">as</span> ip
<span style="color: #ffad29; font-weight: bold;">import</span> scipy.optimize <span style="color: #ffad29; font-weight: bold;">as</span> op
<span style="color: #ffad29; font-weight: bold;">import</span> matplotlib.pyplot <span style="color: #ffad29; font-weight: bold;">as</span> pyplot
<span style="color: #ffad29; font-weight: bold;">from</span> graphframe <span style="color: #ffad29; font-weight: bold;">import</span> GraphFrame
<span style="color: #ffad29; font-weight: bold;">import</span> pylab <span style="color: #ffad29; font-weight: bold;">as</span> pl
<span style="color: #ffad29; font-weight: bold;">import</span> math

<span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">MonFile</span>:
    <span style="color: #e67128;">"""Manages a file which holds neutron monitor data."""</span>
    <span style="color: #dbdb95;">KbT</span> = 2.0e-3

    &lt;&lt;monfile_init&gt;&gt;

    &lt;&lt;monfile_converttime&gt;&gt;

    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">func</span>(<span style="color: #ffad29; font-weight: bold;">self</span>, x, A, b, k, c):
        <span style="color: #ffad29; font-weight: bold;">return</span> A*x**2 * np.exp(-(x-k)**2*b) + c

    &lt;&lt;monfile_load&gt;&gt;
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-2-2" class="outline-4">
<h4 id="sec-4-2-2"><span class="section-number-4">4.2.2</span> Initialization</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
The constructor has two, optional parameters.  The first is a file
name, which can cause that file to be loaded into memory.  The
second is a boolean which declares whether we want a graph of the
monitor spectrum to be displayed on the screen.
</p>

<p>
The constructor declares two members.  The first is <code>time</code>, which
is no longer used.  Under the old PAPA data collection system, the
monitor files were stored in ASCII format and included the run
time in microseconds.  This information could then be used for certain kinds
of background subtraction and normalization.  However, the monitor
files produces by the SNS software are binary arrays of floating
points and do not have the time information, so it is no longer
included.
</p>

<p>
The other member, <code>spec</code>, stores an array of the monitor counts
per TOF bin.  This array is the primary purpose of the class.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #23d7d7;">file</span>=<span style="color: #008b8b;">None</span>,plot=<span style="color: #008b8b;">True</span>):
    <span style="color: #e67128;">"""Creates a MonFile object"""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.time = <span style="color: #008b8b;">None</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">The amount of time that the monitor ran.</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.spec = <span style="color: #008b8b;">None</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">The neutron spectrum detected on the monitor.</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">file</span> <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #ffad29; font-weight: bold;">self</span>.load(<span style="color: #23d7d7;">file</span>,plot)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4-2-3" class="outline-4">
<h4 id="sec-4-2-3"><span class="section-number-4">4.2.3</span> File Loading</h4>
<div class="outline-text-4" id="text-4-2-3">
<p>
The SNS software saves an array of 50,000 32 bit integers
representing the counts in each time of flight bin.  Each bin
represents 1us, so the 50,000 bins give 50ms, which corresponds to
our 20Hz pulse rate.
</p>

<p>
The main parts of the code are at the beginning of the class.
numpy loads the neutron spectrum from the SNS data file with the
<code>fromfile</code> function.  With the exception of the last line, every
other part of the function is dedicated to displaying the graph
and has no result on the actual data analysis.
</p>

<p>
The <code>x</code> variable is used to store the wavelenghts for the neutron
counts in <code>y</code>.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">load</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #23d7d7;">file</span>,plot=<span style="color: #008b8b;">True</span>):
    <span style="color: #e67128;">"""Load data from the file given in the path string."""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.time = -1
    <span style="color: #dbdb95;">base</span> = 0.1
    <span style="color: #dbdb95;">count</span> = 0
    <span style="color: #dbdb95;">uplim</span> = 31

    <span style="color: #dbdb95;">y</span> = np.fromfile(<span style="color: #23d7d7;">file</span>,np.int32,-1)
    <span style="color: #dbdb95;">x</span> = np.arange(0,50001,1,dtype=np.float32)
    <span style="color: #dbdb95;">x</span> = <span style="color: #ffad29; font-weight: bold;">self</span>.convertTime(x)
</pre>
</div>

<p>
The <code>xs</code> and <code>ys</code> arrays are made to rebin the data from x and y.
The code cycles through each data point and adds the data from <code>y</code>
into the corresponding bin in <code>ys</code>.  The <code>base</code> variable is used
to keep track of the current position in ys.
</p>

<p>
Note that this binning algorithm is incredibly slow and should
probably be replaced.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">f = ip.interp1d(x,y)</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">p0 = [10., 0.0001, 10000., 2.]</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">p1, cov = op.curve_fit(self.func, x, y, p0)</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">print(p1)</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">p1f = self.func(x, *p1) #Fit of neutron monitor</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">xs = range(200)</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">xs = np.arange(0,35,0.1)</span>
    <span style="color: #74af68;">#</span><span style="color: #74af68;">ys = np.zeros(350,dtype=np.uint32)</span>

    <span style="color: #dbdb95;">xs</span> = np.arange(0,uplim,base)
    <span style="color: #dbdb95;">ys</span> = np.zeros(uplim/base,dtype=np.uint32)

    <span style="color: #ffad29; font-weight: bold;">for</span> (i,j) <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">zip</span>(x,y):
        <span style="color: #ffad29; font-weight: bold;">if</span> i &gt; base:
            <span style="color: #dbdb95;">ys</span>[<span style="color: #23d7d7;">int</span>(10*base-1)]=count
            <span style="color: #dbdb95;">base</span> += 0.1
            <span style="color: #dbdb95;">count</span> = 0
        <span style="color: #dbdb95;">count</span> += j
    <span style="color: #dbdb95;">base</span> = 0.1
    <span style="color: #dbdb95;">count</span> = 0
    <span style="color: #dbdb95;">uplim</span> = 31
</pre>
</div>

<p>
ymean is supposed to find the background level by looking at the
count rate of the neutron between 25 Å and 30 Å, but it only seems
to be used in <code>ynew</code>, which is never used again.  In practice, the
noise on the neutron monitor is low enough that this really
shouldn't be necessary.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #dbdb95;">ymean</span> = np.mean(ys[250:300])
    <span style="color: #dbdb95;">ynew</span> = np.array([<span style="color: #23d7d7;">float</span>(yo)-ymean*(uplim/base)/50001 <span style="color: #ffad29; font-weight: bold;">for</span> yo <span style="color: #ffad29; font-weight: bold;">in</span> y])
</pre>
</div>

<p>
The results are rebinned again for reasons that I honestly cannot
fathom at this point.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #dbdb95;">ysnew</span> = np.zeros(uplim/base,dtype=np.float32)
    <span style="color: #ffad29; font-weight: bold;">for</span> (i,j) <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">zip</span>(x,ynew):
        <span style="color: #ffad29; font-weight: bold;">if</span> i &gt; base:
            <span style="color: #dbdb95;">ysnew</span>[<span style="color: #23d7d7;">int</span>(10*base-1)]=count
            <span style="color: #dbdb95;">base</span> += 0.1
            <span style="color: #dbdb95;">count</span> = 0
        <span style="color: #dbdb95;">count</span> += j
</pre>
</div>

<p>
Finally, the results are plotted.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> plot:
        <span style="color: #dbdb95;">graph</span> = GraphFrame(<span style="color: #008b8b;">None</span>,<span style="color: #e67128;">"Monitor"</span>)
        <span style="color: #dbdb95;">graph2</span> = GraphFrame(<span style="color: #008b8b;">None</span>,<span style="color: #e67128;">"Monitor Adjusted"</span>)
    <span style="color: #74af68;">#        </span><span style="color: #74af68;">graph.plot(np.arange(0.0,20.0,0.1),f(xs))</span>
    <span style="color: #74af68;">#    </span><span style="color: #74af68;">graph.plot(xs,ys)</span>
        graph2.plot(xs,ysnew)
</pre>
</div>

<p>
The final, but most important step, is to store the monitor
spectrum in the class.  The <code>expand_dims</code> function is used to turn
a 1D array with fifty thousand elements into a 3d arry with
dimensions (1,1,50000).  The reasoning is that the time
information is now stored on the same array axis by both the
monitor file and the detector reader.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.spec = np.expand_dims(np.expand_dims(y,axis=0),axis=0)
</pre>
</div>

<p>
The convert time function takes an array of us and returns their
corresponding wavelengths in Angstroms.  Most of this has already
been covered in the <a href="#convertTime">similar function</a> for the neutron data
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">convertTime</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,t):
    <span style="color: #e67128;">"""Converts a numpy array of time bins into neutron wavelengths"""</span>
    <span style="color: #dbdb95;">distanceToG4</span> = 3.7338+2.5297
    <span style="color: #74af68;">#</span><span style="color: #74af68;">The distance between the end of G4 and the Helium 3 monitor.</span>
    <span style="color: #dbdb95;">distanceToMonitor</span> = 0.02 <span style="color: #74af68;">#</span><span style="color: #74af68;">FIXME</span>
    <span style="color: #dbdb95;">t</span> -= 860
    <span style="color: #dbdb95;">t</span> *= 3.956034e-7/(distanceToMonitor+distanceToG4)/1e-10*1e-6
    <span style="color: #ffad29; font-weight: bold;">return</span> t
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> Combiner</h3>
<div class="outline-text-3" id="text-4-3">
<p>
The <code>Combiner</code> module contains two helper functions.  These function
are used for parsing the metadata from individual runs and combining
them into a single run file.
</p>
</div>

<div id="outline-container-sec-4-3-1" class="outline-4">
<h4 id="sec-4-3-1"><span class="section-number-4">4.3.1</span> Combiner Skeleton</h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
The <code>XMLNS</code> global variable is the <a href="http://www.w3.org/TR/REC-xml-names/">XML Namespace</a> that the SNS has
chosen to use in their configuration files.  The good news is that
Python's <code>xml.etree</code> module correctly handles namespaces.  The bad
news is that every attempt to pull a tag from an XML file requires
that the tag be prefaced with the namespace, which is a pain.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">import</span> xml.etree.ElementTree <span style="color: #ffad29; font-weight: bold;">as</span> ET
<span style="color: #ffad29; font-weight: bold;">import</span> HTMLParser
<span style="color: #ffad29; font-weight: bold;">import</span> json
<span style="color: #ffad29; font-weight: bold;">import</span> numpy <span style="color: #ffad29; font-weight: bold;">as</span> np
<span style="color: #ffad29; font-weight: bold;">import</span> os.path
<span style="color: #ffad29; font-weight: bold;">from</span> time <span style="color: #ffad29; font-weight: bold;">import</span> strptime,mktime
<span style="color: #ffad29; font-weight: bold;">from</span> math <span style="color: #ffad29; font-weight: bold;">import</span> floor,sqrt

<span style="color: #dbdb95;">XMLNS</span> = <span style="color: #e67128;">"{http://neutrons.ornl.gov/SNS/DAS/runinfo_v4_3}"</span>

&lt;&lt;combiner-load&gt;&gt;
&lt;&lt;combiner-save&gt;&gt;
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-4-3-2" class="outline-4">
<h4 id="sec-4-3-2"><span class="section-number-4">4.3.2</span> Load</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
The <code>load</code> function takes a list of paths to runinfo files and
returns a dictionary with the current configurations as a key and the
runs associated with the configuration as the value.  It also takes
an optional <code>filter</code> parameter, which is currently ignored and should
be removed.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">load</span>(paths,<span style="color: #23d7d7;">filter</span>=<span style="color: #008b8b;">None</span>):
    <span style="color: #dbdb95;">currents</span> = <span style="color: #23d7d7;">set</span>([])<span style="color: #74af68;">#</span><span style="color: #74af68;">List of the configurations of the instrument</span>
    <span style="color: #dbdb95;">runsets</span> = {}<span style="color: #74af68;">#</span><span style="color: #74af68;">Directionary of lists of run nodes, indexed by their instrument configuration</span>
</pre>
</div>

<p>
For each run<sub>info</sub> file, we use element tree to find the <code>&lt;Notes&gt;</code>
tag.  This text is then extracted out.  The SNS software does HTML
encoding on the text in the notes tag, despite the fact that this is
XML and not HTML.  In any case, we use the HTMLParser module to
remove the text encoding.  Finally, our <code>save</code> function in
<code>Sesame_init.py</code> saves the power supply status as a <a href="http://www.json.org">JSON</a> string,
which we then interpret.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">for</span> path <span style="color: #ffad29; font-weight: bold;">in</span> paths:
        <span style="color: #ffad29; font-weight: bold;">print</span>(path)
        <span style="color: #dbdb95;">base</span> = os.path.dirname(path)
        <span style="color: #dbdb95;">text</span> = ET.parse(path).getroot().find(<span style="color: #e67128;">".//"</span>+XMLNS+<span style="color: #e67128;">"Notes"</span>).text 
        <span style="color: #dbdb95;">text</span> = HTMLParser.HTMLParser().unescape(text)
        <span style="color: #dbdb95;">manifest</span> = json.loads(text)
</pre>
</div>

<p>
The dictionary of the power supply currents is turned into a tuple.
The tuple is a value by itself and can be put into a Set, while the
dictionary is an object with a unique identity and doesn't mesh as
well with Sets and uniqueness checking.  A useful improvement would
be to turn this into a <a href="https://docs.python.org/2/library/collections.html">NamedTuple</a>, which would allow the constituents
to be called by name, instead of location.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">##        </span><span style="color: #74af68;">if ((filter is not None) and </span>
<span style="color: #74af68;">##            </span><span style="color: #74af68;">(floor(float(manifest['triangle1'])) != filter)):</span>
<span style="color: #74af68;">##            </span><span style="color: #74af68;">continue #wrong triangle current</span>
        <span style="color: #ffad29; font-weight: bold;">try</span>:
            <span style="color: #dbdb95;">current</span> = (manifest[<span style="color: #e67128;">'Flipper'</span>],
                       manifest[<span style="color: #e67128;">'Guide'</span>],
                       manifest[<span style="color: #e67128;">'Phase'</span>],
                       manifest[<span style="color: #e67128;">'Sample'</span>],
                       manifest[<span style="color: #e67128;">'Triangle1'</span>],
                       manifest[<span style="color: #e67128;">'Triangle2'</span>],
                       manifest[<span style="color: #e67128;">'Triangle3'</span>],
                       manifest[<span style="color: #e67128;">'Triangle4'</span>],
                       manifest[<span style="color: #e67128;">'Triangle5'</span>],
                       manifest[<span style="color: #e67128;">'Triangle6'</span>],
                       manifest[<span style="color: #e67128;">'Triangle7'</span>],
                       manifest[<span style="color: #e67128;">'Triangle8'</span>])
        <span style="color: #ffad29; font-weight: bold;">except</span>:
            <span style="color: #ffad29; font-weight: bold;">print</span>(<span style="color: #e67128;">"Could not retrieve currents for run "</span> + <span style="color: #23d7d7;">str</span>(base[-5:]))
            <span style="color: #ffad29; font-weight: bold;">continue</span>
</pre>
</div>

<p>
If this combination of power supply currents hasn't been seen before,
it's added to the dictionary.  Replacing runsets with a <a href="https://docs.python.org/2/library/collections.html">defaultDict</a>
could save us some effort here.
</p>

<p>
Finally, the function returns the dictionary.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
        <span style="color: #ffad29; font-weight: bold;">if</span> current <span style="color: #ffad29; font-weight: bold;">in</span> currents:
            runsets[current].append(path)
        <span style="color: #ffad29; font-weight: bold;">else</span>:
            currents.add(current)
            <span style="color: #dbdb95;">runsets</span>[current]=[path]
    <span style="color: #ffad29; font-weight: bold;">return</span> runsets
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-4-3-3" class="outline-4">
<h4 id="sec-4-3-3"><span class="section-number-4">4.3.3</span> Save</h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
The <code>save</code> function is used to export a set of runs into a single
file.
</p>

<dl class="org-dl">
<dt> path </dt><dd>The location where the file should be saved.  This includes
both the directory and the prefix for the file name.  For
instance, if <code>path</code> is "C:/PELVis/example", then the
detector data would be saved in "example<sub>neutron</sub><sub>event</sub>.dat"
in the "C:/PELVis" directory.
</dd>
<dt> minmon </dt><dd>The minimum number of monitor counts per second that we
expect when the beam is on.  Runs with a count rate below
this will be ignored, as the assumption is that there
were no neutrons and the detector merely contains noise.
</dd>
<dt> keys </dt><dd>Which current sets should be included in the export
</dd>
<dt> runsets </dt><dd>The dictionary of data runs produced by <code>load</code>
</dd>
</dl>

<p>
We begin by using the key to extract from the dictionary the paths
for all of the runs were are interested in.
</p>
<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">save</span>(path,minmon,keys,runsets):
    <span style="color: #dbdb95;">runs</span> = [x <span style="color: #ffad29; font-weight: bold;">for</span> key <span style="color: #ffad29; font-weight: bold;">in</span> keys <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> runsets[key]]
</pre>
</div>

<p>
The <code>mon</code> array holds out total monitor spectrum.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #dbdb95;">mon</span> = np.zeros((50001,),dtype=np.int32)
</pre>
</div>

<p>
The <code>tottime</code> and <code>detcount</code> are just interesting statistics and
could be dropped.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #dbdb95;">tottime</span> = 0
    <span style="color: #dbdb95;">detcount</span>=0
</pre>
</div>

<p>
There's a weird bug in the SNS code.  I'm pretty sure that the bug is
in their code and is not something that I did.  When a runinfo file is
saved, it gives a malformatted timestamp for the <code>StartTime</code> and
<code>StopTime</code>.  The format strings below allow Python to parse these strings.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #dbdb95;">format1</span> = <span style="color: #e67128;">"%Y-%m-%dT%H:%M:%S-04:00"</span>
    <span style="color: #dbdb95;">format2</span> = <span style="color: #e67128;">"%Y-%m-%dT%H:%M:%S-04:00-04:00"</span>
</pre>
</div>

<p>
We open the final output file (outfile), and cycle through the
monitor files (monpath) and detecto files (detpath).
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">with</span> <span style="color: #23d7d7;">open</span>(path+<span style="color: #e67128;">"_neutron_event.dat"</span>,<span style="color: #e67128;">"wb"</span>) <span style="color: #ffad29; font-weight: bold;">as</span> outfile:
        <span style="color: #ffad29; font-weight: bold;">for</span> r <span style="color: #ffad29; font-weight: bold;">in</span> runs:
            <span style="color: #dbdb95;">monpath</span> = r[:-11] + <span style="color: #e67128;">"bmon_histo.dat"</span>
            <span style="color: #dbdb95;">detpath</span> = r[:-11] + <span style="color: #e67128;">"neutron_event.dat"</span>
</pre>
</div>

<p>
We extract the starting and ending times and put the total number of
seconds spent during the measurement into the variable <code>time</code>.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
            <span style="color: #dbdb95;">starttime</span> = strptime(ET.parse(r).getroot().find(<span style="color: #e67128;">".//"</span>+XMLNS+<span style="color: #e67128;">"StartTime"</span>).text.strip(),format1)
            <span style="color: #dbdb95;">stoptime</span> = strptime(ET.parse(r).getroot().find(<span style="color: #e67128;">".//"</span>+XMLNS+<span style="color: #e67128;">"StopTime"</span>).text.strip(),format2)

            <span style="color: #dbdb95;">time</span> = mktime(stoptime)-mktime(starttime)
</pre>
</div>

<p>
The monitor spectrum for the individual run is slurped into the
variable <code>montemp</code> with the total number of counts being stored in
<code>moncount</code>. 
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
            <span style="color: #ffad29; font-weight: bold;">with</span> <span style="color: #23d7d7;">open</span>(monpath,<span style="color: #e67128;">"r"</span>) <span style="color: #ffad29; font-weight: bold;">as</span> infile:
                <span style="color: #dbdb95;">montemp</span> = np.fromfile(infile,dtype=np.int32)

            <span style="color: #dbdb95;">moncount</span> = 1.*np.<span style="color: #23d7d7;">sum</span>(montemp)
            <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Run number: "</span> + <span style="color: #23d7d7;">str</span>(r[-17:-12])
            <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Time: "</span> + <span style="color: #23d7d7;">str</span>(time)
</pre>
</div>

<p>
We check to see if we're within 20 counts per second of the expected
monitor count rate.  If not, then we stop processing this run.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
            <span style="color: #74af68;">#</span><span style="color: #74af68;">Fixed for enabling dead run substraction 04/01/2013 done by Radian </span>
            <span style="color: #ffad29; font-weight: bold;">if</span> time &lt;= 0 <span style="color: #ffad29; font-weight: bold;">or</span> ((moncount/time &lt; minmon-20 <span style="color: #ffad29; font-weight: bold;">or</span> \
                              moncount/time&gt;minmon+20) <span style="color: #ffad29; font-weight: bold;">and</span> minmon &gt;0):
                <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">":::: SKIPPING RUN: "</span> + <span style="color: #23d7d7;">str</span>(r[-17:-12]) + <span style="color: #e67128;">" ::::\n"</span>
                <span style="color: #ffad29; font-weight: bold;">print</span> moncount/time
                <span style="color: #ffad29; font-weight: bold;">print</span> time
                <span style="color: #ffad29; font-weight: bold;">continue</span>

            <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Monitor counts: "</span> + <span style="color: #23d7d7;">str</span>(moncount)
            <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Monitor count rate: "</span> + <span style="color: #23d7d7;">str</span>(<span style="color: #23d7d7;">round</span>(moncount/time,2))

            <span style="color: #dbdb95;">mon</span> += montemp
            <span style="color: #dbdb95;">tottime</span> += time
</pre>
</div>

<p>
The contents of the detector file is loaded into dettemp.  There's
also some code to calculate the detector count rate.  That code could
probably be removed.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
            <span style="color: #ffad29; font-weight: bold;">with</span> <span style="color: #23d7d7;">open</span>(detpath,<span style="color: #e67128;">"rb"</span>) <span style="color: #ffad29; font-weight: bold;">as</span> infile:
                <span style="color: #dbdb95;">dettemp</span> = np.fromfile(infile,count=-1)
                <span style="color: #dbdb95;">dc</span> = 1.*<span style="color: #23d7d7;">len</span>(dettemp)
                <span style="color: #dbdb95;">dcr</span> = <span style="color: #23d7d7;">round</span>(dc/moncount,2)
                <span style="color: #dbdb95;">dcrerr</span> = sqrt(dc/(moncount**2) + (dc**2)/(moncount**3))
                <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Detector counts: "</span> + <span style="color: #23d7d7;">str</span>(dc)
                <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Detector count rate: "</span> + <span style="color: #23d7d7;">str</span>(<span style="color: #23d7d7;">round</span>(dc/time,2))
                <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Detector counts/Monitor counts: "</span> + <span style="color: #23d7d7;">str</span>(dcr) + \
                      <span style="color: #e67128;">" +/- "</span> + <span style="color: #23d7d7;">str</span>(dcrerr) + <span style="color: #e67128;">"\n"</span>
                <span style="color: #ffad29; font-weight: bold;">if</span> dcr &lt;= 0:<span style="color: #74af68;"># </span><span style="color: #74af68;">or dcrerr/dcr &gt; 0.02:</span>
                    <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"#### SKIPPING RUN: "</span> + <span style="color: #23d7d7;">str</span>(r[-17:-12]) + <span style="color: #e67128;">" ####\n"</span>
                    <span style="color: #dbdb95;">mon</span> -= montemp
                    <span style="color: #ffad29; font-weight: bold;">continue</span>
</pre>
</div>

<p>
We increment the total detector count and add the events to our final
run file.  We also delete the current data from memory to save some space.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
                <span style="color: #dbdb95;">detcount</span> += <span style="color: #23d7d7;">len</span>(dettemp)
                dettemp.tofile(outfile)
                <span style="color: #ffad29; font-weight: bold;">del</span> dettemp
</pre>
</div>

<p>
Finally, we dump the total monitor spectrum to a file and display the
cumulative statistics for all of the runs.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">with</span> <span style="color: #23d7d7;">open</span>(path+<span style="color: #e67128;">"_bmon_histo.dat"</span>,<span style="color: #e67128;">"wb"</span>) <span style="color: #ffad29; font-weight: bold;">as</span> stream:
        mon.tofile(stream)
    <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Total Monitor Counts = "</span> + <span style="color: #23d7d7;">str</span>(np.<span style="color: #23d7d7;">sum</span>(mon))
    <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Total Detector Counts = "</span> + <span style="color: #23d7d7;">str</span>(detcount)
    <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Total Time = "</span> + <span style="color: #23d7d7;">str</span>(tottime)
    <span style="color: #ffad29; font-weight: bold;">if</span> tottime &gt; 0:
        <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Monitor Count Rate = "</span> + <span style="color: #23d7d7;">str</span>(np.<span style="color: #23d7d7;">sum</span>(mon)/tottime)
        <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"Detector Count Rate = "</span> + <span style="color: #23d7d7;">str</span>(detcount/tottime)
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Reduction</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Reduction Skeleton</h3>
<div class="outline-text-3" id="text-5-1">
<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">from</span> reader <span style="color: #ffad29; font-weight: bold;">import</span> PelFile
<span style="color: #ffad29; font-weight: bold;">from</span> monfile <span style="color: #ffad29; font-weight: bold;">import</span> MonFile
<span style="color: #ffad29; font-weight: bold;">import</span> matplotlib.pyplot <span style="color: #ffad29; font-weight: bold;">as</span> plt
<span style="color: #ffad29; font-weight: bold;">import</span> Combiner
<span style="color: #ffad29; font-weight: bold;">import</span> numpy <span style="color: #ffad29; font-weight: bold;">as</span> np
<span style="color: #ffad29; font-weight: bold;">from</span> optparse <span style="color: #ffad29; font-weight: bold;">import</span> OptionParser
<span style="color: #ffad29; font-weight: bold;">import</span> os

<span style="color: #dbdb95;">basedir</span> = <span style="color: #e67128;">"C:/userfiles/EXP011/"</span>
<span style="color: #dbdb95;">RESOLUTION</span> = 400

&lt;&lt;reduction_load&gt;&gt;

&lt;&lt;reduction_export&gt;&gt;

&lt;&lt;reduction_plot_2d_range&gt;&gt;
&lt;&lt;reduction_get_2d_int&gt;&gt;

&lt;&lt;reduction_plot_int_range&gt;&gt;

&lt;&lt;reduction_plot_pol_range&gt;&gt;


&lt;&lt;reduction_getIntegratedSpectra&gt;&gt;
&lt;&lt;reduction_normalize_name&gt;&gt;


&lt;&lt;reduction_spectrum&gt;&gt;

&lt;&lt;reduction_errspectrum&gt;&gt;
&lt;&lt;reduction_simple_spectrum&gt;&gt;

&lt;&lt;reduction_fr&gt;&gt;

&lt;&lt;reduction_run_int&gt;&gt;


&lt;&lt;reduction_singleplot&gt;&gt;

&lt;&lt;reduction_echoplot&gt;&gt;
&lt;&lt;reduction_intensity&gt;&gt;


&lt;&lt;reduction_echofr&gt;&gt;

&lt;&lt;reduction_poldrift&gt;&gt;
&lt;&lt;reduction_echodiff&gt;&gt;

&lt;&lt;reduction_twoflipper&gt;&gt;           

&lt;&lt;reduction_main&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Main Command</h3>
<div class="outline-text-3" id="text-5-2">
<p>
The program begins by creating an <a href="https://docs.python.org/2/library/optparse.html">OptionParser</a> to handle the
numerous command line options of the application.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">__name__</span>==<span style="color: #e67128;">'__main__'</span>:

    parser = OptionParser()
</pre>
</div>

<p>
The <code>choices</code> dictionary gives a simple mapping between the human
readable names of the power supplies and their numbering.  This
will be used to interpret channel selection from the user at the
command line.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>

    <span style="color: #dbdb95;">choices</span> = {<span style="color: #008b8b;">None</span>:<span style="color: #008b8b;">None</span>,<span style="color: #e67128;">"flipper"</span>:0,<span style="color: #e67128;">"guides"</span>:1,<span style="color: #e67128;">"phase"</span>:2,<span style="color: #e67128;">"sample"</span>:3,<span style="color: #e67128;">"1"</span>:4,<span style="color: #e67128;">"2"</span>:5,<span style="color: #e67128;">"3"</span>:6,<span style="color: #e67128;">"4"</span>:7,<span style="color: #e67128;">"5"</span>:8,<span style="color: #e67128;">"6"</span>:9,<span style="color: #e67128;">"7"</span>:10,<span style="color: #e67128;">"8"</span>:11}
</pre>
</div>

<p>
The export command tells the reducer that the files need to be
combined before they can be plotted.  If the command has been run
once, then subsequent runs can plot the <b>same data</b> in different
way.  However, if you want to change the run number or anything
about the currents examined, the data needs to be exported again.
</p>

<p>
The <code>twoflip</code> option is a duplication of functionality and should
be removed.  It can be just as easily performed with a <code>sortby</code>
option without adding in duplicated code.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>

    parser.add_option(<span style="color: #e67128;">"-e"</span>,<span style="color: #e67128;">"--export"</span>, <span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"choice"</span>, action=<span style="color: #e67128;">"store"</span>, \
                      <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"Export into pel files"</span>,
                      choices=[<span style="color: #e67128;">"flip"</span>,<span style="color: #e67128;">"twoflip"</span>])
</pre>
</div>

<p>
The <code>sortby</code> command is used to get flipping measurements sorted by
the current in another power supply.  For instance, if the unit was
flipping one triangle 3 and performing a tuning scan on triangle 8,
then <code>--sortby 8</code> would separate out all of the different tuning runs.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    parser.add_option(<span style="color: #e67128;">"--sortby"</span>,action=<span style="color: #e67128;">"store"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"choice"</span>, \
                       <span style="color: #23d7d7;">help</span> = <span style="color: #e67128;">"Which power supply is scanned"</span>,
                       choices=choices.keys())
</pre>
</div>

<p>
The <code>filter</code> option is used to only examine a single state from the
power supply indicated by <code>sortby</code>.  For instance, if you have
found that the instrument was tuned at 4.5A after a tuning scan on
triangle 7, then <code>--sortby 7 --filter 4.5</code> would only process runs
where the instrument was tuned.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    parser.add_option(<span style="color: #e67128;">"--filter"</span>,action=<span style="color: #e67128;">"store"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"float"</span>, \
                       <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"Focuses the export to only a single \</span>
<span style="color: #e67128;">                       value in the sortby parameter"</span>)
</pre>
</div>

<p>
The <code>flip</code> option indicated which power supply acted as the
flipper.  This is necessary for splitting the spin states.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    parser.add_option(<span style="color: #e67128;">"--flip"</span>,action=<span style="color: #e67128;">"store"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"choice"</span>, \
                       <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"Which power supply runs the flipper"</span>,
                       choices=choices.keys())
</pre>
</div>

<p>
The <code>flip2</code> command is used to indicate which power supply served
for the second flipper in a two flipper measurement.  Like the
<code>twoflip</code> option on <code>export</code>, this is better server by using the
<code>sortby</code>  command and should be removed.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    parser.add_option(<span style="color: #e67128;">"--flip2"</span>,action=<span style="color: #e67128;">"store"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"choice"</span>, \
                       <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"Which power supply runs the second flipper \</span>
<span style="color: #e67128;">                       in a two flipper run"</span>,
                       choices=choices.keys())
</pre>
</div>

<p>
The <code>mon</code> command sets a minimum monitor value for a run.  If the
count rate per second on the monitor is less than this value, the
beam is assumed to have gone down and the run is not included.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    parser.add_option(<span style="color: #e67128;">"--mon"</span>,action=<span style="color: #e67128;">"store"</span>,default=32,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"float"</span>, \
                       <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"Minimum monitor value.  If the value \</span>
<span style="color: #e67128;">                       is lessthan or equal to zero, all runs are \</span>
<span style="color: #e67128;">                       included, regardless of monitor count."</span>)
</pre>
</div>

<p>
The <code>(x,y)(min,max)</code> options give a pixel range on the detector,
indicating the area where the relevant signal should be expected.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>

    parser.add_option(<span style="color: #e67128;">"--xmin"</span>,action=<span style="color: #e67128;">"store"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"int"</span>,<span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"Minimum x value"</span>,default=0)
    parser.add_option(<span style="color: #e67128;">"--ymin"</span>,action=<span style="color: #e67128;">"store"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"int"</span>,<span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"Minimum y value"</span>,default=0)
    parser.add_option(<span style="color: #e67128;">"--xmax"</span>,action=<span style="color: #e67128;">"store"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"int"</span>,<span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"Maximum x value"</span>,default=16)
    parser.add_option(<span style="color: #e67128;">"--ymax"</span>,action=<span style="color: #e67128;">"store"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"int"</span>,<span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"Maximum y value"</span>,default=128)
</pre>
</div>

<p>
When the <code>sortby</code> command is used, the <code>start</code>, <code>stop</code>, and <code>step</code>
command give the bounds of the current that should be expected, as
well as the step size between them.  Honestly, the program should
be improved so that it can find these values automatically, but
they need to be manually entered for now.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>

    parser.add_option(<span style="color: #e67128;">"--start"</span>,action = <span style="color: #e67128;">"store"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"float"</span>, <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"The starting current of the scan"</span>)
    parser.add_option(<span style="color: #e67128;">"--stop"</span>,action = <span style="color: #e67128;">"store"</span>, <span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"float"</span>, <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"The ending current of the scan"</span>)
    parser.add_option(<span style="color: #e67128;">"--step"</span>,action = <span style="color: #e67128;">"store"</span>, <span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"float"</span>, <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"The current step of the scan"</span>)
</pre>
</div>

<p>
The <code>skip</code> command can be used to exclude a bad run (e.g. power
supply failure).  Calling it multiple times allows for skipping
multiple runs.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    parser.add_option(<span style="color: #e67128;">"--skip"</span>,action = <span style="color: #e67128;">"append"</span>, <span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"int"</span>, <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"Marks that a run should NOT be included in the file export."</span>)
</pre>
</div>

<p>
The <code>plot</code> option tells the program which kind of plot to make.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>

    parser.add_option(<span style="color: #e67128;">"--plot"</span>,action=<span style="color: #e67128;">"store"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"choice"</span>,
                      <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"Where to make a simple plot or perform a height diff"</span>,
                      choices=[<span style="color: #e67128;">"plot"</span>,<span style="color: #e67128;">"diff"</span>,<span style="color: #e67128;">"fr"</span>,<span style="color: #e67128;">"echo"</span>,<span style="color: #e67128;">"intensity"</span>,<span style="color: #e67128;">"poldrift"</span>,<span style="color: #e67128;">"int2drange"</span>,<span style="color: #e67128;">"pol2drange"</span>])
</pre>
</div>

<p>
The <code>save</code> option takes a file name and saves the data that would
be plotted into that file.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    parser.add_option(<span style="color: #e67128;">"--save"</span>,action=<span style="color: #e67128;">"store"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"string"</span>,default=<span style="color: #008b8b;">None</span>,
                      <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"A file in which to save the dataset."</span>)
</pre>
</div>

<p>
The <code>mask</code> option takes the path of a binary bitmap mask, as
<a href="#OnExportROI">exported by PELVis</a> and uses it to examine only the signal portion of
the detector.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    parser.add_option(<span style="color: #e67128;">"--mask"</span>,action=<span style="color: #e67128;">"append"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"string"</span>,default=<span style="color: #008b8b;">None</span>,
                      <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"A mask file indicating which pixel to use in the analysis"</span>)
</pre>
</div>

<p>
This function seems to duplicate the filter command.  It should be
seen if both are really necessary.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    parser.add_option(<span style="color: #e67128;">"--current"</span>,action=<span style="color: #e67128;">"store"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"int"</span>,
                      default=<span style="color: #008b8b;">None</span>,
                      <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"A triangle current to filter the results."</span>)
</pre>
</div>

<p>
Again, this probably isn't necessary.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    parser.add_option(<span style="color: #e67128;">"--watch"</span>,action=<span style="color: #e67128;">"store"</span>,<span style="color: #23d7d7;">type</span>=<span style="color: #e67128;">"choice"</span>, \
                      choices=choices.keys(), \
                      <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"Which coil are we watching the current of (see --current)"</span>)
</pre>
</div>

<p>
   If there are a large number of runs which need to be removed or if
   two measurements taken far apart in time are to be combined, then
   the <code>complex</code> option can take the name of a text file which has the
   list of the run numbers to be examined, with one run number per
   line.
#+end<sub>src</sub>
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    parser.add_option(<span style="color: #e67128;">"--complex"</span>,action=<span style="color: #e67128;">"store_true"</span>,
                     <span style="color: #23d7d7;">help</span>=<span style="color: #e67128;">"Whether to load the run data from runlist.txt"</span>)
</pre>
</div>

<p>
Now that we've parsed the command line arguments, we can start
actually crunching some data.  The <code>runs</code> variable is a list of the
run numbers, which can either be loaded from the command line or
from a file.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>

    (options,runs) = parser.parse_args()

    <span style="color: #ffad29; font-weight: bold;">if</span> options.<span style="color: #23d7d7;">complex</span>:
        <span style="color: #dbdb95;">runs</span> = <span style="color: #23d7d7;">list</span>(np.loadtxt(<span style="color: #e67128;">"runlist.txt"</span>))
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #dbdb95;">runs</span> = <span style="color: #23d7d7;">range</span>(<span style="color: #23d7d7;">int</span>(runs[0]),<span style="color: #23d7d7;">int</span>(runs[1])+1)
</pre>
</div>

<p>
We then remove any skipped runs from the list.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> options.skip:
        <span style="color: #ffad29; font-weight: bold;">for</span> item <span style="color: #ffad29; font-weight: bold;">in</span> options.skip:
            runs.remove(item)
</pre>
</div>

<p>
We now combine and export the runs.  Against, the <code>twoflip</code> option
is unnecessary.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>

    <span style="color: #ffad29; font-weight: bold;">if</span> options.export==<span style="color: #e67128;">"flip"</span>:
        export(runs, choices[options.sortby], choices[options.flip], \
               options.mon, options.current, options.<span style="color: #23d7d7;">filter</span>, options.watch)
    <span style="color: #ffad29; font-weight: bold;">if</span> options.export==<span style="color: #e67128;">"twoflip"</span>:
        two_flipper(runs, choices[options.flip], choices[options.flip2], \
               options.mon, options.current, options.watch)
</pre>
</div>

<p>
If the user has added mask files, we now create a custom mask that
passes through every one of the loaded files.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>

    <span style="color: #ffad29; font-weight: bold;">if</span> options.mask <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #dbdb95;">mask</span> = np.ones((128,16),dtype=np.<span style="color: #23d7d7;">bool</span>)
        <span style="color: #ffad29; font-weight: bold;">for</span> m <span style="color: #ffad29; font-weight: bold;">in</span> options.mask:
            <span style="color: #ffad29; font-weight: bold;">if</span> m[-3:] == <span style="color: #e67128;">"dat"</span>:
                mask = np.logical_and(mask,np.loadtxt(m))
            <span style="color: #ffad29; font-weight: bold;">else</span>:
                mask = np.logical_and(mask,np.load(m))
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        mask = <span style="color: #008b8b;">None</span>
</pre>
</div>

<p>
Finally, if the user hasn't chosen to plot anything, then the task
is complete.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> options.plot <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #ffad29; font-weight: bold;">pass</span>
</pre>
</div>

<p>
We now need to know the names of the exported files.  If there was
no attempt to sort by a triangle current, then the names aren't
necessary.  Otherwise, we step through the currents given by
<code>start</code>, <code>stop</code>, and <code>step</code> and check to see if the file exists.
If it does, it's added to the list of files.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #ffad29; font-weight: bold;">if</span> options.sortby <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span> <span style="color: #ffad29; font-weight: bold;">or</span> options.<span style="color: #23d7d7;">filter</span> <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
            <span style="color: #dbdb95;">names</span> = [<span style="color: #e67128;">""</span>]
        <span style="color: #ffad29; font-weight: bold;">else</span>:
            <span style="color: #dbdb95;">count</span> = <span style="color: #23d7d7;">round</span>((options.stop-options.start)/options.step)+1
            <span style="color: #ffad29; font-weight: bold;">print</span>(count)
            <span style="color: #dbdb95;">names</span> = [<span style="color: #23d7d7;">str</span>(x) 
                     <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> 
                     np.linspace(
                    options.start,
                    options.stop,
                    count)]
            <span style="color: #ffad29; font-weight: bold;">print</span>(names)
            <span style="color: #dbdb95;">names</span> = [name <span style="color: #ffad29; font-weight: bold;">for</span> name <span style="color: #ffad29; font-weight: bold;">in</span> names
                     <span style="color: #ffad29; font-weight: bold;">if</span> os.path.exists(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % runs[-1] + 
                                       normalize_name(name)+
                                       <span style="color: #e67128;">"up_neutron_event.dat"</span>) 
                     <span style="color: #ffad29; font-weight: bold;">and</span> os.path.exists(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % runs[-1] + 
                                        normalize_name(name)+
                                        <span style="color: #e67128;">"down_neutron_event.dat"</span>)]
            <span style="color: #ffad29; font-weight: bold;">print</span>(names)
</pre>
</div>

<p>
Finally, we pass the users options to the associated plotting function.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>

        <span style="color: #ffad29; font-weight: bold;">if</span> options.plot==<span style="color: #e67128;">"plot"</span>:
            <span style="color: #ffad29; font-weight: bold;">print</span> runs
            <span style="color: #ffad29; font-weight: bold;">print</span> names
            singleplot(runs[-1],names[0],(options.xmin,options.ymin),(options.xmax,options.ymax))
        <span style="color: #ffad29; font-weight: bold;">elif</span> options.plot==<span style="color: #e67128;">"fr"</span>:
            echofr(runs[-1],names,(options.xmin,options.ymin),(options.xmax,options.ymax),outfile=options.save,mask=mask)
        <span style="color: #ffad29; font-weight: bold;">elif</span> options.plot==<span style="color: #e67128;">"diff"</span>:
            echodiff(runs[-1],names,187(options.xmin,options.ymin), \
                     (options.xmax,options.ymax),options.save)
        <span style="color: #ffad29; font-weight: bold;">elif</span> options.plot==<span style="color: #e67128;">"echo"</span>:
            echoplot(runs[-1],names,(options.xmin,options.ymin), \
                     (options.xmax,options.ymax),outfile=options.save)
        <span style="color: #ffad29; font-weight: bold;">elif</span> options.plot==<span style="color: #e67128;">"intensity"</span>:
            intensity(runs[-1],names,(options.xmin,options.ymin),(options.xmax,options.ymax),outfile=options.save)
        <span style="color: #ffad29; font-weight: bold;">elif</span> options.plot==<span style="color: #e67128;">"poldrift"</span>:
            poldrift(runs,(options.xmin,options.ymin),(options.xmax,options.ymax),outfile=options.save)
        <span style="color: #ffad29; font-weight: bold;">elif</span> options.plot==<span style="color: #e67128;">"int2drange"</span>:
            plot_int_range(runs[-1])
        <span style="color: #ffad29; font-weight: bold;">elif</span> options.plot==<span style="color: #e67128;">"pol2drange"</span>:
            plot_pol_range(runs[-1],mask)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> Export</h3>
<div class="outline-text-3" id="text-5-3">
<p>
The load function performs most of the actual file sorting.  It
takes a list of run numbers and an optional current for filtering.
It returns a dictionary.  The keys to the dictionary are the
various current states that were used for measurements.  The values
in the dictionary are the lists of runs which were performed in
those current states.
</p>

<div class="org-src-container">

<pre class="src src-python" id="reduction_load"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">load</span>(runs,current=<span style="color: #008b8b;">None</span>):
    <span style="color: #dbdb95;">paths</span> = [basedir + <span style="color: #e67128;">"SESAME_%i/SESAME_%i_runinfo.xml"</span>
             % (run,run) <span style="color: #ffad29; font-weight: bold;">for</span> run <span style="color: #ffad29; font-weight: bold;">in</span> runs]
    <span style="color: #ffad29; font-weight: bold;">return</span> Combiner.load(paths,current)
</pre>
</div>

<p>
The <code>export</code> function takes several parameters to determine how to
properly organize the combined runs.
</p>

<dl class="org-dl">
<dt> runs </dt><dd>A list of run numbers
</dd>
<dt> sortby </dt><dd>An index for which element in the current tuple
returned by the <a href="#sec-4-3">4.3</a> should be used to separate the
measurements.
</dd>
<dt> flipper </dt><dd>The index for the element which contains the power
supply used as the flipper
</dd>
<dt> minmon </dt><dd>The minimum monitor count rate that should be used as a
basis for accepting or rejecting runs.
</dd>
<dt> watch </dt><dd>A third power supply to use for filtering.  In addition
to setting the power supply for the flipper and for
tuning, we can chose a third power supply where we will
fix the current.  Only values with that current in the
power supply will be exported.  This allows us to
perform a polarization scan of a two dimensional space
with respect to the power supplies.
</dd>
<dt> current </dt><dd>A current to be watched for in the power supply
selected by <code>watch</code>.
</dd>
<dt> filter </dt><dd>A single current value to be examined at the exclusion
of others.  The current value is searched for in the
power supply specified by <code>sortby</code>.
</dd>
</dl>

<p>
The function begins by using <a href="#sec-4-3">4.3</a> to get the metadata for all of
the runs and place them in the data dictionary.
</p>

<div class="org-src-container">

<pre class="src src-python" id="reduction_export"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">export</span>(runs,sortby=<span style="color: #008b8b;">None</span>,flipper=0,minmon=8,current=<span style="color: #008b8b;">None</span>,\
           <span style="color: #23d7d7;">filter</span>=<span style="color: #008b8b;">None</span>,watch=<span style="color: #008b8b;">None</span>):
    <span style="color: #dbdb95;">data</span> = load(runs,current)

    <span style="color: #dbdb95;">keys</span> = data.keys()
    <span style="color: #ffad29; font-weight: bold;">print</span> keys
</pre>
</div>

<p>
The <code>values</code> variable is the list of possible currents that could be
in the power supply that's being used for sorting.  If there's no
sorting, then the value isn't necessary.  If there's a filter on the
sorting, then only one value can occur.  Otherwise, we pull all of
the values from the keys.
</p>

<div class="org-src-container">

<pre class="src src-python" id="reduction_export"><span style="color: #74af68;">#</span>

    <span style="color: #ffad29; font-weight: bold;">if</span> sortby <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #dbdb95;">values</span> = [<span style="color: #e67128;">""</span>]
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">filter</span> <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
            <span style="color: #dbdb95;">values</span> = <span style="color: #23d7d7;">set</span>([x[sortby] <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> keys])
        <span style="color: #ffad29; font-weight: bold;">else</span>:
            <span style="color: #dbdb95;">values</span> = [<span style="color: #23d7d7;">filter</span>]
</pre>
</div>

<p>
The <code>base</code> variable stores the directory where all of the data will
be exported.  By default, it's the data directory of the last run
being examined.  
</p>

<div class="org-src-container">

<pre class="src src-python" id="reduction_export"><span style="color: #74af68;">#</span>

    <span style="color: #dbdb95;">base</span> = basedir + <span style="color: #e67128;">"SESAME_%i/"</span> % runs[-1]
</pre>
</div>

<p>
We then divide up the current keys into up state runs, down state
runs, and "same" runs, when the flipper is turned off.  The up state
is defined as the flipper current being negative and the down state
as the flipper current being positive.  Since the bender and
Helium-3 analyzer require a spin flip to achieve a high count rate,
the negative convention was chosen.
</p>

<p>
In addition to filtering on the flipper, the list comprehensions
also filter on the <code>current</code> and <code>watch</code> parameters, as well as the
<code>sortby</code> value.
</p>

<div class="org-src-container">

<pre class="src src-python" id="reduction_export"><span style="color: #74af68;">#</span>

    <span style="color: #ffad29; font-weight: bold;">for</span> value <span style="color: #ffad29; font-weight: bold;">in</span> values:
        <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">type</span>(value) <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #23d7d7;">str</span>:
            <span style="color: #dbdb95;">value</span> = normalize_name(value)
        <span style="color: #dbdb95;">ups</span> = [x <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> keys <span style="color: #ffad29; font-weight: bold;">if</span> (flipper <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span> <span style="color: #ffad29; font-weight: bold;">or</span> x[flipper] &lt; 0) \
               <span style="color: #ffad29; font-weight: bold;">and</span> (watch <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span> <span style="color: #ffad29; font-weight: bold;">or</span> x[choices[watch]]==current) \
               <span style="color: #ffad29; font-weight: bold;">and</span> (sortby <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span> <span style="color: #ffad29; font-weight: bold;">or</span> normalize_name(x[sortby]) == value)]
        <span style="color: #dbdb95;">downs</span> = [x <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> keys <span style="color: #ffad29; font-weight: bold;">if</span> (flipper <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span> <span style="color: #ffad29; font-weight: bold;">and</span> x[flipper] &gt; 0)  \
                <span style="color: #ffad29; font-weight: bold;">and</span> (watch <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span> <span style="color: #ffad29; font-weight: bold;">or</span> x[choices[watch]]==current) \
                <span style="color: #ffad29; font-weight: bold;">and</span> (sortby <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span> <span style="color: #ffad29; font-weight: bold;">or</span> normalize_name(x[sortby]) == value)]
        <span style="color: #dbdb95;">sames</span> = [x <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> keys <span style="color: #ffad29; font-weight: bold;">if</span> (flipper <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span> <span style="color: #ffad29; font-weight: bold;">and</span> x[flipper] == 0)  \
                <span style="color: #ffad29; font-weight: bold;">and</span> (watch <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span> <span style="color: #ffad29; font-weight: bold;">or</span> x[choices[watch]]==current) \
                <span style="color: #ffad29; font-weight: bold;">and</span> (sortby <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span> <span style="color: #ffad29; font-weight: bold;">or</span> normalize_name(x[sortby]) == value)]
</pre>
</div>

<p>
When we're only exporting a single current, we can now set the value
variable back to a blank, just as if there was no <code>sortby</code> parameter.
</p>

<div class="org-src-container">

<pre class="src src-python" id="reduction_export"><span style="color: #74af68;">#</span>
        <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">filter</span> <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
            <span style="color: #dbdb95;">value</span> = <span style="color: #e67128;">""</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Don't put values on files when we're only running a single export</span>
</pre>
</div>

<p>
If we used a <code>watch</code> and <code>current</code> filter, we'll want to save the
current in the file name so that we can run the reduction multiple
times with multiple currents and get multiple files.
</p>

<div class="org-src-container">

<pre class="src src-python" id="reduction_export"><span style="color: #74af68;">#</span>
        <span style="color: #ffad29; font-weight: bold;">if</span> current==<span style="color: #008b8b;">None</span>:
            titleend=<span style="color: #e67128;">""</span>
        <span style="color: #ffad29; font-weight: bold;">else</span>:
            titleend=<span style="color: #e67128;">"_current="</span>+<span style="color: #23d7d7;">str</span>(current)
</pre>
</div>

<p>
Finally, the combined runs are saved through the <a href="#sec-4-3">4.3</a>.  If there
is no spin up or spin down data, then the <code>sames</code> are saved.  Also,
we do not attempt to save the data if there were no measurements in
that particular spin state.
</p>

<div class="org-src-container">

<pre class="src src-python" id="reduction_export"><span style="color: #74af68;">#</span>
        <span style="color: #ffad29; font-weight: bold;">if</span> ups == [] <span style="color: #ffad29; font-weight: bold;">and</span> downs == []:
            Combiner.save(base+value+<span style="color: #e67128;">"Combined"</span>+titleend,
                          0,
                          sames,
                          data)
        <span style="color: #ffad29; font-weight: bold;">if</span> ups != []:
            <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"-------------- Up state --------------"</span>
            Combiner.save(base+value+<span style="color: #e67128;">"up"</span>+titleend,
                          minmon,
                          ups,
                          data)
        <span style="color: #ffad29; font-weight: bold;">if</span> downs != []:
            <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"-------------- Down state --------------"</span>
            Combiner.save(base+value+<span style="color: #e67128;">"down"</span>+titleend,
                          minmon,
                          downs,
                          data)
</pre>
</div>

<p>
The <code>twoflipper</code> function allows for exporting the states of a
two-flipper measurement.  This is deprecated, since the same
functionality can be performed by <code>sortby</code>.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">two_flipper</span>(runs, flipper1, flipper2, minmon, current, \
                watch=<span style="color: #e67128;">"2"</span>):

    <span style="color: #dbdb95;">data</span> = load(runs,current)
    <span style="color: #dbdb95;">keys</span> = data.keys()
    <span style="color: #dbdb95;">values</span> = [<span style="color: #e67128;">""</span>]
    <span style="color: #dbdb95;">base</span> = basedir + <span style="color: #e67128;">"SESAME_%i/"</span> % runs[-1]

    <span style="color: #ffad29; font-weight: bold;">for</span> value <span style="color: #ffad29; font-weight: bold;">in</span> values:
        <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">type</span>(value) <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #23d7d7;">str</span>:
            <span style="color: #dbdb95;">value</span> = normalize_name(value)
        <span style="color: #dbdb95;">upup</span> = [x <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> keys <span style="color: #ffad29; font-weight: bold;">if</span> x[flipper1] &lt; 0 <span style="color: #ffad29; font-weight: bold;">and</span> x[flipper2] &lt; 0 \
                <span style="color: #ffad29; font-weight: bold;">and</span> x[choices[watch]]==current]
        <span style="color: #dbdb95;">updown</span> = [x <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> keys <span style="color: #ffad29; font-weight: bold;">if</span> x[flipper1] &lt; 0 <span style="color: #ffad29; font-weight: bold;">and</span> x[flipper2] &gt; 0 \
                  <span style="color: #ffad29; font-weight: bold;">and</span> x[choices[watch]]==current]
        <span style="color: #dbdb95;">downup</span> = [x <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> keys <span style="color: #ffad29; font-weight: bold;">if</span> x[flipper1] &gt; 0 <span style="color: #ffad29; font-weight: bold;">and</span> x[flipper2] &lt; 0 \
                  <span style="color: #ffad29; font-weight: bold;">and</span> x[choices[watch]]==current]
        <span style="color: #dbdb95;">downdown</span> = [x <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> keys <span style="color: #ffad29; font-weight: bold;">if</span> x[flipper1] &gt; 0 <span style="color: #ffad29; font-weight: bold;">and</span> x[flipper2] &gt; 0 \
                    <span style="color: #ffad29; font-weight: bold;">and</span> x[choices[watch]]==current]
        <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">filter</span> <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
            <span style="color: #dbdb95;">value</span> = <span style="color: #e67128;">""</span> <span style="color: #74af68;">#</span><span style="color: #74af68;">Don't put values on files when we're only running a single export</span>

        <span style="color: #ffad29; font-weight: bold;">if</span> upup != []:
            <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"-------------- Up/Up state --------------"</span>
            Combiner.save(base+value+<span style="color: #e67128;">"upup_current="</span> + <span style="color: #23d7d7;">str</span>(current),
                          minmon,
                          upup,
                          data)
        <span style="color: #ffad29; font-weight: bold;">if</span> updown != []:
            <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"-------------- Up/Down state --------------"</span>
            Combiner.save(base+value+<span style="color: #e67128;">"updown_current="</span> + <span style="color: #23d7d7;">str</span>(current),
                          minmon,
                          updown,
                          data)
        <span style="color: #ffad29; font-weight: bold;">if</span> downup != []:
            <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"-------------- Down/Up state --------------"</span>
            Combiner.save(base+value+<span style="color: #e67128;">"downup_current="</span> + <span style="color: #23d7d7;">str</span>(current),
                          minmon,
                          downup,
                          data)
        <span style="color: #ffad29; font-weight: bold;">if</span> downdown != []:
            <span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #e67128;">"-------------- Down/Down state --------------"</span>
            Combiner.save(base+value+<span style="color: #e67128;">"downdown_current="</span> + <span style="color: #23d7d7;">str</span>(current),
                          minmon,
                          downdown,
                          data)

        <span style="color: #ffad29; font-weight: bold;">if</span> [upup,updown,downup,downdown]==[[],[],[],[]]:
            <span style="color: #ffad29; font-weight: bold;">print</span>(<span style="color: #e67128;">"No data to write"</span>)
</pre>
</div>
</div>
</div>


<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4"><span class="section-number-3">5.4</span> Import</h3>
<div class="outline-text-3" id="text-5-4">
<p>
The <code>spectrum</code> function takes a run number directory (<code>run</code>) and a designation
(<code>name</code>) and returns the polarization spectrum.  The remaining
optional parameters allow the user to specify which parts of the
detector contain the signal.
</p>

<div class="org-src-container">

<pre class="src src-python" id="reduction_spectrum"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">spectrum</span>(run,name,mins=(0,0),maxs=(16,128),mask=<span style="color: #008b8b;">None</span>):
    <span style="color: #dbdb95;">name</span> = normalize_name(name)
    <span style="color: #dbdb95;">p</span> = PelFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"up_neutron_event.dat"</span>)
    <span style="color: #dbdb95;">mon</span> = MonFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"up_bmon_histo.dat"</span>,<span style="color: #008b8b;">False</span>)
    <span style="color: #dbdb95;">up</span> = p.make1d(mins,maxs,mask)
    <span style="color: #dbdb95;">uperr</span> = np.sqrt(up)/np.<span style="color: #23d7d7;">sum</span>(mon.spec)
    <span style="color: #dbdb95;">up</span> /= np.<span style="color: #23d7d7;">sum</span>(mon.spec)
    <span style="color: #dbdb95;">p</span> = PelFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"down_neutron_event.dat"</span>)
    <span style="color: #dbdb95;">mon</span> = MonFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"down_bmon_histo.dat"</span>,<span style="color: #008b8b;">False</span>)
    <span style="color: #dbdb95;">down</span> = p.make1d(mins,maxs,mask)
    <span style="color: #dbdb95;">downerr</span> = np.sqrt(down)/np.<span style="color: #23d7d7;">sum</span>(mon.spec)
    <span style="color: #dbdb95;">down</span> /= np.<span style="color: #23d7d7;">sum</span>(mon.spec)

    <span style="color: #ffad29; font-weight: bold;">return</span> (up-down)/(up+down)
</pre>
</div>

<p>
The <code>errspectrum</code> function is similar to <code>spectrum</code>, except that it
also returns the uncertainty in the polarization.
</p>

<div class="org-src-container">

<pre class="src src-python" id="reduction_errspectrum"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">errspectrum</span>(run,name,mins=(0,0),maxs=(16,128),mask=<span style="color: #008b8b;">None</span>):
    <span style="color: #dbdb95;">name</span> = normalize_name(name)
    <span style="color: #dbdb95;">p</span> = PelFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"up_neutron_event.dat"</span>)
    <span style="color: #dbdb95;">mon</span> = MonFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"up_bmon_histo.dat"</span>,<span style="color: #008b8b;">False</span>)
    <span style="color: #dbdb95;">up</span> = p.make1d(mins,maxs,mask)
    <span style="color: #dbdb95;">uperr</span> = np.sqrt(up)/np.<span style="color: #23d7d7;">sum</span>(mon.spec)
    <span style="color: #dbdb95;">up</span> /= np.<span style="color: #23d7d7;">sum</span>(mon.spec)
    <span style="color: #dbdb95;">p</span> = PelFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"down_neutron_event.dat"</span>)
    <span style="color: #dbdb95;">mon</span> = MonFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"down_bmon_histo.dat"</span>,<span style="color: #008b8b;">False</span>)
    <span style="color: #dbdb95;">down</span> = p.make1d(mins,maxs,mask)
    <span style="color: #dbdb95;">downerr</span> = np.sqrt(down)/np.<span style="color: #23d7d7;">sum</span>(mon.spec)
    <span style="color: #dbdb95;">down</span> /= np.<span style="color: #23d7d7;">sum</span>(mon.spec)

    <span style="color: #dbdb95;">p</span> = (up-down)/(up+down)
    <span style="color: #dbdb95;">err</span> = p*np.sqrt((up-down)**-2+(up+down)**-2)*np.sqrt(uperr**2+downerr**2)
    <span style="color: #ffad29; font-weight: bold;">return</span> p,err
</pre>
</div>


<p>
Most of the plotting functions rely upon <code>getIntegratedSpectra</code> to get
the actual state counts for their results.  It returns the monitor
normalized intensity spectrums of the spin up and spin down states,
as well as the corresponding uncertainties.
</p>

<dl class="org-dl">
<dt> run </dt><dd>The run number for the folder containing the data
</dd>
<dt> name </dt><dd>Any additional infixed on the name of the run.  This is
mostly to handle sortby runs where we need to load a
specific power supply state.
</dd>
<dt> mins </dt><dd>The minimum x and y corrdinate on the detector to examine
</dd>
<dt> maxs </dt><dd>The maximum x and y corrdinate to examine
</dd>
<dt> mask </dt><dd>A bit mask for eliminating unwanted pixels.
</dd>
</dl>

<p>
In theory, the <code>spectrum</code> and <code>errspectrum</code> functions can be rewritten
as a quick wrappers around <code>getIntegratedSpectra</code>.  You should do
this.
</p>

<div class="org-src-container">

<pre class="src src-python" id="reduction_getIntegratedSpectra"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">getIntegratedSpectra</span>(run,name,mins,maxs,mask):
    <span style="color: #dbdb95;">name</span> = normalize_name(name)
    <span style="color: #dbdb95;">p</span> = PelFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"up_neutron_event.dat"</span>)
    <span style="color: #dbdb95;">mon</span> = MonFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"up_bmon_histo.dat"</span>,<span style="color: #008b8b;">False</span>)
    <span style="color: #dbdb95;">up</span> = np.<span style="color: #23d7d7;">sum</span>(p.make1d(mins,maxs,mask)[40:90])
    <span style="color: #dbdb95;">uperr</span> = np.sqrt(up)/np.<span style="color: #23d7d7;">sum</span>(mon.spec)
    <span style="color: #dbdb95;">up</span> /= np.<span style="color: #23d7d7;">sum</span>(mon.spec)
    <span style="color: #dbdb95;">p</span> = PelFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"down_neutron_event.dat"</span>)
    <span style="color: #dbdb95;">mon</span> = MonFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"down_bmon_histo.dat"</span>,<span style="color: #008b8b;">False</span>)
    <span style="color: #dbdb95;">down</span> = np.<span style="color: #23d7d7;">sum</span>(p.make1d(mins,maxs,mask)[40:90])
    <span style="color: #dbdb95;">downerr</span> = np.sqrt(down)/np.<span style="color: #23d7d7;">sum</span>(mon.spec)
    <span style="color: #dbdb95;">down</span> /= np.<span style="color: #23d7d7;">sum</span>(mon.spec)

    <span style="color: #ffad29; font-weight: bold;">return</span> (up,uperr,down,downerr)
</pre>
</div>

<p>
The <code>reduction_fr</code> function is a thin wrapper around the
getIntegratedSpectra function to provide the flipping ratio versus
wavelength for a given run.
</p>

<div class="org-src-container">

<pre class="src src-python" id="reduction_fr"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">fr</span>(run,name,mins=(0,0),maxs=(16,128),mask=<span style="color: #008b8b;">None</span>):
    <span style="color: #dbdb95;">up</span>,<span style="color: #dbdb95;">uperr</span>,<span style="color: #dbdb95;">down</span>,<span style="color: #dbdb95;">downerr</span> = getIntegratedSpectra(run,name,mins,maxs,mask)

    <span style="color: #dbdb95;">ratio</span> = up/down
    <span style="color: #dbdb95;">rerr</span> = ratio * np.sqrt((uperr/up)**2+(downerr/down)**2)

    <span style="color: #ffad29; font-weight: bold;">return</span> (ratio,rerr)
</pre>
</div>

<p>
Similarly, <code>reduction_run_int</code> gives the total neutron intensity
between the spin up and spin down states.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">run_int</span>(run,name,mins=(0,0),maxs=(16,128),mask=<span style="color: #008b8b;">None</span>):
    <span style="color: #dbdb95;">up</span>,<span style="color: #dbdb95;">uperr</span>,<span style="color: #dbdb95;">down</span>,<span style="color: #dbdb95;">downerr</span> = getIntegratedSpectra(run,name,mins,maxs,mask)

    <span style="color: #dbdb95;">total</span> = up+down
    <span style="color: #dbdb95;">total_err</span> = np.sqrt(uperr**2+downerr**2)

    <span style="color: #ffad29; font-weight: bold;">return</span> (total,total_err)
</pre>
</div>


<p>
The <code>simple_spectrum</code> routine is similar to <code>getIntegrateSpectra</code>,
but it only loads a single subrun based on the run number.  It's
largest advantage is that the data does not need to be exported for
it to be used.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">simple_spectrum</span>(run,mins=(0,0),maxs=(16,128),mask=<span style="color: #008b8b;">None</span>):
    <span style="color: #dbdb95;">p</span> = PelFile(basedir+<span style="color: #e67128;">"SESAME_%i/SESAME_%i_neutron_event.dat"</span>%(run,run))    
    <span style="color: #dbdb95;">mon</span> = MonFile(basedir+<span style="color: #e67128;">"SESAME_%i/SESAME_%i_bmon_histo.dat"</span>%(run,run),<span style="color: #008b8b;">False</span>)    
    <span style="color: #dbdb95;">data</span> = p.make1d(mins,maxs,mask)
    <span style="color: #dbdb95;">err</span> = np.sqrt(data)/np.<span style="color: #23d7d7;">sum</span>(mon.spec)
    <span style="color: #dbdb95;">data</span> /= np.<span style="color: #23d7d7;">sum</span>(mon.spec)

    <span style="color: #ffad29; font-weight: bold;">return</span> (data,err)
</pre>
</div>



<p>
Some plots depend more on the 2d detector image and less on the
wavelength spectrum.  The <code>get_2d_int</code> function returns a monitor
normalized 2d array representing the neutron intensity per pixel.
</p>

<dl class="org-dl">
<dt> run </dt><dd>The run number for the directory where the flipping run data
has been exported
</dd>
<dt> name </dt><dd>The name of the data file.  This can theoretically allow
this function to be used to load the results of a sortby
operation, but, in practice, it's only ever used for just
up and down spin states.
</dd>
</dl>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">get_2d_int</span>(run,name):
    <span style="color: #dbdb95;">p</span> = PelFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"_neutron_event.dat"</span>)
    <span style="color: #dbdb95;">mon</span> = MonFile(basedir+<span style="color: #e67128;">"SESAME_%i/"</span> % run + name+<span style="color: #e67128;">"_bmon_histo.dat"</span>,<span style="color: #008b8b;">False</span>)
    <span style="color: #ffad29; font-weight: bold;">return</span> np.<span style="color: #23d7d7;">sum</span>(p.make3d(),axis=2) / np.<span style="color: #23d7d7;">sum</span>(mon.spec)
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5-5" class="outline-3">
<h3 id="sec-5-5"><span class="section-number-3">5.5</span> Plotting</h3>
<div class="outline-text-3" id="text-5-5">
<p>
The single plot command takes a single data file and plots it to the
screen.
</p>

<dl class="org-dl">
<dt> run </dt><dd>The run number of the directory where the file is stored.
</dd>
<dt> name </dt><dd>The file name for the data file to be plotted.
</dd>
<dt> mins </dt><dd>The upper left pixel of the region of interest on the detector.
</dd>
<dt> maxs </dt><dd>The lower right pixel of the region of interest on the detector.
</dd>
</dl>

<div class="org-src-container">

<pre class="src src-python" id="reduction_singleplot"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">singleplot</span>(run,name,mins=(0,0),maxs=(16,128)):
    <span style="color: #dbdb95;">data</span> = spectrum(run,name,mins,maxs)
    <span style="color: #dbdb95;">data</span>[np.isnan(data)]=0
    plt.plot(np.arange(RESOLUTION)*20.0/RESOLUTION,data,<span style="color: #e67128;">"r-"</span>)
    plt.show()
</pre>
</div>

<p>
<code>echofr</code> takes a list of runs generated by a <code>sortby</code> and plots the
flipping ratio, integrated over all wavelengths, versus the current
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">echofr</span>(run,names,mins=(0,0),maxs=(16,128),mask=<span style="color: #008b8b;">None</span>,outfile=<span style="color: #008b8b;">None</span>):
<span style="color: #74af68;">#    </span><span style="color: #74af68;">names = [name for name in names if float(name) != 5.475]</span>
    <span style="color: #ffad29; font-weight: bold;">print</span> names
    <span style="color: #dbdb95;">data</span> = [fr(run,name,mins,maxs,mask) <span style="color: #ffad29; font-weight: bold;">for</span> name <span style="color: #ffad29; font-weight: bold;">in</span> names]
    <span style="color: #dbdb95;">errs</span> = np.array([x[1] <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> data])
    <span style="color: #dbdb95;">data</span> = np.array([x[0] <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> data])
    <span style="color: #dbdb95;">data</span>[np.isnan(data)]=0
    <span style="color: #dbdb95;">errs</span>[np.isnan(data)]=1
    <span style="color: #dbdb95;">xs</span> = np.array([<span style="color: #23d7d7;">float</span>(x) <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> names])
    <span style="color: #ffad29; font-weight: bold;">print</span> xs
    plt.errorbar(xs,data,yerr=errs)
<span style="color: #74af68;">#    </span><span style="color: #74af68;">if outfile is None:</span>
    plt.show()
    <span style="color: #ffad29; font-weight: bold;">if</span> outfile <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
        np.savetxt(outfile,np.transpose(np.vstack((xs,data,errs))))
    <span style="color: #74af68;">#</span><span style="color: #74af68;">trying the fitting</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">data = (data-1.0)/(data+1.0)</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">print(data)</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">data = np.log(data)</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">fit = np.polyfit(xs,data,2)</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">a = fit[0]</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">b = fit[1]</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">c = fit[2]</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">print(fit)</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">plt.plot(xs,np.exp(data),"b*")</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">plt.plot(xs,np.exp(c+b*xs+a*xs**2),"r-")</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">plt.show()</span>
    <span style="color: #74af68;"># </span><span style="color: #74af68;">print(-1*b/(2*a))</span>
</pre>
</div>

<p>
<code>echodiff</code> is useful for finding position sensitive differences in the
echo polarization.  It plots a color plot versus both tuning current
and wavelength.  The intensity in the plot is based on the difference
in neutron precession angle, in radians, between the top and bottom of
the detector.  The <code>split</code> variable is used to declare the dividing
line between the "top" and the "botto".
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">echodiff</span>(run,names,split,mins,maxs,outfile=<span style="color: #008b8b;">None</span>):
    <span style="color: #dbdb95;">data</span> = np.vstack(<span style="color: #23d7d7;">tuple</span>([np.arccos(spectrum(run,name,mins,(split,302))) - 
                            np.arccos(spectrum(run,name,(split,223),maxs)) <span style="color: #ffad29; font-weight: bold;">for</span> name <span style="color: #ffad29; font-weight: bold;">in</span> names]))

    <span style="color: #dbdb95;">data</span>[np.isnan(data)]=0

    <span style="color: #dbdb95;">xs</span> = np.arange(RESOLUTION)*20.0/RESOLUTION
    <span style="color: #dbdb95;">ys</span> = np.array([<span style="color: #23d7d7;">float</span>(x) <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> names])
    plt.pcolor(xs,ys,data,vmin=-np.pi,vmax=np.pi)
    <span style="color: #ffad29; font-weight: bold;">if</span> outfile <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
        plt.show()
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #ffad29; font-weight: bold;">print</span> name
        plt.savefig(outfile)
        plt.clf()
</pre>
</div>

<p>
The <code>echoplot</code> is a full spectrum color plot of the echo tune.  The
axes are wavelength and tuning current and the color represents the
polarization.  This is slower <code>echofr</code> and harder to read.  However,
it does have the advantage that it's possible to distinguish between a
deploarized beam and a beam which is far from echo.  It's also
possible to to tell whether a given peak is on echo or just near it.
<code>echoplot</code> also can show if there are problems out at long
wavelengths, which would be masked by the high counts at short
wavelength in <code>echofr</code>.  Finally, it's much prettier than <code>echofr</code>.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">echoplot</span>(run,names,mins=(0,0),maxs=(16,128),mask=<span style="color: #008b8b;">None</span>,outfile=<span style="color: #008b8b;">None</span>):
    <span style="color: #dbdb95;">data</span> = [errspectrum(run,name,mins,maxs,mask) <span style="color: #ffad29; font-weight: bold;">for</span> name <span style="color: #ffad29; font-weight: bold;">in</span> names]
    <span style="color: #dbdb95;">errs</span> = np.vstack(<span style="color: #23d7d7;">tuple</span>([d[1] <span style="color: #ffad29; font-weight: bold;">for</span> d <span style="color: #ffad29; font-weight: bold;">in</span> data]))
    <span style="color: #dbdb95;">data</span> = np.vstack(<span style="color: #23d7d7;">tuple</span>([d[0] <span style="color: #ffad29; font-weight: bold;">for</span> d <span style="color: #ffad29; font-weight: bold;">in</span> data]))
    <span style="color: #dbdb95;">data</span>[np.isnan(data)]=0
    <span style="color: #dbdb95;">xs</span> = np.arange(101)*0.1
    <span style="color: #dbdb95;">ys</span> = <span style="color: #23d7d7;">sorted</span>([<span style="color: #23d7d7;">float</span>(x) <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> names])
    <span style="color: #dbdb95;">ys</span> += [ys[-1]+ys[1]-ys[0]] <span style="color: #74af68;">#</span><span style="color: #74af68;">Add last element</span>
    <span style="color: #dbdb95;">ys</span> = np.array(ys)
    plt.pcolor(xs,ys,data,vmin=-1,vmax=1)
    <span style="color: #ffad29; font-weight: bold;">if</span> outfile <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
        plt.show()
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #ffad29; font-weight: bold;">print</span> name
        <span style="color: #ffad29; font-weight: bold;">if</span> outfile[-4:] == <span style="color: #e67128;">".png"</span>:
            plt.savefig(outfile)
            plt.clf()
        <span style="color: #ffad29; font-weight: bold;">else</span>:
            <span style="color: #ffad29; font-weight: bold;">with</span> <span style="color: #23d7d7;">open</span>(outfile,<span style="color: #e67128;">"w"</span>) <span style="color: #ffad29; font-weight: bold;">as</span> of:
                <span style="color: #dbdb95;">y</span>,x = data.shape
                of.write(<span style="color: #e67128;">"wavelength\tcurrent\tpolarization\terror\n"</span>)
                <span style="color: #ffad29; font-weight: bold;">for</span> i <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(x):
                    <span style="color: #ffad29; font-weight: bold;">for</span> j <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(y):
                        <span style="color: #ffad29; font-weight: bold;">print</span>((xs[i],ys[j]))
                        <span style="color: #ffad29; font-weight: bold;">print</span>(data[j,i])
                        of.write(<span style="color: #e67128;">"%f\t%f\t%f\t%f\n"</span>
                                 %(xs[i],ys[j],data[j,i],errs[j,i]))
</pre>
</div>

<p>
The <code>intensity</code> plot gives the detector count, with uncertainty,
versus current.  It doesn't come in handy very often.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">intensity</span>(run,names,mins=(0,0),maxs=(16,128),mask=<span style="color: #008b8b;">None</span>,outfile=<span style="color: #008b8b;">None</span>):
    <span style="color: #dbdb95;">names</span> = [name <span style="color: #ffad29; font-weight: bold;">for</span> name <span style="color: #ffad29; font-weight: bold;">in</span> names <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">float</span>(name) != 5.475]
    <span style="color: #dbdb95;">data</span> = [run_int(run,name,mins,maxs,mask) <span style="color: #ffad29; font-weight: bold;">for</span> name <span style="color: #ffad29; font-weight: bold;">in</span> names]
    <span style="color: #dbdb95;">errs</span> = np.array([x[1] <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> data])
    <span style="color: #dbdb95;">data</span> = np.array([x[0] <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> data])
    <span style="color: #dbdb95;">data</span>[np.isnan(data)]=0
    <span style="color: #dbdb95;">errs</span>[np.isnan(data)]=1
    <span style="color: #dbdb95;">xs</span> = np.array([<span style="color: #23d7d7;">float</span>(x) <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> names])
    plt.errorbar(xs,data,yerr=errs)
<span style="color: #74af68;">#    </span><span style="color: #74af68;">if outfile is None:</span>
    plt.show()
    <span style="color: #ffad29; font-weight: bold;">if</span> outfile <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
        np.savetxt(outfile,np.transpose(np.vstack((xs,data,errs))))
</pre>
</div>

<p>
The <code>poldrift</code> function plots the polarization versus run number.
This functionality has laregely been supplanted by <i>beamdeath</i>, which
makes runs far faster, though it does not produce errorbars.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">poldrift</span>(runs,mins,maxs,outfile=<span style="color: #008b8b;">None</span>):
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">len</span>(runs)%2 == 1:
        runs = runs[:-1]
    ups = [simple_spectrum(run,mins,maxs)
                           <span style="color: #ffad29; font-weight: bold;">for</span> run <span style="color: #ffad29; font-weight: bold;">in</span> runs[1::2]]
    downs = [simple_spectrum(run,mins,maxs)
                           <span style="color: #ffad29; font-weight: bold;">for</span> run <span style="color: #ffad29; font-weight: bold;">in</span> runs[0::2]]
    uperrs = np.array([np.sqrt(np.<span style="color: #23d7d7;">sum</span>(run[1]**2)) <span style="color: #ffad29; font-weight: bold;">for</span> run <span style="color: #ffad29; font-weight: bold;">in</span> ups])
    downerrs = np.array([np.sqrt(np.<span style="color: #23d7d7;">sum</span>(run[1]**2)) <span style="color: #ffad29; font-weight: bold;">for</span> run <span style="color: #ffad29; font-weight: bold;">in</span> downs])
    ups = np.array([np.<span style="color: #23d7d7;">sum</span>(run[0]) <span style="color: #ffad29; font-weight: bold;">for</span> run <span style="color: #ffad29; font-weight: bold;">in</span> ups])
    downs = np.array([np.<span style="color: #23d7d7;">sum</span>(run[0]) <span style="color: #ffad29; font-weight: bold;">for</span> run <span style="color: #ffad29; font-weight: bold;">in</span> downs])
    p = ups/downs
    err = p * np.sqrt((uperrs/ups)**2+(downerrs/downs)**2)
    xs = np.array(runs[0::2])
    plt.errorbar(xs,p,yerr=err)
    plt.show()
    <span style="color: #ffad29; font-weight: bold;">if</span> outfile <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #ffad29; font-weight: bold;">not</span> <span style="color: #008b8b;">None</span>:
        np.savetxt(outfile,np.transpose(np.vstack((xs,p,err))))
</pre>
</div>

<p>
The <code>plot_2d_range</code> plot takes in a 3D data set of any sort.  It then
finds creates a scatter plot.  The x axis of the scatter plot is a
given pixel value.  The y axis is the number of pixel whose value is
less than the x-coordinate.  Think of it like a cummulative histogram
of the data.
</p>

<p>
The optional <code>rnge</code> variable gives the domain of the x-axis.  If no
domain is given, it runs over the full pixel value range of the given
data.  The <code>steps</code> parameter can be used to chose the resolution of
the plot along the x-axis.  Finally, <code>mask</code> can be used to pass a
binary mask of pixels to ignore.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">plot_2d_range</span>(data,rnge=<span style="color: #008b8b;">None</span>,steps=100,mask=<span style="color: #008b8b;">None</span>):
    <span style="color: #e67128;">"""Takes a 2d data set and plots a plateau plot"""</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">type</span>(rnge) <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #23d7d7;">tuple</span>:
        <span style="color: #dbdb95;">vmin</span>,<span style="color: #dbdb95;">vmax</span>=rnge
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #dbdb95;">vmin</span> = np.<span style="color: #23d7d7;">min</span>(data)
        <span style="color: #dbdb95;">vmax</span> = np.<span style="color: #23d7d7;">max</span>(data)
    <span style="color: #ffad29; font-weight: bold;">if</span> mask <span style="color: #ffad29; font-weight: bold;">is</span> <span style="color: #008b8b;">None</span>:
        <span style="color: #dbdb95;">mask</span> = data &gt;= vmin
    <span style="color: #ffad29; font-weight: bold;">print</span>(vmax,vmin,steps)
    <span style="color: #ffad29; font-weight: bold;">print</span>((vmax-vmin))
    <span style="color: #ffad29; font-weight: bold;">print</span>((vmax-vmin)/steps)
    <span style="color: #dbdb95;">xs</span> = np.arange(vmin,vmax,(vmax-vmin)/steps)
    <span style="color: #dbdb95;">ys</span> = [<span style="color: #23d7d7;">len</span>(np.where(np.logical_and(data&lt;x,mask))[0]) <span style="color: #ffad29; font-weight: bold;">for</span> x <span style="color: #ffad29; font-weight: bold;">in</span> xs]
    <span style="color: #dbdb95;">ys</span> = np.array(ys)
    plt.plot(xs,ys,<span style="color: #e67128;">"r*"</span>)
    plt.show()
</pre>
</div>

<p>
The <code>plot_int_range</code> takes a single run number and plots a cumulative
histogram of the wavelength integrate intensity of the pixels.  The
x-axis is the minimum pixel intensity and the y axis is how many
pixels meat that minimum.  The function examines both spin states for
the run and it is assumed that reduction has already exported the up
and down run files for that run.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">plot_int_range</span>(run):
    <span style="color: #dbdb95;">up</span> = get_2d_int(run,<span style="color: #e67128;">"up"</span>)
    <span style="color: #dbdb95;">down</span> = get_2d_int(run,<span style="color: #e67128;">"down"</span>)
    plot_2d_range(up+down,steps=1000)
</pre>
</div>

<p>
The <code>plot_pol_range</code> function is similar to <code>plot_int_range</code>, except
that it examines the polarization at each pixel, instead of the total intensity.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">plot_pol_range</span>(run,mask=<span style="color: #008b8b;">None</span>):
    <span style="color: #dbdb95;">up</span> = get_2d_int(run,<span style="color: #e67128;">"down"</span>)
    <span style="color: #dbdb95;">down</span> = get_2d_int(run,<span style="color: #e67128;">"up"</span>)
    plot_2d_range((up-down)/(up+down),(-1.0,1.0),mask=mask)
</pre>
</div>


<p>
<code>normalize_name</code> takes either a number or an empty string.  If it
takes an empty string, it returns the same.  If it gets a number, it
returns a string with that number out to three places after the
decimal.  This is useful for naming runs, since we don't always want
to append a current value to the file name.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">normalize_name</span>(name):
    <span style="color: #ffad29; font-weight: bold;">if</span> name != <span style="color: #e67128;">''</span>:
        <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #e67128;">"%0.3f"</span>%<span style="color: #23d7d7;">float</span>(name)
    <span style="color: #ffad29; font-weight: bold;">else</span>:
        <span style="color: #ffad29; font-weight: bold;">return</span> name
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Power Supplies</h2>
<div class="outline-text-2" id="text-6">
<p>
The power supplies are currently controlled via an DAC card on the
motor computer.  This card sends an analog voltage between -10 V and
10 V to each power supply, which is then used to control the
current.
</p>

<p>
To run the power supplies, the <code>ps_server.py</code> program must be run on
the Motor computer and the <code>Coils</code> class needs to be loaded into
PyDAS.  The <code>sesame_init.py</code> script currently loads the power supply
client into the variable <code>coils</code>.
</p>
</div>

<div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> Power Supply Server</h3>
<div class="outline-text-3" id="text-6-1">
</div><div id="outline-container-sec-6-1-1" class="outline-4">
<h4 id="sec-6-1-1"><span class="section-number-4">6.1.1</span> Power Supply Class Module</h4>
<div class="outline-text-4" id="text-6-1-1">
</div><ol class="org-ol"><li>Module Skeleton<br  /><div class="outline-text-5" id="text-6-1-1-1">
<div class="org-src-container">

<pre class="src src-python" id="power_supply_skeleton"><span style="color: #ffad29; font-weight: bold;">import</span> __future__
<span style="color: #ffad29; font-weight: bold;">import</span> ctypes
<span style="color: #ffad29; font-weight: bold;">import</span> numpy
<span style="color: #ffad29; font-weight: bold;">import</span> struct
<span style="color: #ffad29; font-weight: bold;">import</span> json

&lt;&lt;power_supply_constants&gt;&gt;
&lt;&lt;power_supply_compensate&gt;&gt;
<span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">PowerSupply</span>:

    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
        &lt;&lt;power_supply_init&gt;&gt;
    &lt;&lt;power_supply_set&gt;&gt;

    &lt;&lt;power_supply_triangle&gt;&gt;
    &lt;&lt;power_supply_fields&gt;&gt;
    &lt;&lt;power_supply_chk&gt;&gt;
    &lt;&lt;power_supply_stop&gt;&gt;
    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__del__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
        <span style="color: #ffad29; font-weight: bold;">self</span>.stop()



<span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">__name__</span>==<span style="color: #e67128;">"__main__"</span>:
    x=PowerSupply()
</pre>
</div>
</div>
</li>

<li>Constants<br  /><div class="outline-text-5" id="text-6-1-1-2">
<p>
The nidaq object is a link to the DLL file which contains National
Instrument DAQmx interface to their hardware.  It may not be quite as
friendly as something like Measurement Studio, but it's actually a nice
and simple API and it gets the job done.  All of the functions in the
<a href="file://C:/Program Files/National Instruments/NI-DAQ/docs/daqmxcfunc.chm">NI-DAQmx C Reference Help</a> are available from this DLL.  This help
reference is installed with the drivers and you should update the link
to where it is install on your computer.
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_constants"><span style="color: #dbdb95;">nidaq</span> = ctypes.windll.nicaiu <span style="color: #74af68;">#</span><span style="color: #74af68;">Link to nicaiu.dll</span>
</pre>
</div>

<p>
Since DAQmx is a C api, we do need to care about the size of our data
types.  The <a href="https://docs.python.org/2/library/ctypes.html">python ctypes</a> module can handle most of these conversions
for us.  I've included some simple names to both help keeping track of
bit size and to simplify the code.
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_constants"><span style="color: #dbdb95;">int32</span> = ctypes.c_long
<span style="color: #dbdb95;">uInt32</span> = ctypes.c_ulong
<span style="color: #dbdb95;">uInt64</span> = ctypes.c_ulonglong
<span style="color: #dbdb95;">float64</span> = ctypes.c_double
<span style="color: #dbdb95;">TaskHandle</span> = uInt32
</pre>
</div>

<p>
The following constants are from the C header files for DAQmx.  
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_constants"><span style="color: #dbdb95;">DAQmx_Val_Cfg_Default</span> = int32(-1)
<span style="color: #dbdb95;">DAQmx_Val_Volts</span> = 10348
<span style="color: #dbdb95;">DAQmx_Val_Rising</span> = 10280
<span style="color: #dbdb95;">DAQmx_Val_FiniteSamps</span> = 10178
<span style="color: #dbdb95;">DAQmx_Val_ContSamps</span> = 10123
<span style="color: #dbdb95;">DAQmx_Val_GroupByChannel</span> = 0
</pre>
</div>

<p>
The triangles array is no longer used and should be removed
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_constants"><span style="color: #74af68;">#</span><span style="color: #74af68;">List of which tasks control the triangles</span>
<span style="color: #dbdb95;">triangles</span> = [<span style="color: #e67128;">"Triangle1"</span>,
             <span style="color: #e67128;">"Triangle2"</span>,
             <span style="color: #e67128;">"Triangle3"</span>,
             <span style="color: #e67128;">"Triangle4"</span>,
             <span style="color: #e67128;">"Triangle5"</span>,
             <span style="color: #e67128;">"Triangle6"</span>,
             <span style="color: #e67128;">"Triangle7"</span>,
             <span style="color: #e67128;">"Triangle8"</span>]
</pre>
</div>

<p>
The <code>supplies</code> maps between the power supply names and the DAQmx
channels that we intend to control.  
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_constants"><span style="color: #74af68;">#</span><span style="color: #74af68;">Dictionary of tasks which contorl small supplies</span>
<span style="color: #dbdb95;">supplies</span> = {<span style="color: #e67128;">"flipper"</span>:<span style="color: #e67128;">"Flipper"</span>,
            <span style="color: #e67128;">"phase"</span>:<span style="color: #e67128;">"Phase"</span>,
            <span style="color: #e67128;">"guides"</span>:<span style="color: #e67128;">"Guides"</span>,
            <span style="color: #e67128;">"sample"</span>:<span style="color: #e67128;">"Sample"</span>}
</pre>
</div>

<p>
The <code>compensate</code> function is a simple helper to scale a current with a
slope <code>m</code> and y-intercept <code>b</code> given in a dictionary.  
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_compensate"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">compensate</span>(value,f):
    <span style="color: #ffad29; font-weight: bold;">return</span> value*f[<span style="color: #e67128;">'m'</span>]+f[<span style="color: #e67128;">'b'</span>]
</pre>
</div>
</div>
</li>

<li>Initialization<br  /><div class="outline-text-5" id="text-6-1-1-3">
<p>
We need to load the DAQmx task for each control channel for each power
supply.  The triangles are stored in a simple list, while other
supplies can be stored in a dictionary.
</p>

<p>
If you are looking for a good place to improve the program, this could
probably be turned into a single list corresponding to the power
supply number, which could then be access through a dictionary.  It's
the best of both worlds.
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_init"><span style="color: #ffad29; font-weight: bold;">self</span>.triangleHandles = []
<span style="color: #ffad29; font-weight: bold;">self</span>.supplyHandles = {}
</pre>
</div>

<p>
We also create a dictionary to store the current current in each power
supply.  As we don't have any read back function at the moment, this is
the best we can do.
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_init"><span style="color: #ffad29; font-weight: bold;">self</span>.values = {}
</pre>
</div>

<p>
We now load the DAQmx task for each hardware channel for each power
supply.  The tasks are referenced by a TaskHandle, which we pass as a
pointer to the <code>LoadTask</code> function.  Note that, since we're working
with pointers, we need to create a new task handle object each time.
Otherwise, it'll always be the same pointer to the same object and
each cycle through the loop will overwrite all of the previous values.
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_init"><span style="color: #ffad29; font-weight: bold;">for</span> t <span style="color: #ffad29; font-weight: bold;">in</span> triangles:
    <span style="color: #dbdb95;">taskHandle</span> = TaskHandle(0)
    <span style="color: #ffad29; font-weight: bold;">print</span> t
    <span style="color: #ffad29; font-weight: bold;">self</span>.CHK(nidaq.DAQmxLoadTask(t,
                      ctypes.byref( taskHandle )))
    <span style="color: #ffad29; font-weight: bold;">self</span>.triangleHandles.append(taskHandle)
    <span style="color: #ffad29; font-weight: bold;">self</span>.triangle
</pre>
</div>

<p>
We perform a similar operation for the non-triangle supplies, with
task handles being reference by name in a dictionary, instead of an
index on a list.
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_init"><span style="color: #ffad29; font-weight: bold;">for</span> (k,v) <span style="color: #ffad29; font-weight: bold;">in</span> supplies.items():
    <span style="color: #dbdb95;">taskHandle</span> = TaskHandle(0)
    <span style="color: #ffad29; font-weight: bold;">self</span>.CHK(nidaq.DAQmxLoadTask(v,
                      ctypes.byref( taskHandle )))
    <span style="color: #ffad29; font-weight: bold;">self</span>.supplyHandles[k] = taskHandle

<span style="color: #ffad29; font-weight: bold;">print</span> <span style="color: #ffad29; font-weight: bold;">self</span>.supplyHandles
</pre>
</div>

<p>
The relationship between DAC voltage and power supply current is
stored in a <a href="http://json.org">JSON</a> file.  The file should contain an object with one
member for each power supply.  That member should have two members of
its own, representing the slope <code>m</code> and intercept <code>b</code>.
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_init"><span style="color: #ffad29; font-weight: bold;">with</span> <span style="color: #23d7d7;">open</span>(<span style="color: #e67128;">"calibration.json"</span>) <span style="color: #ffad29; font-weight: bold;">as</span> configFile:
    <span style="color: #ffad29; font-weight: bold;">self</span>.calibration = json.load(configFile)
</pre>
</div>

<p>
Finally, we see all of the power supply currents to zero to start.
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_init"><span style="color: #ffad29; font-weight: bold;">self</span>.values[<span style="color: #e67128;">'triangles'</span>] = [0]*8
<span style="color: #ffad29; font-weight: bold;">for</span> i <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(1,9):
    <span style="color: #ffad29; font-weight: bold;">self</span>.triangle(i,0)
<span style="color: #ffad29; font-weight: bold;">self</span>.flipper(0)
<span style="color: #ffad29; font-weight: bold;">self</span>.guides(0)
<span style="color: #ffad29; font-weight: bold;">self</span>.phase(0)
<span style="color: #ffad29; font-weight: bold;">self</span>.sample(0)
</pre>
</div>
</div>
</li>

<li>Low Level Control<br  /><div class="outline-text-5" id="text-6-1-1-4">
<p>
The set function takes a task handle and a voltage value and tell
that task to output the given voltage
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_set"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">set</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,task,x):
    <span style="color: #e67128;">"""Takes a task handle and a current and sets that task to that current."""</span>
    <span style="color: #ffad29; font-weight: bold;">self</span>.CHK(nidaq.DAQmxWriteAnalogScalarF64( task,
                                              <span style="color: #008b8b;">True</span>,
                                              float64(1.0),
                                              float64(x), <span style="color: #74af68;">#</span><span style="color: #74af68;">Voltage</span>
                                              <span style="color: #008b8b;">None</span>))
</pre>
</div>

<p>
Since we're using the C interface to DAQmx, we don't have the benefit
of such linguistic niceties as exceptions.  Instead, each function
call returns an error code.  An error of zero indicates that the
function returned properly.  A positive error code indicates that a
warning was generated.  A negative error code indicates that the
function failed.  The <code>CHK</code> function reads the error code and, if a
warning or error was triggered, it raises an exception with a
description of the problem.
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_chk"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">CHK</span>( <span style="color: #ffad29; font-weight: bold;">self</span>, err ):
    <span style="color: #e67128;">"""a simple error checking routine"""</span>
    <span style="color: #ffad29; font-weight: bold;">if</span> err &lt; 0:
        <span style="color: #dbdb95;">buf_size</span> = 100
        <span style="color: #dbdb95;">buf</span> = ctypes.create_string_buffer(<span style="color: #e67128;">'\000'</span> * buf_size)
        nidaq.DAQmxGetErrorString(err,ctypes.byref(buf),buf_size)
        <span style="color: #ffad29; font-weight: bold;">raise</span> <span style="color: #34cae2;">RuntimeError</span>(<span style="color: #e67128;">'nidaq call failed with error %d: %s'</span>%(err,<span style="color: #23d7d7;">repr</span>(buf.value)))
    <span style="color: #ffad29; font-weight: bold;">if</span> err &gt; 0:
        <span style="color: #dbdb95;">buf_size</span> = 100
        <span style="color: #dbdb95;">buf</span> = ctypes.create_string_buffer(<span style="color: #e67128;">'\000'</span> * buf_size)
        nidaq.DAQmxGetErrorString(err,ctypes.byref(buf),buf_size)
        <span style="color: #ffad29; font-weight: bold;">raise</span> <span style="color: #34cae2;">RuntimeError</span>(<span style="color: #e67128;">'nidaq generated warning %d: %s'</span>%(err,<span style="color: #23d7d7;">repr</span>(buf.value)))
</pre>
</div>

<p>
The shop function ends all of the tasks and clears the task handles.
This is necessary to allow another application to access the tasks
afterward.  This function is also called by the destructor of the
class to handle the cleanup.
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_stop"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">stop</span>( <span style="color: #ffad29; font-weight: bold;">self</span> ):
    <span style="color: #ffad29; font-weight: bold;">for</span> task <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #ffad29; font-weight: bold;">self</span>.triangleHandles:
        <span style="color: #ffad29; font-weight: bold;">self</span>.<span style="color: #23d7d7;">set</span>(task,0)
        nidaq.DAQmxStopTask( task )
        nidaq.DAQmxClearTask( task )
    <span style="color: #ffad29; font-weight: bold;">for</span> task <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #ffad29; font-weight: bold;">self</span>.supplyHandles:
        <span style="color: #ffad29; font-weight: bold;">self</span>.<span style="color: #23d7d7;">set</span>(task,0)
        nidaq.DAQmxStopTask( task )
        nidaq.DAQmxClearTask( task )
</pre>
</div>
</div>
</li>

<li>High Level Control<br  /><div class="outline-text-5" id="text-6-1-1-5">
<p>
The currents through the triangles are set via the <code>triangle</code>
function.  The current current is returned via the <code>getTriangle</code>
function.  Each function takes a <code>tri</code> prarameter, which is the number
of the triangle supply from 1 to 8.  We do a little arithmetic to
account for the fact that the list index ranges from 0 to 7.
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_triangle"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">triangle</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,tri,curr):
    <span style="color: #ffad29; font-weight: bold;">self</span>.<span style="color: #23d7d7;">set</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.triangleHandles[tri-1],
             compensate(curr,<span style="color: #ffad29; font-weight: bold;">self</span>.calibration[<span style="color: #e67128;">'tri'</span>+<span style="color: #23d7d7;">str</span>(tri)]))
    <span style="color: #ffad29; font-weight: bold;">self</span>.values[<span style="color: #e67128;">'triangles'</span>][tri-1]=curr
    <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #ffad29; font-weight: bold;">self</span>.getTriangle(tri)

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">getTriangle</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,tri):
    <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #ffad29; font-weight: bold;">self</span>.values[<span style="color: #e67128;">'triangles'</span>][tri-1]
</pre>
</div>

<p>
There is almost identical code for the other power supplies.  There
should be a way to eliminate this boilerplate code.
</p>

<div class="org-src-container">

<pre class="src src-python" id="power_supply_fields"><span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">flipper</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,curr):
    <span style="color: #ffad29; font-weight: bold;">self</span>.<span style="color: #23d7d7;">set</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.supplyHandles[<span style="color: #e67128;">"flipper"</span>],
             compensate(curr,<span style="color: #ffad29; font-weight: bold;">self</span>.calibration[<span style="color: #e67128;">'flipper'</span>]))
    <span style="color: #ffad29; font-weight: bold;">self</span>.values[<span style="color: #e67128;">'flipper'</span>]=curr
    <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #ffad29; font-weight: bold;">self</span>.getFlipper()
<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">getFlipper</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #ffad29; font-weight: bold;">self</span>.values[<span style="color: #e67128;">'flipper'</span>]

<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">guides</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,curr):
    <span style="color: #ffad29; font-weight: bold;">self</span>.<span style="color: #23d7d7;">set</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.supplyHandles[<span style="color: #e67128;">"guides"</span>],
             compensate(curr,<span style="color: #ffad29; font-weight: bold;">self</span>.calibration[<span style="color: #e67128;">'guides'</span>]))
    <span style="color: #ffad29; font-weight: bold;">self</span>.values[<span style="color: #e67128;">'guides'</span>]=curr
    <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #ffad29; font-weight: bold;">self</span>.getGuides()
<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">getGuides</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #ffad29; font-weight: bold;">self</span>.values[<span style="color: #e67128;">'guides'</span>]
<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">phase</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,curr):
    <span style="color: #ffad29; font-weight: bold;">self</span>.<span style="color: #23d7d7;">set</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.supplyHandles[<span style="color: #e67128;">"phase"</span>],
             compensate(curr,<span style="color: #ffad29; font-weight: bold;">self</span>.calibration[<span style="color: #e67128;">'phase'</span>]))
    <span style="color: #ffad29; font-weight: bold;">self</span>.values[<span style="color: #e67128;">'phase'</span>]=curr
    <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #ffad29; font-weight: bold;">self</span>.getPhase()
<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">getPhase</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #ffad29; font-weight: bold;">self</span>.values[<span style="color: #e67128;">'phase'</span>]
<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">sample</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,curr):
    <span style="color: #ffad29; font-weight: bold;">self</span>.<span style="color: #23d7d7;">set</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.supplyHandles[<span style="color: #e67128;">"sample"</span>],
             compensate(curr,<span style="color: #ffad29; font-weight: bold;">self</span>.calibration[<span style="color: #e67128;">'sample'</span>]))        
    <span style="color: #ffad29; font-weight: bold;">self</span>.values[<span style="color: #e67128;">'sample'</span>]=curr
    <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #ffad29; font-weight: bold;">self</span>.getSample()
<span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">getSample</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
    <span style="color: #ffad29; font-weight: bold;">return</span> <span style="color: #ffad29; font-weight: bold;">self</span>.values[<span style="color: #e67128;">'sample'</span>]
</pre>
</div>
</div>
</li></ol>
</div>

<div id="outline-container-sec-6-1-2" class="outline-4">
<h4 id="sec-6-1-2"><span class="section-number-4">6.1.2</span> Power Supply Server</h4>
<div class="outline-text-4" id="text-6-1-2">
<p>
The power supplies are controlled over the network by the program
<code>ps_server.py</code>.  We use an <a href="http://en.wikipedia.org/wiki/XML-RPC">XML-RPC</a> server to allow other computers to
call functions.  This server is attached to a single PowerSupply
object and allows us to call any of its member functions.  The actual
server parts of the code are conveniently supplied by the python
<a href="https://docs.python.org/2/library/simplexmlrpcserver.html">SimpleXMLRPCServer</a> class.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #ffad29; font-weight: bold;">from</span> ps <span style="color: #ffad29; font-weight: bold;">import</span> PowerSupply
<span style="color: #ffad29; font-weight: bold;">from</span> SimpleXMLRPCServer <span style="color: #ffad29; font-weight: bold;">import</span> SimpleXMLRPCServer
<span style="color: #ffad29; font-weight: bold;">from</span> SimpleXMLRPCServer <span style="color: #ffad29; font-weight: bold;">import</span> SimpleXMLRPCRequestHandler


<span style="color: #74af68;"># </span><span style="color: #74af68;">Restrict to a particular path.</span>
<span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">RequestHandler</span>(SimpleXMLRPCRequestHandler):
    <span style="color: #dbdb95;">rpc_paths</span> = (<span style="color: #e67128;">'/RPC2'</span>,)

<span style="color: #74af68;"># </span><span style="color: #74af68;">Create server</span>
<span style="color: #dbdb95;">server</span> = SimpleXMLRPCServer((<span style="color: #e67128;">"192.168.70.160"</span>, 7892),
                            requestHandler=RequestHandler)
server.register_introspection_functions()

server.register_instance(PowerSupply())

server.serve_forever()
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> Power Supply Client</h3>
<div class="outline-text-3" id="text-6-2">
<p>
The <code>Coils</code> module implements an XMLRPC client to go along with the
XMLRPC server we defined in the previous section.  By inheriting from
the <a href="https://docs.python.org/2/library/xmlrpclib.html">ServerProxy</a> class, we can treat the object produced as though it
were a PowerSupply object on the motor computer.
</p>

<p>
The only intialization parameter is <code>failmethod</code> which is a function
to call when the server is unreachable.  It can be used to send
e-mails, but it's currently not used, as we've turned off most of the
e-mail functionality in the move to PyDAS.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #e67128;">"""This module handles controlling the current through the solenoids</span>

<span style="color: #e67128;">This code was written to talk with a custom labview server on the</span>
<span style="color: #e67128;">current control computer.  Note that, currently, the server does</span>
<span style="color: #e67128;">not respond with the current currents.  When you first load the</span>
<span style="color: #e67128;">module, you should set all of the current values to synchronize</span>
<span style="color: #e67128;">with the server.</span>

<span style="color: #e67128;">"""</span>

<span style="color: #ffad29; font-weight: bold;">import</span> __future__
<span style="color: #ffad29; font-weight: bold;">import</span> xmlrpclib

<span style="color: #ffad29; font-weight: bold;">class</span> <span style="color: #34cae2;">Coils</span>(xmlrpclib.ServerProxy):
    <span style="color: #e67128;">"""This object manages the connection to the current control server"""</span>
<span style="color: #74af68;">#    </span><span style="color: #74af68;">HOST = "http://192.168.70.160"#IP address for the server</span>
    <span style="color: #dbdb95;">HOST</span> = <span style="color: #e67128;">"http://192.168.70.160"</span>
    <span style="color: #dbdb95;">PORT</span>=7892<span style="color: #74af68;">#</span><span style="color: #74af68;">port number for the server</span>

    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__init__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,failmethod):
        <span style="color: #e67128;">"""Creates the connection object"""</span>
        xmlrpclib.ServerProxy.__init__(<span style="color: #ffad29; font-weight: bold;">self</span>,<span style="color: #ffad29; font-weight: bold;">self</span>.HOST + <span style="color: #e67128;">":"</span> + <span style="color: #23d7d7;">str</span>(<span style="color: #ffad29; font-weight: bold;">self</span>.PORT) + <span style="color: #e67128;">"/RPC2"</span>)
        <span style="color: #ffad29; font-weight: bold;">self</span>.fail = failmethod
</pre>
</div>

<p>
There's a flip function hard coded into the object.  In practice, I'd
recommend against using it and it should probably be removed.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">flip</span>(<span style="color: #ffad29; font-weight: bold;">self</span>):
        <span style="color: #e67128;">"""Reverses the current through the flipping coil"""</span>
        <span style="color: #ffad29; font-weight: bold;">self</span>.proxy.flipper(-1*<span style="color: #ffad29; font-weight: bold;">self</span>.proxy.getFlipper())
</pre>
</div>

<p>
We've overloaded the <code>__getattr__</code> function to allow us to
automatically place the function in a wrapper that calls a function is
the method fails.  In practice, we're not using this right now and it
should also be removed.
</p>

<div class="org-src-container">

<pre class="src src-python"><span style="color: #74af68;">#</span>
    <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">__getattr__</span>(<span style="color: #ffad29; font-weight: bold;">self</span>,name):
        <span style="color: #dbdb95;">method</span> = xmlrpclib.ServerProxy.__getattr__(<span style="color: #ffad29; font-weight: bold;">self</span>,name)
        <span style="color: #ffad29; font-weight: bold;">def</span> <span style="color: #00ede1; font-weight: bold;">wrapped</span>(*args):
            <span style="color: #ffad29; font-weight: bold;">try</span>:
                <span style="color: #ffad29; font-weight: bold;">return</span> method.__call__(*args)
            <span style="color: #ffad29; font-weight: bold;">except</span> <span style="color: #34cae2;">Exception</span>, e:
                <span style="color: #ffad29; font-weight: bold;">self</span>.fail(<span style="color: #e67128;">"SESAME Power Supply Server Down"</span>,
                          <span style="color: #e67128;">"The SESAME beamline has lost its connection to the power supply server"</span>,
                          <span style="color: #e67128;">"Notthepassword"</span>)
                <span style="color: #ffad29; font-weight: bold;">print</span>(<span style="color: #e67128;">"Connection Failed"</span>)
                <span style="color: #ffad29; font-weight: bold;">print</span>(e)
                <span style="color: #ffad29; font-weight: bold;">raise</span> e
        <span style="color: #ffad29; font-weight: bold;">return</span> wrapped


<span style="color: #ffad29; font-weight: bold;">if</span> <span style="color: #23d7d7;">__name__</span>==<span style="color: #e67128;">"__main__"</span>:
    coils = Coils()
    <span style="color: #ffad29; font-weight: bold;">for</span> i <span style="color: #ffad29; font-weight: bold;">in</span> <span style="color: #23d7d7;">range</span>(1,5):
        coils.triangle(i,i*2-1)
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Adam Washington</p>
<p class="date">Created: 2014-04-21 Mon 16:15</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.5h)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
